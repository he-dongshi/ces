import{d as ne,u as se,r as b,w as oe,a as P,c as $,b as V,F as U,e as g,g as m,h as f,k as h,i as ie,j as re,s as de,M as ce,E as d,R as S,N as E,O as pe,A as ue,_ as fe}from"./index-BUVdxLJQ.js";import{C as N,g as me}from"./printProvider-D1gq-grw.js";const ye={class:"print-component"},ge={class:"print-dialog-content"},he={class:"template-select-section"},ve={class:"template-actions"},we={class:"dialog-footer"},be={class:"footer-left"},De={class:"footer-right"},ke={class:"share-preview-container"},Te={key:0,class:"image-preview"},_e=["src"],Ce={key:1,class:"loading-container"},Pe=ne({__name:"PrintComponent",props:{selectedData:{},pageType:{},visible:{type:Boolean,default:!0},isTextButton:{type:Boolean,default:!1},getDetailData:{},share:{type:Boolean,default:!1}},setup(q){const i=q,A=se(),v=b([]),p=b(""),R=b(!1),B=b(!1),x=b(!1),k=b(""),T=b(""),w=b(!1),H=b(!1);(async()=>{try{const e=await fetch("/print-lock.css");if(e.ok)T.value=await e.text();else try{const t=await fetch("./print-lock.css");t.ok&&(T.value=await t.text())}catch(t){console.warn("尝试备用路径加载print-lock.css失败:",t)}}catch(e){console.warn("加载print-lock.css失败:",e)}})();const I=async()=>{if(i.pageType)try{const e=await ue.list("template/template",{template_type:i.pageType,status:1,page:1,limit:999});if(e.data){v.value=e.data.data;const t=e.data.data.find(a=>a.is_default===1);t?p.value=t.id:e.data.data.length===1&&(p.value=e.data.data[0].id)}}catch(e){console.error("加载模板失败:",e),d.error("加载模板失败")}};oe(()=>i.pageType,async e=>{e&&await I()},{immediate:!0});const z=()=>{if(!i.selectedData||i.selectedData.length===0){d.warning("请选择要打印的数据");return}if(w.value=!0,!p.value&&v.value.length>0){const e=v.value.find(t=>t.is_default===1);e?p.value=e.id:v.value.length===1&&(p.value=v.value[0].id)}},W=()=>{w.value=!1},J=e=>{console.log("选择模板:",e)},K=async()=>{if(!p.value){d.warning("请选择打印模板");return}if(!i.selectedData||i.selectedData.length===0){d.warning("请选择要打印的数据");return}H.value=!0;try{const e=v.value.find(s=>s.id===p.value);if(!e){d.error("模板不存在");return}S.hiprint.init({providers:[new N(i.pageType)]});const t=JSON.parse(e.content),a=new S.hiprint.PrintTemplate({template:t,dataMode:1});let l=[];if(i.getDetailData){d.info("正在获取详情数据...");const s=i.selectedData.map(n=>i.getDetailData(n.id));l=(await Promise.all(s)).map(n=>_(n))}else l=i.selectedData.map(s=>_(s));const o=`${e.title||"打印"}_${new Date().getTime()}`;a.toPdf(l,o),d.success("PDF生成成功")}catch(e){console.error("下载PDF失败:",e),d.error("下载PDF失败")}finally{H.value=!1}},Y=async()=>{if(!p.value){d.warning("请选择打印模板");return}if(!i.selectedData||i.selectedData.length===0){d.warning("请选择要分享的数据");return}w.value=!1,await ae()},G=async()=>{if(!p.value){d.warning("请选择打印模板");return}if(!i.selectedData||i.selectedData.length===0){d.warning("请选择要导出的数据");return}ee()},Q=()=>{A.push({path:"/template_designer/index",query:{pageType:i.pageType,action:"add"}}),w.value=!1},X=()=>{if(!p.value){d.warning("请先选择要修改的模板");return}if(!v.value.find(t=>t.id===p.value)){d.error("模板不存在");return}A.push({path:"/template_designer/index",query:{pageType:i.pageType,templateId:p.value,action:"edit"}}),w.value=!1},Z=()=>{A.push({path:"/template/list",query:{template_type:i.pageType}}),w.value=!1},ee=async()=>{var e;if(!p.value){d.warning("请选择打印模板");return}if(!i.selectedData||i.selectedData.length===0){d.warning("请选择要打印的数据");return}R.value=!0;try{const t=v.value.find(n=>n.id===p.value);if(!t){d.error("模板不存在");return}S.hiprint.init({providers:[new N(i.pageType)]});const a=JSON.parse(t.content),l=new S.hiprint.PrintTemplate({template:a,dataMode:1});let o=[];if(i.getDetailData){d.info("正在获取详情数据...");const n=i.selectedData.map(y=>i.getDetailData(y.id));o=(await Promise.all(n)).map(y=>_(y))}else o=i.selectedData.map(n=>_(n));let s=l.getHtml(o),c={};try{const n=((e=l.getTemplate)==null?void 0:e.call(l))||a;if(console.log("templateObj:",n),n&&n.panels&&n.panels.length>0){const r=n.panels[0];r.width&&r.height&&(c.width=r.width,c.height=r.height,c.orientation=r.width>r.height?2:1,c.paperType=r.paperType)}}catch(n){console.warn("获取hiprint纸张设置失败:",n)}if(s&&typeof s=="object"){const n=s;if(n.jquery||n.length>0&&n[0]){const r=n[0];r&&r.outerHTML?s=r.outerHTML:typeof n.html=="function"?s=n.html():s=String(s)}else typeof s!="string"&&(s=String(s))}typeof s!="string"&&(s=String(s)),console.log("处理后的HTML:",s),console.log("纸张设置:",c),await te(s,t.title||"打印",c),d.success("开始打印")}catch(t){console.error("打印失败:",t),d.error("打印失败")}finally{R.value=!1}},_=e=>{const t=me(i.pageType);if(!t)return e;const a={};return t.basicFields.forEach(l=>{const o=L(e,l.key),s=l.key.replace(/\./g,"_");a[s]=F(o,l.type,l.key)}),t.listFields.forEach(l=>{const o=L(e,l.key),s=l.key.replace(/\./g,"_");Array.isArray(o)?a[s]=o.map(c=>{const n={};return l.columns.forEach(r=>{let y=L(c,r.key);const M=r.key.replace(/\./g,"_");if(r.key==="f_stock"){const D=L(c,"f_stock"),C=L(c,"f_unit");y=D&&C?`${D}${C}`:D||""}const u=r.type||"text";n[M]=F(y,u,r.key)}),n}):a[s]=[]}),a},L=(e,t)=>{const a=t.split(".");let l=e;for(const o of a)if(l&&typeof l=="object"&&o in l)l=l[o];else if(l&&typeof l=="object"){const s=Object.keys(l).filter(c=>c.toLowerCase().includes(o.toLowerCase())||o.toLowerCase().includes(c.toLowerCase()));if(s.length>0)l=l[s[0]];else return null}else return null;return l},F=(e,t,a)=>{if(e==null)return"";if(a==="status")return{0:"未付清",1:"付清",2:"已还部分",3:"已结清"}[Number(e)]||String(e);if(a==="is_variable_price")return Number(e)===1?"变价调拨":"同价调拨";switch(t){case"currency":return`¥${(Number(e)||0).toFixed(2)}`;case"datetime":return new Date(e).toLocaleString();case"number":return(Number(e)||0).toString();default:return String(e)}},te=async(e,t="打印任务",a)=>{try{if(!E.isAvailable()){d.warning("Lodop未安装，将使用浏览器打印"),j(e);return}if(!await E.init(t)){d.warning("Lodop初始化失败，将使用浏览器打印"),j(e);return}if(a&&a.width&&a.height){const M=a.orientation||(a.width>a.height?2:1);E.setPageSize(M,`${a.width}mm`,`${a.height}mm`,a.paperType||"A4")}else E.setPageSize(1,"A4","A4","A4");const{htmlBody:o,htmlStyle:s}=O(e);let c=0,n=0,r=210,y=297;a&&a.width&&a.height&&(r=a.width,y=a.height),E.previewHtml(s,o,{top:c,left:n,width:r,height:y})}catch(l){console.error("Lodop打印失败:",l),d.error("打印失败："+l.message),j(e)}},O=e=>{const t=e.match(/<style[^>]*>([\s\S]*?)<\/style>/gi);let a="";t&&(a=t.map(s=>{const c=s.match(/<style[^>]*>([\s\S]*?)<\/style>/i);return c?c[1]:""}).join(`
`));const l=e.match(/<body[^>]*>([\s\S]*)<\/body>/i);let o=l?l[1]:e;if(!o||o.trim()===""){const s=e.match(/<html[^>]*>([\s\S]*)<\/html>/i);o=s?s[1]:e}return o=o.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,""),T.value&&(a=a?`${a}
${T.value}`:T.value),a||(a=`
      body { 
        font-family: Arial, "Microsoft YaHei", sans-serif; 
        margin: 0;
        padding: 0;
      }
      * {
        box-sizing: border-box;
      }
    `,T.value&&(a=`${a}
${T.value}`)),{htmlBody:o,htmlStyle:a}},j=e=>{e.includes("<html")||(e=`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>打印</title>
</head>
<body>
${e}
</body>
</html>`);const t=window.open("","_blank");t&&(t.document.write(e),t.document.close(),t.focus(),setTimeout(()=>{t.print()},100))},ae=async()=>{if(!p.value){d.warning("请选择打印模板");return}if(!i.selectedData||i.selectedData.length===0){d.warning("请选择要分享的数据");return}B.value=!0,x.value=!0,k.value="";try{const e=v.value.find(u=>u.id===p.value);if(!e){d.error("模板不存在");return}S.hiprint.init({providers:[new N(i.pageType)]});const t=JSON.parse(e.content),a=new S.hiprint.PrintTemplate({template:t,dataMode:1});let l=[];if(i.getDetailData){d.info("正在获取详情数据...");const u=i.selectedData.map(C=>i.getDetailData(C.id));l=(await Promise.all(u)).map(C=>_(C))}else l=i.selectedData.map(u=>_(u));let o=a.getHtml(l);if(o&&typeof o=="object"){const u=o;if(u.jquery||u.length>0&&u[0]){const D=u[0];D&&D.outerHTML?o=D.outerHTML:typeof u.html=="function"?o=u.html():o=String(o)}else typeof o!="string"&&(o=String(o))}typeof o!="string"&&(o=String(o));const{htmlBody:s,htmlStyle:c}=O(o),n=document.createElement("div");n.style.position="absolute",n.style.left="-9999px",n.style.top="-9999px",n.style.width="210mm",n.style.backgroundColor="#fff",n.style.padding="20px";const r=document.createElement("style");r.textContent=c,n.appendChild(r);const y=document.createElement("div");y.innerHTML=s,n.appendChild(y),document.body.appendChild(n),await new Promise(u=>setTimeout(u,500));const M=await pe(n,{backgroundColor:"#ffffff",scale:2,useCORS:!0,logging:!1});k.value=M.toDataURL("image/png"),document.body.removeChild(n),d.success("图片生成成功")}catch(e){console.error("生成分享图片失败:",e),d.error("生成分享图片失败"),x.value=!1}finally{B.value=!1}},le=()=>{if(!k.value)return;const e=document.createElement("a");e.href=k.value,e.download=`打印内容_${new Date().getTime()}.png`,document.body.appendChild(e),e.click(),document.body.removeChild(e),d.success("图片下载成功")};return(e,t)=>{const a=P("el-button"),l=P("el-option"),o=P("el-select"),s=P("el-link"),c=P("el-dialog"),n=P("el-icon");return V(),$(U,null,[g("div",ye,[m(a,{type:(e.isTextButton,"primary"),onClick:z,link:e.isTextButton,disabled:!i.selectedData||i.selectedData.length===0},{default:f(()=>t[5]||(t[5]=[h(" 打印 ")])),_:1},8,["type","link","disabled"])]),m(c,{modelValue:w.value,"onUpdate:modelValue":t[2]||(t[2]=r=>w.value=r),title:"打印",width:"500px","close-on-click-modal":!1,"append-to-body":!0,onClose:W},{footer:f(()=>[g("div",we,[g("div",be,[m(a,{type:"",onClick:G,disabled:!p.value},{default:f(()=>t[9]||(t[9]=[h(" 打印 ")])),_:1},8,["disabled"]),m(a,{type:"primary",onClick:K,disabled:!p.value||!i.selectedData||i.selectedData.length===0,loading:H.value},{default:f(()=>t[10]||(t[10]=[h(" 下载pdf ")])),_:1},8,["disabled","loading"]),m(a,{type:"success",onClick:Y,disabled:!p.value||!i.selectedData||i.selectedData.length===0,loading:B.value},{default:f(()=>t[11]||(t[11]=[h(" 分享 ")])),_:1},8,["disabled","loading"])]),g("div",De,[m(s,{type:"primary",underline:!1,onClick:Z,style:{"margin-right":"16px"}},{default:f(()=>t[12]||(t[12]=[h("管理模板")])),_:1}),m(a,{onClick:t[1]||(t[1]=r=>w.value=!1)},{default:f(()=>t[13]||(t[13]=[h("取消")])),_:1})])])]),default:f(()=>[g("div",ge,[g("div",he,[t[8]||(t[8]=g("label",{class:"required-label"},[g("span",{style:{color:"red"}},"*"),h("选择模板")],-1)),m(o,{modelValue:p.value,"onUpdate:modelValue":t[0]||(t[0]=r=>p.value=r),placeholder:"请选择打印模板",style:{width:"100%","margin-top":"8px"},onChange:J},{default:f(()=>[(V(!0),$(U,null,ie(v.value,r=>(V(),re(l,{key:r.id,label:r.title,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),g("div",ve,[m(s,{type:"primary",underline:!1,onClick:Q},{default:f(()=>t[6]||(t[6]=[h("新增模板")])),_:1}),m(s,{type:"primary",underline:!1,onClick:X,disabled:!p.value},{default:f(()=>t[7]||(t[7]=[h("修改当前选中模板")])),_:1},8,["disabled"])])])])]),_:1},8,["modelValue"]),m(c,{modelValue:x.value,"onUpdate:modelValue":t[4]||(t[4]=r=>x.value=r),title:"单据分享",width:"80%",top:"1%","close-on-click-modal":!1,"append-to-body":!0},{footer:f(()=>[m(a,{onClick:t[3]||(t[3]=r=>x.value=!1)},{default:f(()=>t[15]||(t[15]=[h("关闭")])),_:1}),m(a,{type:"primary",onClick:le,disabled:!k.value},{default:f(()=>t[16]||(t[16]=[h("下载图片")])),_:1},8,["disabled"])]),default:f(()=>[g("div",ke,[k.value?(V(),$("div",Te,[g("img",{src:k.value,alt:"打印内容预览",style:{height:"80vh",width:"auto"}},null,8,_e)])):(V(),$("div",Ce,[m(n,{class:"is-loading",style:{"font-size":"24px"}},{default:f(()=>[m(de(ce))]),_:1}),t[14]||(t[14]=g("span",{style:{"margin-left":"8px"}},"正在生成图片...",-1))]))])]),_:1},8,["modelValue"])],64)}}}),Me=fe(Pe,[["__scopeId","data-v-4a5a1d65"]]);export{Me as P};
