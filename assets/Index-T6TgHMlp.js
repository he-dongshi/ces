import{d as Ve,u as Ne,r as v,m as le,l as ne,o as De,U as ke,a as m,z as Ce,c as L,b as h,e as s,g as a,h as n,D as oe,I as T,k as D,p as Me,B as Fe,j as B,s as Ye,W as Te,F as j,i as He,t as p,T as Se,A as k,E as H,y as Ue,X as Re,_ as Be}from"./index-BUVdxLJQ.js";import{P as O}from"./PrintComponent-DWF2ajXU.js";import"./printProvider-D1gq-grw.js";const qe={class:"page p10"},ze={class:"left-actions"},Ee={key:0},Ie={class:"page p10"},Ke={class:"actions"},We={class:"left-actions"},Ae={style:{display:"flex","align-items":"center"}},Qe={style:{display:"inline-flex","margin-right":"10px"}},Le={style:{display:"inline-flex","margin-right":"10px"}},Pe={style:{display:"inline-flex","margin-right":"10px"}},$e={class:"drawer-container"},je={class:"drawer-header"},Oe={class:"header-actions"},Xe={class:"basic-info"},Ge={class:"info-item"},Je={class:"info-item"},Ze={class:"info-item"},et={class:"goods-content"},tt=Ve({__name:"Index",setup(at){const se=Ne(),re=[{text:"昨天",value:()=>{const t=new Date;t.setDate(t.getDate()-1),t.setHours(0,0,0,0);const e=new Date(t);return e.setHours(23,59,59,999),[t,e]}},{text:"今天",value:()=>{const t=new Date;t.setHours(0,0,0,0);const e=new Date;return e.setHours(23,59,59,999),[t,e]}},{text:"本月",value:()=>{const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t.getFullYear(),t.getMonth()+1,0);return o.setHours(23,59,59,999),[e,o]}},{text:"上月",value:()=>{const t=new Date,e=new Date(t.getFullYear(),t.getMonth()-1,1),o=new Date(t.getFullYear(),t.getMonth(),0);return o.setHours(23,59,59,999),[e,o]}},{text:"本年",value:()=>{const t=new Date,e=new Date(t.getFullYear(),0,1),o=new Date(t.getFullYear(),11,31);return o.setHours(23,59,59,999),[e,o]}},{text:"上年",value:()=>{const t=new Date,e=new Date(t.getFullYear()-1,0,1),o=new Date(t.getFullYear()-1,11,31);return o.setHours(23,59,59,999),[e,o]}}],z=v(!1),E=v(!1),I=le([{id:"1",operate:"",name:"操作",showName:"操作",align:"default",column:!0,flex:"default"},{id:"2",operate:"",name:"单据编号",showName:"单据编号",align:"default",column:!0,flex:"default"},{id:"3",operate:"",name:"调入仓库",showName:"调入仓库",align:"default",column:!0,flex:"default"},{id:"4",operate:"",name:"调出仓库",showName:"调出仓库",align:"default",column:!0,flex:"default"},{id:"5",operate:"",name:"经手人",showName:"经手人",align:"default",column:!0,flex:"default"},{id:"6",operate:"",name:"类型",showName:"类型",align:"default",column:!0,flex:"default"},{id:"7",operate:"",name:"制单时间",showName:"制单时间",align:"default",column:!0,flex:"default"}]),ie=t=>{I.splice(0,I.length,...t),E.value=!1},de=()=>{console.log("表格列配置弹窗已关闭")},ue=()=>{E.value=!0},ce=ne(()=>I.filter(t=>t.column===!0)),K=t=>t==="left"?"left":t==="center"?"right":!1,me=t=>({单据编号:"order_sn",调入仓库:"inWarehouse.name",调出仓库:"outWarehouse.name",经手人:"user.name",类型:"is_variable_price",制单时间:"created_at"})[t]||"",pe=t=>({单据编号:120,调入仓库:120,调出仓库:120,经手人:100,类型:120,制单时间:200})[t]||120,i=le({page:1,limit:15,number:""}),X=v(),C=v(!1),G=v([]),J=v(""),Z=v(0),y=v({id:null,order_sn:"",inWarehouse:null,outWarehouse:null,user:null,is_variable_price:1,created_at:"",record_list:[],remark:"",pics_arr:[]}),ee=v({}),fe=ne(()=>{var t;try{return(((t=y.value)==null?void 0:t.record_list)||[]).reduce((d,r)=>d+te(r),0).toFixed(2)}catch{return"0.00"}}),W=v(!1),_e=v("rtl");function te(t){var e;try{const o=t.goods||{},d=Number(t.small_quantity||t.num||t.quantity||0),r=Number(t.middle_quantity||0),_=Number(t.big_quantity||0),V=Number((e=y.value)==null?void 0:e.is_variable_price)===1,u=Number(t.price||o.price||o.pi_price||o.di_price||0);let c=Number(t.c_price||o.c_price||o.pi_c_price||o.di_c_price||0),N=Number(t.b_price||o.b_price||o.pi_b_price||o.di_b_price||0);if(!V){const U=Number(o.c_ratio||0),M=Number(o.b_ratio||0);(!c||isNaN(c))&&U>0&&(c=+(u*U).toFixed(4)),(!N||isNaN(N))&&M>0&&(N=+(u*M).toFixed(4))}return+(d*u+r*c+_*N)}catch{return 0}}const x=()=>{S()},ge=()=>{i.number="",S()},be=()=>{se.push({path:"/transfer/list/createTransfer"})},ve=t=>{G.value=t},we=async t=>{try{C.value=!0;const e=await k.transferDetail(t.id);if(e.code===1e4){const o=e.data;let d=null;if(o.user_id)try{const r=await k.staffDetail(o.user_id);r.code===1e4&&(d=r.data)}catch(r){console.error("获取员工信息失败:",r)}y.value={...o,user:d},ee.value={id:o.id,...o,user:d},W.value=!0}else H.error(e.message||"获取详情失败")}catch(e){console.error("获取详情失败:",e),H.error("获取详情失败")}finally{C.value=!1}},he=async t=>{try{await Ue.confirm("确定要作废此调拨单吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),C.value=!0;const e=await k.transferDelete(t.id);e&&(e.code===1e4||e.success)?(H.success("作废成功"),S()):H.error((e==null?void 0:e.msg)||"作废失败")}catch(e){e!=="cancel"&&(console.error("作废失败:",e),H.error("作废失败"))}finally{C.value=!1}},S=async()=>{C.value=!0;try{const t=await k.transferList(i);if(t.code===1e4){const e=t.data||[],o=[...new Set(e.map(r=>r.user_id).filter(Boolean))],d=new Map;if(o.length>0)try{const r=await k.staffList({page:1,limit:99999});r.code===1e4&&(r.data||[]).forEach(V=>{d.set(V.id,V)})}catch(r){console.error("获取员工列表失败:",r)}X.value=e.map(r=>({...r,user:d.get(r.user_id)||null})),Z.value=t.total||0}else H.error(t.message||"获取列表失败")}catch(t){console.error("获取列表失败:",t),H.error("获取列表失败")}finally{C.value=!1}},ye=()=>{const t=`调拨单列表_${new Date().toISOString().split("T")[0]}.xlsx`;Re(()=>k.exportTransfer(i),t)},xe=()=>{W.value=!1},P=async t=>{try{const e=await k.transferDetail(t);if(e.code===1e4){const o=e.data;let d=null;if(o.user_id)try{const u=await k.staffDetail(o.user_id);u.code===1e4&&(d=u.data)}catch(u){console.error("获取员工信息失败:",u)}const r=(o.record_list||[]).map(u=>{const c=u.goods||{},N=Number(u.small_quantity||u.num||u.quantity||0),U=Number(u.middle_quantity||0),M=Number(u.big_quantity||0),f=Number(o.is_variable_price)===1,q=Number(u.price||c.price||c.pi_price||c.di_price||0);let F=Number(u.c_price||c.c_price||c.pi_c_price||c.di_c_price||0),R=Number(u.b_price||c.b_price||c.pi_b_price||c.di_b_price||0);if(!f){const A=Number(c.c_ratio||0),Q=Number(c.b_ratio||0);(!F||isNaN(F))&&A>0&&(F=+(q*A).toFixed(4)),(!R||isNaN(R))&&Q>0&&(R=+(q*Q).toFixed(4))}const $=+(N*q+U*F+M*R);return{...u,amount:$}}),_=r.reduce((u,c)=>u+(c.amount||0),0);return{...o,user:d,record_list:r,total_amount:_}}else throw new Error(e.message||"获取调拨单详情失败")}catch(e){throw console.error("获取调拨单详情失败:",e),e}};return De(()=>{S()}),ke(()=>{S()}),(t,e)=>{const o=m("el-input"),d=m("el-form-item"),r=m("el-col"),_=m("el-button"),V=m("el-row"),u=m("el-date-picker"),c=m("el-option"),N=m("el-select"),U=m("el-form"),M=m("el-card"),f=m("el-table-column"),q=m("el-icon"),F=m("el-table"),R=m("el-pagination"),$=m("el-tag"),A=m("el-drawer"),Q=Ce("loading");return h(),L(j,null,[s("div",qe,[a(M,{shadow:"never"},{default:n(()=>[s("div",ze,[a(U,{"label-position":"left",inline:!1,model:i},{default:n(()=>[a(V,{gutter:24},{default:n(()=>[a(r,{span:6},{default:n(()=>[a(d,{label:"商品名称：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.name,"onUpdate:modelValue":e[0]||(e[0]=l=>i.name=l),placeholder:"请输入商品名称",clearable:"",onKeyup:T(x,["enter"])},null,8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{label:"入库仓库：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.name,"onUpdate:modelValue":e[1]||(e[1]=l=>i.name=l),placeholder:"请输入入库仓库",clearable:"",onKeyup:T(x,["enter"])},null,8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{label:"销售单据编号：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.number,"onUpdate:modelValue":e[2]||(e[2]=l=>i.number=l),placeholder:"请输入编号",clearable:"",onKeyup:T(x,["enter"])},null,8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{class:"goods-form-item"},{default:n(()=>[a(_,{type:"primary",onClick:x},{default:n(()=>e[14]||(e[14]=[D("查询")])),_:1}),a(_,{onClick:ge},{default:n(()=>e[15]||(e[15]=[D("重置")])),_:1}),a(_,{class:Me({topShow:z.value}),onClick:e[3]||(e[3]=l=>z.value=!z.value)},{default:n(()=>e[16]||(e[16]=[D(" 高级筛选 ")])),_:1},8,["class"])]),_:1})]),_:1})]),_:1}),z.value?(h(),L("div",Ee,[a(V,{gutter:24},{default:n(()=>[a(r,{span:12},{default:n(()=>[a(d,{label:"时间：",class:"goods-form-item"},{default:n(()=>[a(u,{modelValue:J.value,"onUpdate:modelValue":e[4]||(e[4]=l=>J.value=l),type:"datetimerange","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","date-format":"YYYY/MM/DD ddd","time-format":"A hh:mm:ss",shortcuts:re},null,8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{label:"条形码：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.phone,"onUpdate:modelValue":e[5]||(e[5]=l=>i.phone=l),placeholder:"请输入条形码"},null,8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{label:"分类：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.name,"onUpdate:modelValue":e[6]||(e[6]=l=>i.name=l),placeholder:"请输入商品名称",clearable:"",onKeyup:T(x,["enter"])},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(V,{gutter:24},{default:n(()=>[a(r,{span:6},{default:n(()=>[a(d,{label:"品牌：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.name,"onUpdate:modelValue":e[7]||(e[7]=l=>i.name=l),placeholder:"请输入品牌",clearable:"",onKeyup:T(x,["enter"])},null,8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{label:"经手人：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.name,"onUpdate:modelValue":e[8]||(e[8]=l=>i.name=l),placeholder:"请输入经手人",clearable:"",onKeyup:T(x,["enter"])},null,8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{label:"类型：",class:"goods-form-item"},{default:n(()=>[a(N,{modelValue:i.status,"onUpdate:modelValue":e[9]||(e[9]=l=>i.status=l),placeholder:"请选择类型",clearable:"",onChange:x,style:{width:"193px"}},{default:n(()=>[a(c,{label:"同价调拨",value:"0"}),a(c,{label:"变价调拨",value:"1"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(r,{span:6},{default:n(()=>[a(d,{label:"出库仓库：",class:"goods-form-item"},{default:n(()=>[a(o,{modelValue:i.name,"onUpdate:modelValue":e[10]||(e[10]=l=>i.name=l),placeholder:"请输入出库仓库",clearable:"",onKeyup:T(x,["enter"])},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})])):oe("",!0)]),_:1},8,["model"])])]),_:1})]),s("div",Ie,[a(M,{shadow:"never"},{default:n(()=>[s("div",Ke,[s("div",We,[a(_,{type:"primary",onClick:be},{default:n(()=>e[17]||(e[17]=[D("新建调拨单")])),_:1}),a(O,{"selected-data":G.value,"page-type":"transfer","get-detail-data":P},null,8,["selected-data"]),a(_,{type:"success",onClick:ye},{default:n(()=>e[18]||(e[18]=[D("导出")])),_:1})])]),Fe((h(),B(F,{ref:"multipleTableRef",data:X.value,border:"",stripe:"",onSelectionChange:ve},{default:n(()=>[a(f,{type:"selection",width:"55"}),a(f,{type:"index",width:"55"},{header:n(()=>[s("div",{style:{cursor:"pointer",color:"red"},onClick:ue},[a(q,null,{default:n(()=>[a(Ye(Te),{size:30})]),_:1})])]),_:1}),(h(!0),L(j,null,He(ce.value,l=>(h(),L(j,{key:l.id},[l.name==="操作"?(h(),B(f,{key:0,label:l.showName,align:l.align==="default"?"":l.align,fixed:K(l.flex),"min-width":"160"},{default:n(w=>[s("div",Ae,[s("div",Qe,[a(O,{"selected-data":[w.row],"page-type":"transfer","is-text-button":"","get-detail-data":P,share:""},null,8,["selected-data"])]),s("div",Le,[a(_,{type:"primary",link:"",onClick:Y=>we(w.row)},{default:n(()=>e[19]||(e[19]=[D("详情")])),_:2},1032,["onClick"])]),s("div",Pe,[a(_,{type:"primary",link:"",onClick:Y=>he(w.row)},{default:n(()=>e[20]||(e[20]=[D("作废")])),_:2},1032,["onClick"])])])]),_:2},1032,["label","align","fixed"])):l.name==="类型"?(h(),B(f,{key:1,prop:"is_variable_price",label:l.showName,align:l.align==="default"?"":l.align,fixed:K(l.flex),"min-width":"120"},{default:n(w=>[s("span",null,p(w.row.is_variable_price===1?"变价调拨":"同价调拨"),1)]),_:2},1032,["label","align","fixed"])):l.name==="经手人"?(h(),B(f,{key:2,prop:"user.name",label:l.showName,align:l.align==="default"?"":l.align,fixed:K(l.flex),"min-width":"100"},{default:n(w=>{var Y;return[s("span",null,p(((Y=w.row.user)==null?void 0:Y.name)||"--"),1)]}),_:2},1032,["label","align","fixed"])):(h(),B(f,{key:3,prop:me(l.name),label:l.showName,align:l.align==="default"?"":l.align,fixed:K(l.flex),"min-width":pe(l.name),sortable:l.name==="制单时间"},null,8,["prop","label","align","fixed","min-width","sortable"]))],64))),128))]),_:1},8,["data"])),[[Q,C.value]]),a(R,{class:"mt10",background:"",layout:"prev, pager, next,->,total,jumper","current-page":i.page,"onUpdate:currentPage":e[11]||(e[11]=l=>i.page=l),"page-size":i.limit,total:Z.value,onCurrentChange:S},null,8,["current-page","page-size","total"])]),_:1}),a(A,{modelValue:W.value,"onUpdate:modelValue":e[12]||(e[12]=l=>W.value=l),title:"调拨单详情","z-index":"2000",direction:_e.value,"before-close":xe,size:"50%"},{default:n(()=>{var l,w,Y;return[s("div",$e,[s("div",je,[e[21]||(e[21]=s("span",null,"基本信息",-1)),s("div",Oe,[a(O,{share:"","selected-data":[ee.value],"page-type":"transfer","get-detail-data":P},null,8,["selected-data"])])]),s("div",Xe,[s("div",Ge,[s("span",null,"单据编号："+p(y.value.order_sn),1),s("span",null,"经手人："+p(((l=y.value.user)==null?void 0:l.name)||"--"),1)]),s("div",Je,[s("span",null,"调入仓库："+p(((w=y.value.inWarehouse)==null?void 0:w.name)||"--"),1),s("span",null,"调出仓库："+p(((Y=y.value.outWarehouse)==null?void 0:Y.name)||"--"),1)]),s("div",Ze,[s("span",null,"调拨类型："+p(y.value.is_variable_price===1?"变价调拨":"同价调拨"),1),s("span",null,"调拨金额："+p(fe.value)+"元",1)])]),e[23]||(e[23]=s("div",{class:"drawer-header"},[s("span",null,"商品信息")],-1)),s("div",et,[a(F,{class:"little-table",data:y.value.record_list||[],style:{width:"100%"},height:"150px","header-cell-style":{background:"#f5f7fa",color:"rgba(0, 0, 0, .8)"}},{default:n(()=>[a(f,{prop:"goods.name",label:"商品名称","min-width":"150"},{default:n(g=>{var b;return[s("span",null,p(((b=g.row.goods)==null?void 0:b.name)||"--"),1),g.row.is_quan===1?(h(),B($,{key:0,type:"danger",size:"small",class:"ml5"},{default:n(()=>e[22]||(e[22]=[D("定")])),_:1})):oe("",!0)]}),_:1}),a(f,{label:"规格",width:"100"},{default:n(g=>{var b;return[s("span",null,p(((b=g.row.goods)==null?void 0:b.spec_id)||"--"),1)]}),_:1}),a(f,{label:"调出数量",width:"120"},{default:n(g=>{var b,ae;return[s("span",null,p(g.row.quantity||0)+p(((ae=(b=g.row.goods)==null?void 0:b.unit)==null?void 0:ae.name)||"件"),1)]}),_:1}),a(f,{label:"副单位",width:"120"},{default:n(g=>{var b;return[s("span",null,p(g.row.num||0)+p(((b=g.row.goods)==null?void 0:b.f_unit)||""),1)]}),_:1}),a(f,{label:"金额",width:"120"},{default:n(g=>[s("span",null,p(te(g.row).toFixed(2)),1)]),_:1})]),_:1},8,["data"])])])]}),_:1},8,["modelValue","direction"]),a(Se,{modelValue:E.value,"onUpdate:modelValue":e[13]||(e[13]=l=>E.value=l),"header-title":I,onSave:ie,onClose:de},null,8,["modelValue","header-title"])])],64)}}}),st=Be(tt,[["__scopeId","data-v-2f9526e8"]]);export{st as default};
