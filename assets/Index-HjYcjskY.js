import{d as V,G as A,u as $,r as f,o as j,A as M,E as s,R as F,a as w,c as u,b as c,e as o,g as _,h as T,k as x,F as G,i as J,t as L,_ as O}from"./index-BUVdxLJQ.js";import{C as U}from"./printProvider-D1gq-grw.js";const z={class:"print-preview"},K={class:"preview-header"},Q={class:"actions"},W={class:"preview-content"},X={key:0,class:"loading"},Y={key:1,class:"no-data"},Z={key:2,class:"print-pages"},tt=["id"],et={class:"page-header"},at=["innerHTML"],st=V({__name:"Index",setup(rt){const p=A(),D=$(),P=f(!0),l=f([]),v=f(null),r=f(null);j(async()=>{await q(),await B(),E()});const q=async()=>{try{const t=p.query.templateId,e=await M.list("template/template",{id:t});e.data&&e.data.length>0?v.value=e.data[0]:(s.error("模板不存在"),D.back())}catch(t){console.error("加载模板失败:",t),s.error("加载模板失败")}},B=async()=>{try{const t=(p.query.recordIds||"").split(",").filter(Boolean),e=p.query.pageType;let a="";switch(e){case"purchase":a="purchase";break;case"order":a="order";break;case"transfer":a="transfer";break;default:s.error("不支持的页面类型");return}const n=await M.list(a,{ids:t.join(","),page:1,limit:999});n.data&&(l.value=n.data)}catch(t){console.error("加载数据失败:",t),s.error("加载数据失败")}finally{P.value=!1}},E=()=>{if(v.value)try{const t=p.query.pageType;F.hiprint.init({providers:[new U(t)]});const e=JSON.parse(v.value.content);r.value=new F.hiprint.PrintTemplate({template:e,dataMode:1})}catch(t){console.error("初始化打印模板失败:",t),s.error("初始化打印模板失败")}},H=t=>{if(!r.value)return"";try{const e=g(t);return r.value.getHtml(e)}catch(e){return console.error("生成页面内容失败:",e),"<div>生成内容失败</div>"}},g=t=>{var a,n,d,m,i,C,b,I;switch(p.query.pageType){case"purchase":return{order_sn:t.order_sn||"",supplier_name:((a=t.supplier)==null?void 0:a.name)||"",total_amount:y(t.total_amount||0),created_at:h(t.created_at),staff_name:((n=t.staff)==null?void 0:n.name)||"",warehouse_name:((d=t.warehouse)==null?void 0:d.name)||"",status_text:k(t.status),remark:t.remark||"",goods_list:t.goods_list||[]};case"order":return{order_sn:t.order_sn||"",customer_name:((m=t.customer)==null?void 0:m.name)||"",total_amount:y(t.total_amount||0),created_at:h(t.created_at),salesman_name:((i=t.salesman)==null?void 0:i.name)||"",delivery_address:t.delivery_address||"",status_text:k(t.status),remark:t.remark||"",goods_list:t.goods_list||[]};case"transfer":return{transfer_sn:t.transfer_sn||"",from_warehouse:((C=t.from_warehouse)==null?void 0:C.name)||"",to_warehouse:((b=t.to_warehouse)==null?void 0:b.name)||"",total_amount:y(t.total_amount||0),created_at:h(t.created_at),staff_name:((I=t.staff)==null?void 0:I.name)||"",status_text:k(t.status),remark:t.remark||"",goods_list:t.goods_list||[]};default:return t}},N=()=>{if(!r.value){s.error("打印模板未初始化");return}try{const t=l.value.map(e=>g(e));r.value.print(t)}catch(t){console.error("打印失败:",t),s.error("打印失败")}},R=()=>{if(!r.value){s.error("打印模板未初始化");return}try{const t=l.value.map(e=>g(e));r.value.toPdf(t,`打印预览_${new Date().getTime()}`)}catch(t){console.error("导出PDF失败:",t),s.error("导出PDF失败")}},S=()=>{D.back()},y=t=>(t||0).toFixed(2),h=t=>t?new Date(t).toLocaleString():"",k=t=>({0:"待审核",1:"已审核",2:"已完成",3:"已取消"})[t]||"未知";return(t,e)=>{const a=w("el-button"),n=w("el-loading"),d=w("el-empty");return c(),u("div",z,[o("div",K,[e[3]||(e[3]=o("h3",null,"打印预览",-1)),o("div",Q,[_(a,{onClick:S},{default:T(()=>e[0]||(e[0]=[x("返回")])),_:1}),_(a,{type:"primary",onClick:N},{default:T(()=>e[1]||(e[1]=[x("打印")])),_:1}),_(a,{onClick:R},{default:T(()=>e[2]||(e[2]=[x("导出PDF")])),_:1})])]),o("div",W,[P.value?(c(),u("div",X,[_(n,{loading:!0,text:"加载中..."})])):l.value.length===0?(c(),u("div",Y,[_(d,{description:"暂无数据"})])):(c(),u("div",Z,[(c(!0),u(G,null,J(l.value,(m,i)=>(c(),u("div",{key:i,class:"print-page",id:`print-page-${i}`},[o("div",et,[o("span",null,"第 "+L(i+1)+" 页 / 共 "+L(l.value.length)+" 页",1)]),o("div",{class:"page-content",innerHTML:H(m)},null,8,at)],8,tt))),128))]))])])}}}),lt=O(st,[["__scopeId","data-v-13ac2c0b"]]);export{lt as default};
