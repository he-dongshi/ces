import{d as ze,l as te,r as _,o as Je,w as Me,a as x,j as C,b as i,h as v,e as n,g as c,I as Be,k as K,c as y,F as X,i as ue,t as b,q as De,p as st,D as Z,A as ie,y as it,_ as We,u as ut,G as rt,m as dt,s as O,J as se,Y as Ge,V as ct,H as pt,Z as mt,T as ft,E as A}from"./index-BUVdxLJQ.js";const vt={class:"drawer-wrapper"},_t={class:"drawer-header"},gt={class:"drawer-body"},yt={class:"category-pane"},bt={key:0,class:"loading-text"},kt=["onClick"],ht={class:"content-pane"},$t={key:0,class:"loading-text"},xt={key:1,class:"card-grid"},wt=["onClick"],Vt={class:"checkbox-container"},Nt={class:"product-img"},St=["src","alt"],Ct={class:"name-row"},Qt={class:"name"},Ut={class:"sub"},Pt={class:"sub"},It={class:"sub"},Tt={class:"sub"},qt={class:"sub"},Ft={class:"pagination-row"},Bt={class:"drawer-footer"},Dt={class:"tip"},Lt={class:"actions"},Re=12,Et=ze({__name:"TransferProductSelectorDrawer",props:{modelValue:{type:Boolean},selectedProducts:{},warehouseId:{}},emits:["update:modelValue","confirm","select","unselect"],setup(Te,{expose:pe,emit:k}){const B=Te,E=k,I=te({get:()=>B.modelValue,set:o=>E("update:modelValue",o)}),j=_(""),H=_(""),le=_(""),me=_(""),re=_(!1),fe=_(!1),g=_([]),ve=o=>{if(!o||o.length===0)return[];if(o.some($=>$.children&&$.children.length>0))return o.map($=>({...$,children:$.children||[]}));const h={},M=[];return o.forEach($=>{h[$.id]={...$,children:[]}}),o.forEach($=>{const R=$.p_id;R&&R!==0&&h[R]?(h[R].children||(h[R].children=[]),h[R].children.push(h[$.id])):M.push(h[$.id])}),M};function $e(o){return o.goodsWarehouse&&o.goodsWarehouse.length>0?Number(o.goodsWarehouse[0].stock||0):Number(o.stock||0)}const xe=async()=>{try{re.value=!0;const o=await ie.list("goods_cate",{page:1,limit:9999});if(o.code===1e4){const p=o.data||[];g.value=ve(p),g.value.length>0&&W(g.value[0])}}catch(o){console.error("获取商品分类失败:",o)}finally{re.value=!1}},_e=_([]),a=_(0),s=_(new Set),Q=te(()=>_e.value.filter(o=>s.value.has(o.id))),U=async()=>{try{fe.value=!0;const o={page:D.value,limit:Re};j.value.trim()&&(o.keyword=j.value.trim()),le.value&&(o.cate_id=le.value),B.warehouseId&&(o.warehouse_id=B.warehouseId);const p=await ie.list("goods",o);p.code===1e4&&(_e.value=p.data||[],a.value=p.total||0)}catch(o){console.error("获取商品失败:",o)}finally{fe.value=!1}},D=_(1),ee=te(()=>_e.value);function T(){D.value=1,U()}function W(o){H.value=o.name,le.value=String(o.id);const p=g.value.find(h=>{var M;return(M=h.children)==null?void 0:M.some($=>$.id===o.id)});p?me.value=`c-${p.id}-${o.id}`:me.value=`c-${o.id}`,D.value=1,U()}async function G(o){if(s.value.has(o.id))try{await it.confirm(`确定要取消选中商品"${o.name}"吗？`,"确认取消选中",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),s.value.delete(o.id),E("unselect",o)}catch{}else E("select",o)}function oe(o){var M;const p=[];let h=Number(o.goodsWarehouse[0].stock||0);if(o.b_ratio>0&&h>=o.b_ratio){const $=Math.floor(h/o.b_ratio);$>0&&(p.push(`${$}${o.b_unit.name}`),h=h%o.b_ratio)}if(o.c_ratio>0&&h>=o.c_ratio){const $=Math.floor(h/o.c_ratio);$>0&&(p.push(`${$}${o.c_unit.name}`),h=h%o.c_ratio)}return h>0&&p.push(`${h}${o.unit.name}`),p.length>0?p.join(" "):`0${((M=o.unit)==null?void 0:M.name)||""}`}function ae(){I.value=!1}function V(){Q.value.length>0&&E("confirm",Q.value),I.value=!1}function we(o){s.value.has(o.id)&&(s.value.delete(o.id),E("unselect",o))}return pe({unselectProduct:we}),Je(()=>{xe()}),Me(()=>B.selectedProducts,o=>{o&&o.length>0?s.value=new Set(o.map(p=>p.id)):s.value.clear()},{immediate:!0}),Me(()=>B.modelValue,o=>{o&&(B.selectedProducts&&B.selectedProducts.length>0&&(s.value=new Set(B.selectedProducts.map(p=>p.id))),U())}),(o,p)=>{const h=x("el-button"),M=x("el-input"),$=x("el-menu-item"),R=x("el-sub-menu"),Ve=x("el-menu"),Ne=x("el-checkbox"),ge=x("el-tag"),Se=x("el-pagination"),Ce=x("el-drawer");return i(),C(Ce,{modelValue:I.value,"onUpdate:modelValue":p[3]||(p[3]=r=>I.value=r),"with-header":!1,size:"80%","append-to-body":""},{default:v(()=>[n("div",vt,[n("div",_t,[p[5]||(p[5]=n("span",null,"选择商品（调拨）",-1)),c(M,{modelValue:j.value,"onUpdate:modelValue":p[0]||(p[0]=r=>j.value=r),placeholder:"搜索编号/名称/条码",class:"search-input",clearable:"",onKeyup:Be(T,["enter","native"])},{append:v(()=>[c(h,{type:"primary",onClick:T},{default:v(()=>p[4]||(p[4]=[K("搜索")])),_:1})]),_:1},8,["modelValue"])]),n("div",gt,[n("div",yt,[p[6]||(p[6]=n("div",{class:"category-title"},"商品分类",-1)),re.value?(i(),y("div",bt,"加载中...")):(i(),C(Ve,{key:1,class:"category-menu","default-active":me.value},{default:v(()=>[(i(!0),y(X,null,ue(g.value,(r,ne)=>(i(),y(X,{key:r.id||ne},[r.children&&r.children.length>0?(i(),C(R,{key:0,index:`c-${r.id}`},{title:v(()=>[n("span",{class:"category-title-clickable",onClick:De(z=>W(r),["stop"])},b(r.name),9,kt)]),default:v(()=>[(i(!0),y(X,null,ue(r.children,(z,ye)=>(i(),C($,{key:z.id||ye,index:`c-${r.id}-${z.id}`,onClick:de=>W(z)},{default:v(()=>[K(b(z.name),1)]),_:2},1032,["index","onClick"]))),128))]),_:2},1032,["index"])):(i(),C($,{key:1,index:`c-${r.id}`,onClick:z=>W(r)},{default:v(()=>[K(b(r.name),1)]),_:2},1032,["index","onClick"]))],64))),128))]),_:1},8,["default-active"]))]),n("div",ht,[fe.value?(i(),y("div",$t,"加载商品中...")):(i(),y("div",xt,[(i(!0),y(X,null,ue(ee.value,r=>(i(),y("div",{key:r.id,class:st(["product-card",{selected:s.value.has(r.id)}]),onClick:ne=>G(r)},[n("div",Vt,[c(Ne,{"model-value":s.value.has(r.id),"onUpdate:modelValue":ne=>G(r),onClick:p[1]||(p[1]=De(()=>{},["stop"]))},null,8,["model-value","onUpdate:modelValue"])]),n("div",Nt,[n("img",{src:r.img,alt:r.name},null,8,St)]),n("div",Ct,[n("span",Qt,b(r.name),1),r.is_quan?(i(),C(ge,{key:0,type:"primary",size:"small"},{default:v(()=>p[7]||(p[7]=[K("定")])),_:1})):Z("",!0)]),n("div",Ut,"存："+b(oe(r)),1),r.is_quan?(i(),y(X,{key:0},[n("div",Pt,"总："+b($e(r))+b(r.unit.name),1),n("div",It," 规格："+b(r==null?void 0:r.spec.name),1),n("div",Tt," 价格： "+b(r==null?void 0:r.unit.name)+"/"+b(r==null?void 0:r.price)+", "+b(r==null?void 0:r.b_unit.name)+"/"+b(r==null?void 0:r.b_price),1),n("div",qt," 条形码："+b(r==null?void 0:r.unit_barcode),1)],64)):Z("",!0)],10,wt))),128))])),n("div",Ft,[c(Se,{background:"",layout:"prev, pager, next",total:a.value,"page-size":Re,"current-page":D.value,"onUpdate:currentPage":p[2]||(p[2]=r=>D.value=r),onCurrentChange:U},null,8,["total","current-page"])])])]),n("div",Bt,[n("div",Dt,"已选 "+b(s.value.size)+" 项",1),n("div",Lt,[c(h,{onClick:ae},{default:v(()=>p[8]||(p[8]=[K("取消")])),_:1}),c(h,{type:"primary",onClick:V},{default:v(()=>p[9]||(p[9]=[K("确认")])),_:1})])])])]),_:1},8,["modelValue"])}}}),Mt=We(Et,[["__scopeId","data-v-6f8e7643"]]),zt={class:"dialog-content"},Wt={class:"inventory-info"},Ot={key:0,class:"unit-section"},At={class:"unit-row"},Kt={class:"unit-label"},jt={class:"unit-row"},Ht={class:"unit-suffix"},Gt={key:0,class:"unit-row"},Rt={class:"unit-suffix"},Jt={key:1,class:"unit-section"},Yt={class:"unit-row"},Zt={class:"unit-label"},Xt={class:"unit-row"},el={class:"unit-suffix"},tl={key:0,class:"unit-row"},ll={class:"unit-suffix"},nl={key:2,class:"unit-section"},ol={class:"unit-row"},al={class:"unit-label"},sl={class:"unit-suffix"},il=ze({__name:"TransferQuantityDialog",props:{modelValue:{type:Boolean},product:{},transferType:{}},emits:["update:modelValue","confirm","cancel"],setup(Te,{emit:pe}){const k=Te,B=pe,E=te({get:()=>k.modelValue,set:a=>B("update:modelValue",a)}),I=_({small:"",large:"",subUnit:""}),j=te(()=>k.transferType===1),H=_({small:"",large:""}),le=te(()=>!0),me=te(()=>{var a;return k.transferType===1&&((a=k.product)==null?void 0:a.is_quan)===1}),re=te(()=>{var a,s;return!((a=k.product)!=null&&a.b_ratio)||!((s=k.product)!=null&&s.stock)?"0":Math.floor(k.product.stock/k.product.b_ratio).toString()}),fe=()=>{var ee,T;if(!k.product)return"0";const a=[];let s=Number(k.product.stock||0);const Q=((ee=k.product.unit)==null?void 0:ee.name)||"件",U=Number(k.product.b_ratio||0),D=(T=k.product.b_unit)==null?void 0:T.name;if(U>0&&s>=U&&D){const W=Math.floor(s/U);W>0&&(a.push(`${W}${D}`),s=s%U)}return s>0&&a.push(`${s}${Q}`),a.length>0?a.join(" "):`0${Q}`},g=()=>{},ve=()=>{},$e=()=>{var G,oe,ae,V,we,o,p,h,M,$,R,Ve,Ne;const a=Number(I.value.small)||0,s=Number(I.value.large)||0,Q=Number(I.value.subUnit)||0;if(a<=0)return;const U=j.value?Number(H.value.small||0):Number(((G=k.product)==null?void 0:G.price)||((oe=k.product)==null?void 0:oe.pi_price)||((ae=k.product)==null?void 0:ae.di_price)||0),D=j.value?Number(H.value.large||0):Number(((V=k.product)==null?void 0:V.b_price)||((we=k.product)==null?void 0:we.pi_b_price)||((o=k.product)==null?void 0:o.di_b_price)||0),ee=+(a*U+s*D).toFixed(2);let T="";if(Number((p=k.product)==null?void 0:p.is_quan)===1){const ge=[];s&&((M=(h=k.product)==null?void 0:h.b_unit)!=null&&M.name)&&ge.push(`${s}${k.product.b_unit.name}`),a&&ge.push(`${a}${((R=($=k.product)==null?void 0:$.unit)==null?void 0:R.name)||"件"}`),T=ge.join("")}else T=`${a}${((Ne=(Ve=k.product)==null?void 0:Ve.unit)==null?void 0:Ne.name)||"件"}`;const W={product:k.product,totalQtySmallUnits:a,smallQty:a,largeQty:s,f_stock:Q||void 0,quantityText:T,amount:ee,price:j.value?U:void 0,b_price:j.value?D:void 0};B("confirm",W),E.value=!1},xe=()=>{B("cancel",k.product),E.value=!1},_e=()=>{I.value={small:"",large:"",subUnit:""},H.value={small:"",large:""}};return Me(E,a=>{a&&_e()}),(a,s)=>{var ee;const Q=x("el-input"),U=x("el-button"),D=x("el-dialog");return i(),C(D,{modelValue:E.value,"onUpdate:modelValue":s[7]||(s[7]=T=>E.value=T),title:((ee=a.product)==null?void 0:ee.name)||"商品名字",width:"500px","before-close":xe,"append-to-body":""},{footer:v(()=>[c(U,{onClick:xe},{default:v(()=>s[12]||(s[12]=[K("取消")])),_:1}),c(U,{type:"primary",onClick:$e},{default:v(()=>s[13]||(s[13]=[K("确认")])),_:1})]),default:v(()=>{var T,W,G,oe,ae;return[n("div",zt,[n("div",Wt,[n("span",null,"库存: "+b(fe()),1)]),(T=a.product)!=null&&T.b_unit&&((W=a.product)==null?void 0:W.is_quan)===1?(i(),y("div",Ot,[n("div",At,[n("span",Kt,"数量("+b(a.product.b_unit.name)+")",1),c(Q,{modelValue:re.value,"onUpdate:modelValue":s[0]||(s[0]=V=>re.value=V),readonly:"",class:"readonly-input"},null,8,["modelValue"])]),n("div",jt,[s[8]||(s[8]=n("span",{class:"unit-label"},"调拨数量",-1)),c(Q,{modelValue:I.value.large,"onUpdate:modelValue":s[1]||(s[1]=V=>I.value.large=V),placeholder:"请输入",disabled:!le.value,onInput:ve},null,8,["modelValue","disabled"]),n("span",Ht,b(a.product.b_unit.name),1)]),me.value?(i(),y("div",Gt,[s[9]||(s[9]=n("span",{class:"unit-label"},"单价",-1)),c(Q,{modelValue:H.value.large,"onUpdate:modelValue":s[2]||(s[2]=V=>H.value.large=V),placeholder:"请输入"},null,8,["modelValue"]),n("span",Rt,"元/"+b(a.product.b_unit.name),1)])):Z("",!0)])):Z("",!0),(G=a.product)!=null&&G.unit?(i(),y("div",Jt,[n("div",Yt,[n("span",Zt,"数量("+b(a.product.unit.name)+")",1),c(Q,{modelValue:a.product.stock,"onUpdate:modelValue":s[3]||(s[3]=V=>a.product.stock=V),readonly:"",class:"readonly-input"},null,8,["modelValue"])]),n("div",Xt,[s[10]||(s[10]=n("span",{class:"unit-label"},"调拨数量",-1)),c(Q,{modelValue:I.value.small,"onUpdate:modelValue":s[4]||(s[4]=V=>I.value.small=V),placeholder:"请输入",disabled:!le.value,onInput:g},null,8,["modelValue","disabled"]),n("span",el,b(a.product.unit.name),1)]),j.value?(i(),y("div",tl,[s[11]||(s[11]=n("span",{class:"unit-label"},"单价",-1)),c(Q,{modelValue:H.value.small,"onUpdate:modelValue":s[5]||(s[5]=V=>H.value.small=V),placeholder:"请输入"},null,8,["modelValue"]),n("span",ll,"元/"+b(a.product.unit.name),1)])):Z("",!0)])):Z("",!0),(oe=a.product)!=null&&oe.f_unit&&((ae=a.product)==null?void 0:ae.is_quan)!==1?(i(),y("div",nl,[n("div",ol,[n("span",al,"副单位("+b(a.product.f_unit)+")",1),c(Q,{modelValue:I.value.subUnit,"onUpdate:modelValue":s[6]||(s[6]=V=>I.value.subUnit=V),placeholder:"请输入",disabled:!le.value},null,8,["modelValue","disabled"]),n("span",sl,b(a.product.f_unit),1)])])):Z("",!0)])]}),_:1},8,["modelValue","title"])}}}),ul=We(il,[["__scopeId","data-v-df378ebb"]]),rl={class:"page"},dl={class:"padding10 mb20 section"},cl={class:"page-header"},pl={class:"header-controls"},ml={class:"header-item"},fl={class:"header-item"},vl={class:"header-item"},_l={class:"header-item"},gl={class:"section",style:{"margin-bottom":"24px"}},yl={class:"section-content"},bl={style:{display:"flex"}},kl={class:"form-item",style:{"margin-right":"14px"}},hl={class:"form-item",style:{"margin-right":"14px"}},$l={class:"form-item",style:{"margin-right":"14px"}},xl={class:"form-item",style:{"margin-right":"14px"}},wl={class:"section mb20 padding10"},Vl={class:"section-content"},Nl={style:{"margin-bottom":"10px"}},Sl=["onMouseenter"],Cl={key:0,class:"index-text"},Ql={key:1,class:"button-group"},Ul={key:0,class:"clickable-text"},Pl={key:0,class:"quantity-input-cell"},Il=["onClick"],Tl={key:0},ql={key:0,class:"quantity-input-cell"},Fl=["onClick"],Bl={key:0},Dl={class:"quantity-cell"},Ll={key:0,class:"quantity-input-cell"},El=["onClick"],Ml={key:0},zl={class:"amount-text"},Wl={class:"section mb20 padding10"},Ol={class:"section-content"},Al={class:"form-item"},Kl={class:"section-content"},jl=ze({__name:"createTransfer",setup(Te){const pe=ut(),k=rt(),B=_(!1),E=_(!1),I=_(null),j=_([]),H=_([]),le=_([]),me=async()=>{try{const l=await ie.staffList({page:1,limit:100});l.code===1e4&&(j.value=l.data||[])}catch(l){console.error("获取员工列表失败:",l)}},re=async()=>{try{const l=await ie.warehouseList({page:1,limit:100});l.code===1e4&&(H.value=l.data||[])}catch(l){console.error("获取仓库列表失败:",l)}},fe=async()=>{try{const l=await ie.postList({page:1,limit:100});l.code===1e4&&(le.value=l.data||[])}catch(l){console.error("获取部门列表失败:",l)}},g=dt({documentNumber:"",transferDate:"",transferType:2,transferOutWarehouse:"",transferInWarehouse:"",handler:"",department:"",remark:"",images:[]}),ve=_(-1),$e=l=>{a.value.splice(l,1)},xe=l=>{const e={product:{id:null}};a.value.splice(l,0,e)},_e=l=>{if(l.product.id!==null)return!1;const e=a.value.findIndex(m=>m.product.id===null);return e!==-1&&a.value[e]===l},a=_([]),s=te(()=>a.value.map(l=>l.product).filter(Boolean)),Q=_(!1),U=_(),D=()=>{if(!g.transferOutWarehouse){A.error("请先选择调出仓库");return}Q.value=!0},ee=l=>{new Set(a.value.map(m=>{var f;return(f=m.product)==null?void 0:f.id})).has(l.id)||(Le.value=l,Qe.value=!0)},T=l=>{const e=a.value.findIndex(m=>{var f;return((f=m.product)==null?void 0:f.id)===l.id});e!==-1&&a.value.splice(e,1),U.value&&U.value.unselectProduct(l)},W=l=>{const e=new Set(a.value.map(f=>{var w;return(w=f.product)==null?void 0:w.id})),m=l.filter(f=>!e.has(f.id));m.length>0&&(Ie.value=m,G())},G=()=>{Ie.value.length>0&&(Le.value=Ie.value.shift(),Qe.value=!0)},oe=l=>{const e={...l,itemRemark:"",subUnitQuantity:l.f_stock||l.subUnit||""},m=a.value.findIndex(f=>{var w;return((w=f.product)==null?void 0:w.id)===null});m!==-1?a.value[m]=e:a.value.push(e),Qe.value=!1,Ie.value.length>0&&G()},ae=l=>{T(l),Qe.value=!1,Ie.value.length>0&&G()};te(()=>a.value.reduce((l,e)=>l+e.amount,0));function V(l){const e=l.product||{},m=Number(l.smallQty||l.totalQtySmallUnits||0),f=Number(l.mediumQty||0),w=Number(l.largeQty||0),N=String(g.transferType)==="2",q=Number(N?e.price||e.pi_price||e.di_price||0:l.price||0);let P=Number(N?e.c_price||e.pi_c_price||e.di_c_price||0:l.c_price||0),S=Number(N?e.b_price||e.pi_b_price||e.di_b_price||0:l.b_price||0);if(N){const J=Number(e.c_ratio||0),Y=Number(e.b_ratio||0);(!P||isNaN(P))&&J>0&&(P=+(q*J).toFixed(4)),(!S||isNaN(S))&&Y>0&&(S=+(q*Y).toFixed(4))}return+(m*q+f*P+w*S)}const we=async()=>{try{g.documentNumber="TR"+new Date().getTime()}catch(l){console.error("获取单据编号失败:",l),A.error("获取单据编号失败")}},o=l=>{console.log("上传图片成功",l),g.images.push(l.data.path)},p=()=>{pe.back()},h=()=>{E.value?$():M()},M=async()=>{var l,e,m,f,w,N,q,P,S,J,Y,L,ke,he,qe,Fe;try{const ce={deparment_id:String(g.department||""),in_warehouse_id:String(g.transferInWarehouse||""),is_variable_price:String(g.transferType||""),order_sn:g.documentNumber||"",out_warehouse_id:String(g.transferOutWarehouse||""),pics:(g.images||[]).join(","),remark:g.remark||"",user_id:String(g.handler||"")};if(!ce.order_sn)try{const u=await ie.getOrderSn();(u==null?void 0:u.code)===1e4&&(ce.order_sn=u.data||ce.order_sn)}catch{}const t=await ie.transferAddOrder(ce);if(!(t&&(t.code===1e4||t.success))){A.error((t==null?void 0:t.msg)||"创建调拨单失败");return}const d=String(((l=t==null?void 0:t.data)==null?void 0:l.id)||((e=t==null?void 0:t.data)==null?void 0:e.order_id)||(t==null?void 0:t.order_id)||"");if(!d){A.error("未获取到调拨单ID");return}for(const u of a.value){const F=String(((m=u.product)==null?void 0:m.id)||((f=u.product)==null?void 0:f.goods_id)),je=String((w=u.product)!=null&&w.is_quan?1:0),He=String(u.smallQty||u.totalQtySmallUnits||0),et=String(u.mediumQty||0),tt=String(u.largeQty||0),Ee=String(g.transferType)==="2",lt=String(Ee?((N=u.product)==null?void 0:N.price)||((q=u.product)==null?void 0:q.pi_price)||((P=u.product)==null?void 0:P.di_price)||0:u.price??""),nt=String(Ee?((S=u.product)==null?void 0:S.c_price)||((J=u.product)==null?void 0:J.pi_c_price)||((Y=u.product)==null?void 0:Y.di_c_price)||((L=u.product)==null?void 0:L.price)||0:u.c_price??""),ot=String(Ee?((ke=u.product)==null?void 0:ke.b_price)||((he=u.product)==null?void 0:he.pi_b_price)||((qe=u.product)==null?void 0:qe.di_b_price)||((Fe=u.product)==null?void 0:Fe.price)||0:u.b_price??""),at={goods_id:F,order_id:d,is_quan:je,small_quantity:He,middle_quantity:et,big_quantity:tt,num:je==="0"?He:"",price:lt,c_price:nt,b_price:ot},Ue=await ie.transferAddGoods(at);if(!(Ue&&(Ue.code===1e4||Ue.success))){A.error((Ue==null?void 0:Ue.msg)||"添加商品失败");return}}try{const u=await ie.transferFinish({order_id:d});if(!(u&&(u.code===1e4||u.success))){A.error((u==null?void 0:u.msg)||"完成调拨失败");return}}catch{A.error("完成调拨失败");return}A.success("创建成功"),pe.back()}catch(ce){console.error("新建调拨单失败:",ce),A.error("新建调拨单失败")}},$=async()=>{try{console.log("编辑调拨单"),A.success("编辑成功"),pe.back()}catch(l){console.error("编辑调拨单失败:",l),A.error("编辑调拨单失败")}},R=()=>{Se.value=!0},Ve=l=>{Ce.value.splice(0,Ce.value.length,...l),Se.value=!1},Ne=te(()=>Ce.value.filter(l=>l.column===!0)),ge=l=>{const{columns:e,data:m}=l,f=[];return e.forEach((w,N)=>{if(N===0){f[N]="合计";return}if(w.property==="amount"){const q=m.map(P=>V(P));f[N]=`${q.reduce((P,S)=>P+S,0).toFixed(2)}`}else f[N]=""}),f};_(!1),_([]);const Se=_(!1),Ce=_([{id:"1",operate:"",name:"商品名字",showName:"商品名字",align:"default",column:!0,flex:"default"},{id:"2",operate:"",name:"规格",showName:"规格",align:"default",column:!0,flex:"default"},{id:"3",operate:"",name:"单位",showName:"单位",align:"default",column:!0,flex:"default"},{id:"4",operate:"",name:"数量",showName:"数量",align:"default",column:!0,flex:"default"},{id:"5",operate:"",name:"副单位",showName:"副单位",align:"default",column:!0,flex:"default"},{id:"6",operate:"",name:"单位（大）",showName:"单位（大）",align:"default",column:!0,flex:"default"},{id:"7",operate:"",name:"数量（大单位）",showName:"数量（大单位）",align:"default",column:!0,flex:"default"},{id:"8",operate:"",name:"金额(元)",showName:"金额(元)",align:"default",column:!0,flex:"default"},{id:"9",operate:"",name:"操作",showName:"操作",align:"default",column:!0,flex:"default"}]),r=()=>{for(let l=0;l<4;l++)a.value.push({product:{id:null},amount:0,smallQty:0,largeQty:0,quantityText:"",totalQtySmallUnits:0})};Je(async()=>{const l=k.query.id;l?(E.value=!0,I.value=l):(we(),r()),await Promise.all([me(),re(),fe()])});const ne=_(-1),z=_("");_(-1),_("");const ye=_(-1),de=_(""),Pe=_(-1),be=_("");_(-1),_("");const Ye=(l,e)=>{var m;((m=l.product)==null?void 0:m.id)==null||!l.largePrice||(Pe.value=e,be.value=String(l.largeQty??0),nextTick(()=>{const f=document.getElementById(`large-qty-input-${e}`);f==null||f.focus()}))},Oe=l=>{var S,J,Y;if(!be.value||be.value===""){Pe.value=-1;return}const e=a.value[l],m=parseFloat(be.value);if(isNaN(m)||m<=0){A.error("请输入有效的数量"),Pe.value=-1;return}e.largeQty=m,e.smallQty&&((S=e.product)!=null&&S.b_ratio)?e.totalQtySmallUnits=m*e.product.b_ratio+e.smallQty:(J=e.product)!=null&&J.b_ratio&&(e.totalQtySmallUnits=m*e.product.b_ratio);const f=Number(e.smallPrice??((Y=e.product)==null?void 0:Y.price)??0),w=Number(e.largePrice),N=Number(e.smallQty||0),q=Number(e.largeQty);let P=+(N*f+q*w).toFixed(2);Number(e.saleTypeId)===2&&(P=-Math.abs(P)),e.amount=P,Pe.value=-1,be.value=""},Ze=(l,e)=>{var m,f;((m=l.product)==null?void 0:m.id)==null||!((f=l.product)!=null&&f.f_unit)||(ye.value=e,de.value=String(l.f_stock??0),nextTick(()=>{const w=document.getElementById(`f-stock-input-${e}`);w==null||w.focus()}))},Ae=l=>{if(!de.value||de.value===""){ye.value=-1;return}const e=a.value[l],m=parseFloat(de.value);if(isNaN(m)||m<0){A.error("请输入有效的副单位数量"),ye.value=-1;return}e.f_stock=m,ye.value=-1,de.value=""},Ke=l=>{var J,Y,L,ke,he;if(!z.value||z.value===""){ne.value=-1;return}const e=a.value[l],m=((Y=(J=e.product)==null?void 0:J.unit)==null?void 0:Y.name)||"瓶",f=parseFloat(z.value);if(isNaN(f)||f<=0){A.error("请输入有效的数量"),ne.value=-1;return}e.quantityText=`${f}${m}`,e.smallQty=f;const w=Number(e.smallPrice??((L=e.product)==null?void 0:L.price)??0),N=Number(e.largePrice??((ke=e.product)==null?void 0:ke.b_price)??0),q=Number(e.smallQty),P=Number(e.largeQty||0);let S=+(q*w+P*N).toFixed(2);Number(e.saleTypeId)===2&&(S=-Math.abs(S)),e.amount=S,e.largeQty&&((he=e.product)!=null&&he.b_ratio)?e.totalQtySmallUnits=e.largeQty*e.product.b_ratio+f:e.totalQtySmallUnits=f,ne.value=-1,z.value=""},Xe=(l,e)=>{var m;console.log(l),((m=l.product)==null?void 0:m.id)!=null&&(ne.value=e,console.log(l.smallQty),z.value=l.smallQty,console.log(z.value),nextTick(()=>{const f=document.getElementById(`quantity-input-${e}`);f==null||f.focus()}))},Qe=_(!1),Le=_(null),Ie=_([]);return(l,e)=>{const m=x("el-input"),f=x("el-date-picker"),w=x("el-button"),N=x("el-option"),q=x("el-select"),P=x("MoreFilled"),S=x("el-icon"),J=x("CirclePlusFilled"),Y=x("RemoveFilled"),L=x("el-table-column"),ke=x("el-tag"),he=x("el-table"),qe=x("el-upload"),Fe=x("el-image"),ce=x("el-dialog");return i(),y("div",rl,[n("div",null,[n("div",dl,[n("div",cl,[n("div",pl,[n("div",ml,[n("div",fl,[e[16]||(e[16]=n("div",{class:"lable"},"单据编号：",-1)),c(m,{modelValue:g.documentNumber,"onUpdate:modelValue":e[0]||(e[0]=t=>g.documentNumber=t),placeholder:"请输入",readonly:""},null,8,["modelValue"])]),n("div",vl,[e[17]||(e[17]=n("div",{class:"lable"},"调拨日期：",-1)),c(f,{modelValue:g.transferDate,"onUpdate:modelValue":e[1]||(e[1]=t=>g.transferDate=t),type:"date",placeholder:"请选择"},null,8,["modelValue"])])]),n("div",_l,[c(w,{type:"primary",onClick:e[2]||(e[2]=t=>B.value=!0)},{default:v(()=>e[18]||(e[18]=[K("附件")])),_:1}),c(w,{onClick:p,type:"danger"},{default:v(()=>e[19]||(e[19]=[K("取消")])),_:1}),c(w,{type:"primary",onClick:h},{default:v(()=>[K(b(E.value?"保存":"确认"),1)]),_:1})])])]),n("div",gl,[n("div",yl,[n("div",bl,[n("div",kl,[e[20]||(e[20]=n("div",{class:"lable"},"经手人",-1)),c(q,{modelValue:g.handler,"onUpdate:modelValue":e[3]||(e[3]=t=>g.handler=t),placeholder:"请选择",filterable:""},{default:v(()=>[(i(!0),y(X,null,ue(j.value,t=>(i(),C(N,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",hl,[e[21]||(e[21]=n("div",{class:"lable"},"部门",-1)),c(q,{modelValue:g.department,"onUpdate:modelValue":e[4]||(e[4]=t=>g.department=t),placeholder:"请选择",filterable:""},{default:v(()=>[(i(!0),y(X,null,ue(le.value,t=>(i(),C(N,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",$l,[e[22]||(e[22]=n("div",{class:"lable"},"调出仓库",-1)),c(q,{modelValue:g.transferOutWarehouse,"onUpdate:modelValue":e[5]||(e[5]=t=>g.transferOutWarehouse=t),placeholder:"请选择",filterable:""},{default:v(()=>[(i(!0),y(X,null,ue(H.value,t=>(i(),C(N,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",xl,[e[23]||(e[23]=n("div",{class:"lable"},"调入仓库",-1)),c(q,{modelValue:g.transferInWarehouse,"onUpdate:modelValue":e[6]||(e[6]=t=>g.transferInWarehouse=t),placeholder:"请选择",filterable:""},{default:v(()=>[(i(!0),y(X,null,ue(H.value,t=>(i(),C(N,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])])])]),n("div",wl,[n("div",Vl,[n("div",Nl,[c(w,{type:"primary",onClick:D},{default:v(()=>e[24]||(e[24]=[K("添加商品")])),_:1})]),c(he,{data:a.value,border:"",stripe:"",style:{"table-layout":"auto"},"header-cell-style":O(ct),"summary-method":ge,"show-summary":""},{default:v(()=>[c(L,{fixed:"left",type:"index",label:"序号",align:"center",width:"80"},{header:v(()=>[n("div",{style:{cursor:"pointer",color:"red"},onClick:R},[c(S,null,{default:v(()=>[c(P,{size:30})]),_:1})])]),default:v(t=>[n("div",{class:"index-cell",onMouseenter:d=>ve.value=t.$index,onMouseleave:e[7]||(e[7]=d=>ve.value=-1)},[ve.value!==t.$index?(i(),y("span",Cl,b(t.$index+1),1)):(i(),y("div",Ql,[c(S,{size:22,style:{cursor:"pointer",color:"green"},onClick:De(d=>xe(t.$index),["stop"])},{default:v(()=>[c(J)]),_:2},1032,["onClick"]),c(S,{size:22,style:{cursor:"pointer",color:"red"},onClick:De(d=>$e(t.$index),["stop"])},{default:v(()=>[c(Y)]),_:2},1032,["onClick"])]))],40,Sl)]),_:1}),(i(!0),y(X,null,ue(Ne.value,t=>(i(),y(X,{key:t.name},[t.name==="商品名字"?(i(),C(L,{key:0,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),prop:"product.name",label:t.showName,"min-width":"200"},{default:v(d=>[d.row.product.name?(i(),y("span",Ul,b(d.row.product.name),1)):_e(d.row)?(i(),y("span",{key:1,class:"clickable-text",onClick:D}," 添加商品 ")):Z("",!0),d.row.product.is_quan?(i(),C(ke,{key:2,type:"primary",class:"ml5"},{default:v(()=>e[25]||(e[25]=[K("定")])),_:1})):Z("",!0)]),_:2},1032,["align","fixed","label"])):t.name==="规格"?(i(),C(L,{key:1,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),label:t.showName,width:"120"},{default:v(d=>{var u;return[n("span",null,b((u=d.row.product.spec)==null?void 0:u.name),1)]}),_:2},1032,["align","fixed","label"])):t.name==="单位"?(i(),C(L,{key:2,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),prop:"product.unit",label:t.showName,"min-width":"120"},{default:v(d=>{var u,F;return[n("span",null,b((F=(u=d.row.product)==null?void 0:u.unit)==null?void 0:F.name),1)]}),_:2},1032,["align","fixed","label"])):t.name==="数量"?(i(),C(L,{key:3,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),label:t.showName,"min-width":"120"},{default:v(d=>{var u;return[ne.value===d.$index?(i(),y("div",Pl,[c(m,{size:O(Ge),modelValue:z.value,"onUpdate:modelValue":e[8]||(e[8]=F=>z.value=F),onBlur:F=>Ke(d.$index),onKeyup:Be(F=>Ke(d.$index),["enter"]),type:"number",id:`quantity-input-${d.$index}`,placeholder:"请输入数量"},null,8,["size","modelValue","onBlur","onKeyup","id"])])):(i(),y("div",{key:1,class:"quantity-cell",onClick:F=>Xe(d.row,d.$index)},[((u=d.row.product)==null?void 0:u.id)!==null&&d.row.smallQty!==0?(i(),y("span",Tl,b(d.row.smallQty),1)):Z("",!0)],8,Il))]}),_:2},1032,["align","fixed","label"])):t.name==="副单位"?(i(),C(L,{key:4,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),label:t.showName,width:"120"},{default:v(d=>{var u;return[ye.value===d.$index?(i(),y("div",ql,[c(m,{modelValue:de.value,"onUpdate:modelValue":e[9]||(e[9]=F=>de.value=F),onBlur:F=>Ae(d.$index),onKeyup:Be(F=>Ae(d.$index),["enter"]),type:"number",id:`f-stock-input-${d.$index}`,placeholder:"请输入副单位数量"},null,8,["modelValue","onBlur","onKeyup","id"])])):(i(),y("div",{key:1,class:"quantity-cell",onClick:F=>Ze(d.row,d.$index)},[d.row.f_stock&&((u=d.row.product)!=null&&u.f_unit)?(i(),y("span",Bl,b(d.row.f_stock)+b(d.row.product.f_unit),1)):Z("",!0)],8,Fl))]}),_:2},1032,["align","fixed","label"])):t.name==="单位（大）"?(i(),C(L,{key:5,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),prop:"product.b_unit",label:t.showName,"min-width":"120"},{default:v(d=>{var u,F;return[n("div",Dl,[n("span",null,b((F=(u=d.row.product)==null?void 0:u.b_unit)==null?void 0:F.name),1)])]}),_:2},1032,["align","fixed","label"])):t.name==="数量（大单位）"?(i(),C(L,{key:6,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),prop:"largeQty",label:t.showName,"min-width":"140"},{default:v(d=>[Pe.value===d.$index?(i(),y("div",Ll,[c(m,{size:O(Ge),modelValue:be.value,"onUpdate:modelValue":e[10]||(e[10]=u=>be.value=u),onBlur:u=>Oe(d.$index),onKeyup:Be(u=>Oe(d.$index),["enter"]),type:"number",id:`large-qty-input-${d.$index}`,placeholder:"请输入数量"},null,8,["size","modelValue","onBlur","onKeyup","id"])])):(i(),y("div",{key:1,class:"quantity-cell",onClick:u=>Ye(d.row,d.$index)},[d.row.largeQty?(i(),y("span",Ml,b(d.row.largeQty),1)):Z("",!0)],8,El))]),_:2},1032,["align","fixed","label"])):t.name==="金额(元)"?(i(),C(L,{key:7,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),prop:"amount",label:t.showName,width:"120"},{default:v(d=>[n("span",zl,b(V(d.row).toFixed(2)),1)]),_:2},1032,["align","fixed","label"])):t.name==="操作"?(i(),C(L,{key:8,align:t.align==="default"?"":t.align,fixed:O(se)(t.flex),label:t.showName,width:"80"},{default:v(d=>[c(w,{type:"primary",link:"",onClick:u=>$e(d.$index)},{default:v(()=>e[26]||(e[26]=[K("删除")])),_:2},1032,["onClick"])]),_:2},1032,["align","fixed","label"])):Z("",!0)],64))),128))]),_:1},8,["data","header-cell-style"])])]),n("div",Wl,[n("div",Ol,[n("div",Al,[c(m,{modelValue:g.remark,"onUpdate:modelValue":e[11]||(e[11]=t=>g.remark=t),type:"textarea",rows:4,placeholder:"请输入备注"},null,8,["modelValue"])])])]),c(ce,{modelValue:B.value,"onUpdate:modelValue":e[12]||(e[12]=t=>B.value=t),title:"上传附件",width:"400px",center:""},{default:v(()=>[n("div",Kl,[c(qe,{class:"upload-demo",drag:"",headers:{Authorization:`Bearer ${O(pt)().token}`},name:"image","show-file-list":!1,"on-success":o,action:"https://software.syn.tswm.club/api/upload/image",multiple:""},{default:v(()=>[c(S,{class:"el-icon--upload"},{default:v(()=>[c(O(mt))]),_:1}),e[27]||(e[27]=n("div",{class:"el-upload__text"}," 上传图片 ",-1))]),_:1},8,["headers"]),(i(!0),y(X,null,ue(g.images,t=>(i(),y("div",{key:t,class:"image-item"},[c(Fe,{src:t},null,8,["src"])]))),128))])]),_:1},8,["modelValue"])]),c(Mt,{ref_key:"productSelectorRef",ref:U,modelValue:Q.value,"onUpdate:modelValue":e[13]||(e[13]=t=>Q.value=t),"selected-products":s.value,"warehouse-id":g.transferOutWarehouse,onConfirm:W,onSelect:ee,onUnselect:T},null,8,["modelValue","selected-products","warehouse-id"]),c(ul,{modelValue:Qe.value,"onUpdate:modelValue":e[14]||(e[14]=t=>Qe.value=t),product:Le.value,"transfer-type":g.transferType,onConfirm:oe,onCancel:ae},null,8,["modelValue","product","transfer-type"]),c(ft,{modelValue:Se.value,"onUpdate:modelValue":e[15]||(e[15]=t=>Se.value=t),"header-title":Ce.value,onSave:Ve},null,8,["modelValue","header-title"])])}}}),Gl=We(jl,[["__scopeId","data-v-9e8e399b"]]);export{Gl as default};
