import{d as Y,l as O,r as N,w as nt,a as q,j as Z,b as M,h as c,e as a,c as z,D as G,t as b,g as d,k as w,_ as tt,G as lt,u as ot,o as at,A as J,E as X}from"./index-BUVdxLJQ.js";import{T as it}from"./ProductSelectorDrawer-C8mZ5gyy.js";const st={class:"dialog-content"},ut={class:"row head"},dt={class:"muted"},rt={key:0,class:"grid"},ct={class:"cell"},mt={class:"value"},vt={class:"cell"},_t={key:1,class:"grid"},ft={class:"cell"},pt={class:"value"},yt={class:"cell"},bt={class:"grid"},gt={class:"cell"},$t={class:"value"},ht={class:"cell"},wt={key:2,class:"grid"},kt={class:"cell"},Vt=Y({__name:"InventoryQuantityDialog",props:{modelValue:{type:Boolean},product:{}},emits:["update:modelValue","confirm","cancel"],setup(L,{emit:F}){const V=L,g=F,v=O({get:()=>V.modelValue,set:e=>g("update:modelValue",e)}),m=N({small:"",medium:"",large:"",fnum:""});nt(()=>V.modelValue,e=>{e&&(m.value={small:"",medium:"",large:"",fnum:""})});const B=O(()=>{var s,f;const e=V.product;return e!=null&&e.c_ratio?`${Math.floor((e.stock||0)/e.c_ratio)}${((f=e.c_unit)==null?void 0:f.name)||""}`:`0${((s=e==null?void 0:e.c_unit)==null?void 0:s.name)||""}`}),P=O(()=>{var s,f;const e=V.product;return e!=null&&e.b_ratio?`${Math.floor((e.stock||0)/e.b_ratio)}${((f=e.b_unit)==null?void 0:f.name)||""}`:`0${((s=e==null?void 0:e.b_unit)==null?void 0:s.name)||""}`});function x(e){var f;if(!e)return"0";const o=[];let s=Number(e.stock||0);if(e.b_ratio&&s>=e.b_ratio&&e.b_unit){const C=Math.floor(s/e.b_ratio);o.push(`${C}${e.b_unit.name}`),s=s%e.b_ratio}if(e.c_ratio&&s>=e.c_ratio&&e.c_unit){const C=Math.floor(s/e.c_ratio);o.push(`${C}${e.c_unit.name}`),s=s%e.c_ratio}return s>0&&o.push(`${s}${((f=e.unit)==null?void 0:f.name)||"件"}`),o.join(" ")}function k(){var Q,$;const e=Number(m.value.small)||0,o=Number(m.value.medium)||0,s=Number(m.value.large)||0,f=Number(m.value.fnum)||0,C=(($=(Q=V.product)==null?void 0:Q.unit)==null?void 0:$.name)||"件",T={product:V.product,smallQty:e,mediumQty:o,largeQty:s,fnum:f,quantityText:`${e}${C}`,amount:0};g("confirm",T)}function H(){g("cancel",V.product),v.value=!1}return(e,o)=>{var T;const s=q("el-input"),f=q("el-button"),C=q("el-dialog");return M(),Z(C,{modelValue:v.value,"onUpdate:modelValue":o[4]||(o[4]=Q=>v.value=Q),title:((T=e.product)==null?void 0:T.name)||"商品",width:"520px","append-to-body":""},{footer:c(()=>[d(f,{onClick:H},{default:c(()=>o[14]||(o[14]=[w("取消")])),_:1}),d(f,{type:"primary",onClick:k},{default:c(()=>o[15]||(o[15]=[w("确定")])),_:1})]),default:c(()=>{var Q,$,D,j,R,A;return[a("div",st,[a("div",ut,[o[5]||(o[5]=a("span",null,"盘前数量：",-1)),a("span",dt,b(x(e.product)),1)]),(Q=e.product)!=null&&Q.b_unit?(M(),z("div",rt,[a("div",ct,[o[6]||(o[6]=a("div",{class:"label"},"大单位盘前",-1)),a("div",mt,b(P.value),1)]),a("div",vt,[o[7]||(o[7]=a("div",{class:"label"},"实盘数量",-1)),d(s,{modelValue:m.value.large,"onUpdate:modelValue":o[0]||(o[0]=u=>m.value.large=u),placeholder:"请输入"},{append:c(()=>{var u,S;return[w(b((S=(u=e.product)==null?void 0:u.b_unit)==null?void 0:S.name),1)]}),_:1},8,["modelValue"])])])):G("",!0),($=e.product)!=null&&$.c_unit?(M(),z("div",_t,[a("div",ft,[o[8]||(o[8]=a("div",{class:"label"},"中单位盘前",-1)),a("div",pt,b(B.value),1)]),a("div",yt,[o[9]||(o[9]=a("div",{class:"label"},"实盘数量",-1)),d(s,{modelValue:m.value.medium,"onUpdate:modelValue":o[1]||(o[1]=u=>m.value.medium=u),placeholder:"请输入"},{append:c(()=>{var u,S;return[w(b((S=(u=e.product)==null?void 0:u.c_unit)==null?void 0:S.name),1)]}),_:1},8,["modelValue"])])])):G("",!0),a("div",bt,[a("div",gt,[o[10]||(o[10]=a("div",{class:"label"},"小单位盘前",-1)),a("div",$t,b(((D=e.product)==null?void 0:D.stock)||0)+b(((R=(j=e.product)==null?void 0:j.unit)==null?void 0:R.name)||"件"),1)]),a("div",ht,[o[11]||(o[11]=a("div",{class:"label"},"实盘数量",-1)),d(s,{modelValue:m.value.small,"onUpdate:modelValue":o[2]||(o[2]=u=>m.value.small=u),placeholder:"请输入"},{append:c(()=>{var u,S;return[w(b(((S=(u=e.product)==null?void 0:u.unit)==null?void 0:S.name)||"件"),1)]}),_:1},8,["modelValue"])])]),(A=e.product)!=null&&A.f_unit?(M(),z("div",wt,[o[13]||(o[13]=a("div",{class:"cell"},[a("div",{class:"label"},"副单位盘前"),a("div",{class:"value"},"—")],-1)),a("div",kt,[o[12]||(o[12]=a("div",{class:"label"},"实盘数量",-1)),d(s,{modelValue:m.value.fnum,"onUpdate:modelValue":o[3]||(o[3]=u=>m.value.fnum=u),placeholder:"请输入"},{append:c(()=>{var u;return[w(b((u=e.product)==null?void 0:u.f_unit),1)]}),_:1},8,["modelValue"])])])):G("",!0)])]}),_:1},8,["modelValue","title"])}}}),St=tt(Vt,[["__scopeId","data-v-b7ab7bb4"]]),Ct={class:"page p20"},Qt={class:"page-header"},It={class:"header-actions"},Nt={class:"sub"},qt={class:"section mb20"},xt={class:"section-title"},Pt={class:"section-content"},Tt={class:"section"},Ut={class:"section-content"},Mt={class:"summary"},Bt=Y({__name:"InventoryJoin",setup(L){const F=lt(),V=ot(),g=N(null),v=N([]),m=N(""),B=N(!1),P=N(),x=N(null),k=N(!1),H=O(()=>v.value.map(t=>t.product));async function e(){var n,l,i,r,U;const t=String(F.query.id||"");if(t)try{let p=null;try{const _=await J.list(`inventory_plan/${t}`,{});p=(_==null?void 0:_.data)||((n=_==null?void 0:_.data)==null?void 0:n.info)||null}catch{}if(!p){const _=await J.list("inventory_plan",{id:t});p=((l=_==null?void 0:_.data)==null?void 0:l.info)||((U=(r=(i=_==null?void 0:_.data)==null?void 0:i.list)==null?void 0:r.data)==null?void 0:U[0])||null}p&&(g.value={id:String(p.id||p.plan_id||t),sn:String(p.order_sn||p.sn||""),warehouseId:String(p.warehouse_id||p.in_warehouse_id||"")},v.value=[])}catch{g.value={id:t,sn:"",warehouseId:""}}}function o(){B.value=!0}function s(t){var i;if(!t)return"0";const n=[];let l=Number(t.stock||0);if(t.b_ratio&&l>=t.b_ratio&&t.b_unit){const r=Math.floor(l/t.b_ratio);n.push(`${r}${t.b_unit.name}`),l=l%t.b_ratio}if(t.c_ratio&&l>=t.c_ratio&&t.c_unit){const r=Math.floor(l/t.c_ratio);n.push(`${r}${t.c_unit.name}`),l=l%t.c_ratio}return l>0&&n.push(`${l}${((i=t.unit)==null?void 0:i.name)||"件"}`),n.join(" ")}function f(t){var i;if(!t)return"0";const n=[],l=t.product;return t.largeQty>0&&(l!=null&&l.b_unit)&&n.push(`${t.largeQty}${l.b_unit.name}`),t.mediumQty>0&&(l!=null&&l.c_unit)&&n.push(`${t.mediumQty}${l.c_unit.name}`),t.smallQty>0&&n.push(`${t.smallQty}${((i=l==null?void 0:l.unit)==null?void 0:i.name)||"件"}`),n.length>0?n.join(" "):"0"}async function C(t){v.value.some(l=>{var i;return((i=l.product)==null?void 0:i.id)===t.id})||(await K([t]),x.value=t,k.value=!0)}function T(t){const n=v.value.findIndex(l=>{var i;return((i=l.product)==null?void 0:i.id)===t.id});n!==-1&&v.value.splice(n,1),P.value&&P.value.unselectProduct(t)}async function Q(t){const n=new Set(v.value.map(i=>{var r;return(r=i.product)==null?void 0:r.id})),l=t.filter(i=>!n.has(i.id));l.length>0&&(await K(l),x.value=l.shift(),k.value=!0,$.value=l)}const $=N([]);function D(t){v.value.push({...t,realText:t.quantityText}),k.value=!1,$.value.length>0&&(x.value=$.value.shift(),k.value=!0)}function j(t){k.value=!1,P.value&&P.value.unselectProduct(t),$.value.length>0&&(x.value=$.value.shift(),k.value=!0)}function R(t){x.value=v.value[t].product,$.value=[],k.value=!0}function A(t){v.value.splice(t,1)}async function u(){var t,n;try{m.value||await K(v.value.map(i=>i.product));const l=String(m.value||((t=g.value)==null?void 0:t.id)||"");for(const i of v.value){const r={goods_id:String(((n=i.product)==null?void 0:n.id)||""),inventory_plan_child_id:l,small_quantity:String(i.smallQty||0),middle_quantity:String(i.mediumQty||0),big_quantity:String(i.largeQty||0),num:String(i.fnum||0)};await J.add("inventory_plan_goods_log",r)}X.success("提交成功"),V.replace({name:"inventoryDetail",query:{id:g.value.id}})}catch{X.error("提交失败")}}function S(t){var l;if(!t)return null;const n=[t.cate_id,t.category_id,t.categoryId,t.goods_cate_id,t.goodsCateId,(l=t==null?void 0:t.cate)==null?void 0:l.id];for(const i of n)if(i!=null&&String(i)!=="")return Number(i);return null}async function K(t){var n,l,i,r;if(!m.value)try{const p=Array.from(new Set((t||[]).map(S).filter(h=>typeof h=="number"&&h>0))).join(","),_={warehouse_id:String(((n=g.value)==null?void 0:n.warehouseId)||""),pid:String(((l=g.value)==null?void 0:l.id)||""),type:"2",cate_ids:p},y=await J.add("inventory_plan",_);if(y&&(y.code===1e4||y.success)){const h=String(((i=y==null?void 0:y.data)==null?void 0:i.id)||((r=y==null?void 0:y.data)==null?void 0:r.plan_id)||(y==null?void 0:y.id)||"");h&&(m.value=h)}}catch{}}function et(){V.back()}return at(e),(t,n)=>{var y;const l=q("el-button"),i=q("el-alert"),r=q("el-table-column"),U=q("el-tag"),p=q("el-table"),_=q("el-card");return M(),z("div",Ct,[d(_,{shadow:"never"},{default:c(()=>{var h;return[a("div",Qt,[n[3]||(n[3]=a("h2",null,"加入盘点",-1)),a("div",It,[a("div",Nt,"编号："+b((h=g.value)==null?void 0:h.sn),1),d(l,{class:"ml10",onClick:et},{default:c(()=>n[2]||(n[2]=[w("返回")])),_:1})])]),a("div",qt,[a("div",xt,[n[5]||(n[5]=a("span",null,"按分类选择",-1)),a("div",null,[d(l,{type:"primary",onClick:o},{default:c(()=>n[4]||(n[4]=[w("开始盘点")])),_:1})])]),a("div",Pt,[d(i,{type:"info",closable:!1,title:"需先建立盘点单，再在此加入商品并录入实盘数量。"})])]),a("div",Tt,[n[10]||(n[10]=a("div",{class:"section-title"},[a("span",null,"已加入商品")],-1)),a("div",Ut,[d(p,{data:v.value,border:"",stripe:""},{default:c(()=>[d(r,{type:"index",width:"60",label:"序号"}),d(r,{prop:"product.name",label:"商品","min-width":"200"},{default:c(I=>{var E,W;return[a("span",null,b((E=I.row.product)==null?void 0:E.name),1),(W=I.row.product)!=null&&W.is_quan?(M(),Z(U,{key:0,type:"primary",size:"small",class:"ml5"},{default:c(()=>n[6]||(n[6]=[w("定")])),_:1})):G("",!0)]}),_:1}),d(r,{label:"盘前数量",width:"220"},{default:c(I=>[a("span",null,b(s(I.row.product)),1)]),_:1}),d(r,{label:"实盘数量",width:"200"},{default:c(I=>[a("span",null,b(f(I.row)),1)]),_:1}),d(r,{label:"操作",width:"120"},{default:c(I=>[d(l,{type:"primary",link:"",onClick:E=>R(I.$index)},{default:c(()=>n[7]||(n[7]=[w("录入")])),_:2},1032,["onClick"]),d(l,{link:"",onClick:E=>A(I.$index)},{default:c(()=>n[8]||(n[8]=[w("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),a("div",Mt,[a("span",null,"已盘商品："+b(v.value.length),1),d(l,{type:"primary",onClick:u},{default:c(()=>n[9]||(n[9]=[w("提交盘点")])),_:1})])])])]}),_:1}),d(it,{ref_key:"selectorRef",ref:P,modelValue:B.value,"onUpdate:modelValue":n[0]||(n[0]=h=>B.value=h),"selected-products":H.value,"warehouse-id":(y=g.value)==null?void 0:y.warehouseId,onConfirm:Q,onSelect:C,onUnselect:T},null,8,["modelValue","selected-products","warehouse-id"]),d(St,{modelValue:k.value,"onUpdate:modelValue":n[1]||(n[1]=h=>k.value=h),product:x.value,onConfirm:D,onCancel:j},null,8,["modelValue","product"])])}}}),Rt=tt(Bt,[["__scopeId","data-v-52a263e3"]]);export{Rt as default};
