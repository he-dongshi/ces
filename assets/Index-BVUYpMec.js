import{P as de,Q as ce,d as me,G as pe,u as ge,r as w,l as G,o as ve,n as J,R as L,a as I,c as M,b as k,e as o,D as Y,F as K,i as X,p as he,t as be,g as f,h as A,j as fe,k as V,E as B,A as Z,_ as _e}from"./index-BUVdxLJQ.js";import{g as U,a as ye,C as xe}from"./printProvider-D1gq-grw.js";var Ee=ce();const H=de(Ee),C=l=>l.replace(/\./g,"_"),i=l=>l*2.834645669,N=2.5,j=4,D=5,we=l=>i(l-N*2),Ce=l=>l==="receipt_58"?58:80,Te=l=>l==="receipt_58"||l==="receipt_80"?80:l==="receipt_80_long"?150:80,g=8.5,O=210,ee=297,te=7,W=9,Pe=16,ke=35,Ae=3,He=16,Ie=3.5,Me=l=>l==="A4"?{width:O,height:ee,usableWidth:O-g*2,margin:g}:l==="A3"?{width:297,height:420,usableWidth:297-g*2,margin:g}:l==="A5"?{width:148,height:210,usableWidth:148-g*2,margin:g}:l.includes("241mm")?{width:241,height:l.includes("full")?280:l.includes("half")?140:93,usableWidth:241-g*2,margin:g}:{width:O,height:ee,usableWidth:O-g*2,margin:g},$=(l,n,m,t,r,a,u,v=12,d=!1)=>({options:{left:m,top:t,height:a,width:r,title:u,...d?{}:{field:C(n)},fontSize:v,fontWeight:"normal",fontFamily:"Microsoft YaHei",textAlign:d?"center":"left",color:"#000000",...d?{}:{testData:`@${u}`},qid:n.replace(/\./g,"_"),right:m+r,bottom:t+a,vCenter:m+r/2,hCenter:t+a/2,coordinateSync:!1,widthHeightSync:!1,hideTitle:d,textContentVerticalAlign:"middle",qrCodeLevel:0},printElementType:{title:u,type:"text"}}),le=(l,n,m,t,r,a,u,v,d=9,s=!1)=>({options:{left:m,top:t,height:a,width:r,lHeight:s?60:80,title:u,field:C(n),fontSize:d,fontFamily:"Microsoft YaHei",lineHeight:s?8.5:9.75,textAlign:"center",tableBorder:s?"topBottomBorder":"border",tableHeaderBorder:s?"topBottomBorder":"border",tableHeaderCellBorder:s?"noBorder":"border",tableHeaderRowHeight:s?16:22,tableHeaderBackground:"#f0f0f0",tableHeaderFontSize:d,tableHeaderFontWeight:"bold",tableBodyCellBorder:s?"noBorder":"border",tableBodyRowBorder:s?"topBottomBorder":"border",tableBodyRowHeight:s?16:20,qid:C(n),right:m+r,bottom:t+a,vCenter:m+r/2,hCenter:t+a/2,coordinateSync:!1,widthHeightSync:!1,columns:[v.map(p=>({width:p.width,title:p.label,field:C(p.key),checked:!0,columnId:C(p.key),fixed:!1,rowspan:1,colspan:1,align:p.align||"center",halign:"center",tableQRCodeLevel:0,tableSummaryTitle:!0,tableSummary:""}))]},printElementType:{title:u,type:"table",editable:!0,columnDisplayEditable:!0,columnDisplayIndexEditable:!0,columnTitleEditable:!0,columnResizable:!0,columnAlignEditable:!0,isEnableEditField:!0,isEnableContextMenu:!0,isEnableInsertRow:!0,isEnableDeleteRow:!0,isEnableInsertColumn:!0,isEnableDeleteColumn:!0,isEnableMergeCell:!0}}),ne=(l,n,m,t,r,a,u,v=12)=>({options:{left:m,top:t,height:a,width:r,title:u,field:C(n),fontSize:v,fontFamily:"Microsoft YaHei",fontWeight:"normal",textAlign:"left",color:"#000000",testData:`@${u}`,qid:C(n),right:m+r,bottom:t+a,vCenter:m+r/2,hCenter:t+a/2},printElementType:{title:u,type:"longText"}}),Be=(l,n,m="A4")=>{const t=U(l);if(!t)return null;const r=Me(m),a=[],u=Math.min(ke,r.width-g*2),v=i((r.width-u)/2);a.push($("defaultModule","title",v,i(Ae),i(u),i(te),n,12,!0));let d=He,s=g;const p=r.usableWidth;t.basicFields.forEach(c=>{if(c.type==="longText")s!==g&&(d+=W,s=g),a.push(ne("defaultModule",c.key,i(g),i(d),i(c.width||p),i(c.height||21),c.label)),d+=(c.height||21)+W,s=g;else{const _=c.width||64;s+_>p&&(d+=W,s=g),a.push($("defaultModule",c.key,i(s),i(d),i(_),i(te),c.label,12,!1)),s+=_+Ie,s+53>p&&(d+=W,s=g)}});let T=d+11;return t.listFields.forEach(c=>{const _=p,P=Pe,R=c.columns.reduce((x,F)=>x+(F.width||35),0),q=c.columns.map(x=>({key:x.key,label:x.label,width:i((x.width||35)*(_/R)),align:x.align}));a.push(le("defaultModule",c.key,i(g),i(T),i(_),i(P),c.label,q)),T+=P+W}),{panels:[{index:0,name:1,paperType:m,height:r.height,width:r.width,paperHeader:0,paperFooter:i(r.height),printElements:a,paperNumberContinue:!0,watermarkOptions:{},panelLayoutOptions:{}}]}},z=(l,n,m,t)=>{const r=U(l);if(!r)return null;const a=we(n),u=Te(t),v=[];v.push($("receiptModule","title",i(N),i(3),a,i(j),m,9,!0));let d=3+D;return r.basicFields.forEach(s=>{s.type==="longText"?(v.push(ne("receiptModule",s.key,i(N),i(d),a,i(j*2),s.label,9)),d+=D*2):(v.push($("receiptModule",s.key,i(N),i(d),a,i(j),s.label,9,!1)),d+=D)}),u!==80&&r.listFields.forEach(s=>{const T=s.columns.reduce((_,P)=>_+(P.width||100),0),c=s.columns.map(_=>({key:_.key,label:_.label,width:(_.width||100)*(a/T),align:_.align}));v.push(le("receiptModule",s.key,i(N),i(d),a,i(13),s.label,c,8,!0)),d+=13+D}),{panels:[{index:0,name:1,paperType:t,height:u,width:n,paperHeader:0,paperFooter:i(u),printElements:v,paperNumberContinue:!0,watermarkOptions:{},panelLayoutOptions:{}}]}},We=(l,n)=>z("purchase",l,"采购单",n),Ne=(l,n)=>z("order",l,"销售单",n),Re=(l,n)=>z("transfer",l,"调拨单",n),qe=(l,n)=>z("inventory",l,"盘点单",n),Fe=(l,n)=>{if(n.startsWith("receipt_")){const r=Ce(n);switch(l){case"purchase":return We(r,n);case"order":return Ne(r,n);case"transfer":return Re(r,n);case"inventory":return qe(r,n);default:return null}}const t={purchase:"采购单",order:"销售单",transfer:"调拨单",inventory:"盘点单"}[l];return t?Be(l,t,n):null},Se={style:{height:"100%",display:"flex",overflow:"hidden"}},Le={style:{width:"260px","border-right":"1px solid #eee",padding:"8px",overflow:"auto"}},Ve={key:0,style:{margin:"16px 0 8px"}},De={class:"common-data-grid"},Oe=["tid"],$e=["tid"],ze=["tid"],Ge=["tid"],Je=["tid"],je=["tid"],Ue=["tid"],Qe=["tid"],Ye={style:{flex:"1",width:"60%",display:"flex","flex-direction":"column"}},Ke={class:"designer-toolbar"},Xe={class:"left"},Ze={class:"right"},et=me({__name:"Index",setup(l){window.$=H,window.jQuery=H;const n=pe(),m=ge();let t=null;const r=w(""),a=w(""),u=w("A4"),v=w(""),d=w(2),s=w([]),p=w([]),T=G(()=>u.value.startsWith("receipt_")),c=G(()=>T.value?"receiptModule":"defaultModule"),_=G({get:()=>d.value===1,set:h=>{d.value=h?1:2}});ve(async()=>{let h={};if(s.value=ye(),n.query.id&&(v.value=n.query.id,n.query.content)){r.value=n.query.title||"",a.value=n.query.template_type||"",d.value=n.query.is_default?Number(n.query.is_default):2;try{console.log("route.query.content",n.query.content),h=JSON.parse(n.query.content),console.log("contentJson",h)}catch(e){console.error("解析传递的content失败:",e)}}F(),J(()=>{R()}),t=new L.hiprint.PrintTemplate({template:h,settingContainer:"#PrintElementOptionSetting",paginationContainer:".hiprint-printPagination",history:!0,dataMode:1,onDataChanged:(e,E)=>{console.log(e,E)},onUpdateError:e=>{console.log(e)}}),t.design("#hiprint-printTemplate")});const P=()=>{if(t)try{t.rotatePaper()}catch{}},R=()=>{L.hiprint.init({providers:[new xe(a.value)]}),setTimeout(()=>{L.hiprint.PrintElementTypeManager.buildByHtml(H(".ep-draggable-item")),console.log("初始化打印元素，页面类型:",a.value),console.log("可用字段:",p.value),console.log("拖拽元素数量:",H(".ep-draggable-item").length),console.log("动态字段元素:",H('.ep-draggable-item[tid*="defaultModule"]').length)},100)},q=()=>{if(!t||!a.value||v.value)return;const h=Fe(a.value,u.value);h&&(t.clear(),setTimeout(()=>{const e=JSON.parse(JSON.stringify(h));t.update(e),console.log("加载预设模板:",a.value,u.value)},100))},x=()=>{F(),J(()=>{R(),q()})},F=()=>{if(a.value){const h=U(a.value);h?p.value=[...h.basicFields,...h.listFields]:p.value=[]}else p.value=[]},ae=h=>({text:"sv-text",longText:"sv-longText",currency:"sv-currency",datetime:"sv-datetime",number:"sv-number",table:"sv-table"})[h]||"sv-text",oe=async h=>{if(!t)return;if(!r.value){B.error("请输入模板名称");return}if(!a.value){B.error("请选择页面类型");return}const e=t.getJson();try{const E={title:r.value,template_type:a.value,content:JSON.stringify(e),status:1,is_default:d.value};v.value?(await Z.edit("template/template",v.value,{},E),B.success("模板更新成功")):(await Z.add("template/template",E),B.success("模板保存成功"))}catch(E){console.error("保存模板失败:",E),B.error("保存失败")}},re=()=>{t&&t.clear()},se=()=>{m.go(-1)},ie=()=>{if(t)try{if(u.value.startsWith("241mm"))switch(u.value){case"241mm_full":t.setPaper(241,280);break;case"241mm_half":t.setPaper(241,140);break;case"241mm_third":t.setPaper(241,93);break}else if(u.value.startsWith("receipt_"))switch(u.value){case"receipt_58":t.setPaper(58,80);break;case"receipt_80":t.setPaper(80,80);break;case"receipt_80_long":t.setPaper(80,150);break}else switch(u.value){case"A4":t.setPaper(210,297);break;case"A3":t.setPaper(297,420);break;case"A5":t.setPaper(148,210);break}J(()=>{setTimeout(()=>{L.hiprint.PrintElementTypeManager.buildByHtml(H(".ep-draggable-item")),console.log("纸张类型变化，重新构建拖拽元素，当前模块:",c.value)},100)}),q()}catch(h){console.error("设置纸张规格失败:",h)}};return(h,e)=>{const E=I("el-input"),y=I("el-option"),Q=I("el-select"),ue=I("el-switch"),S=I("el-button");return k(),M("div",Se,[o("div",Le,[a.value&&p.value.length>0?(k(),M("h4",Ve,"常用数据")):Y("",!0),o("div",De,[a.value&&p.value.length>0?(k(!0),M(K,{key:0},X(p.value,b=>(k(),M("div",{key:b.key,class:"ep-draggable-item item",tid:`${c.value}.${b.key.replace(/\./g,"_")}`},[o("i",{class:he(["iconfont",ae(b.type)])},null,2),o("span",null,be(b.label),1)],8,Oe))),128)):Y("",!0)]),e[12]||(e[12]=o("h4",{style:{margin:"0 0 8px"}},"常规元素",-1)),o("div",{class:"ep-draggable-item item",tid:`${c.value}.text`},e[5]||(e[5]=[o("i",{class:"iconfont sv-text"},null,-1),o("span",null,"文本",-1)]),8,$e),o("div",{class:"ep-draggable-item item",tid:`${c.value}.longText`},e[6]||(e[6]=[o("i",{class:"iconfont sv-longText"},null,-1),o("span",null,"长文本",-1)]),8,ze),o("div",{class:"ep-draggable-item item",tid:`${c.value}.image`},e[7]||(e[7]=[o("i",{class:"iconfont sv-image"},null,-1),o("span",null,"图片",-1)]),8,Ge),o("div",{class:"ep-draggable-item item",tid:`${c.value}.qrcode`},e[8]||(e[8]=[o("i",{class:"iconfont sv-qrcode"},null,-1),o("span",null,"二维码",-1)]),8,Je),e[13]||(e[13]=o("h4",{style:{margin:"16px 0 8px"}},"辅助元素",-1)),o("div",{class:"ep-draggable-item item",tid:`${c.value}.hline`},e[9]||(e[9]=[o("i",{class:"iconfont sv-hline"},null,-1),o("span",null,"横线",-1)]),8,je),o("div",{class:"ep-draggable-item item",tid:`${c.value}.vline`},e[10]||(e[10]=[o("i",{class:"iconfont sv-vline"},null,-1),o("span",null,"竖线",-1)]),8,Ue),o("div",{class:"ep-draggable-item item",tid:`${c.value}.rect`},e[11]||(e[11]=[o("i",{class:"iconfont sv-rect"},null,-1),o("span",null,"矩形",-1)]),8,Qe)]),o("div",Ye,[o("div",Ke,[o("div",Xe,[f(E,{modelValue:r.value,"onUpdate:modelValue":e[0]||(e[0]=b=>r.value=b),placeholder:"请输入模版名称",size:"small",style:{width:"200px","margin-right":"8px"}},null,8,["modelValue"]),f(Q,{modelValue:a.value,"onUpdate:modelValue":e[1]||(e[1]=b=>a.value=b),placeholder:"请选择页面类型",size:"small",style:{width:"150px","margin-right":"8px"},onChange:x},{default:A(()=>[(k(!0),M(K,null,X(s.value,b=>(k(),fe(y,{key:b.id,label:b.name,value:b.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(Q,{modelValue:u.value,"onUpdate:modelValue":e[2]||(e[2]=b=>u.value=b),size:"small",style:{width:"150px","margin-right":"8px"},onChange:ie},{default:A(()=>[f(y,{label:"A4(210*297mm)",value:"A4"}),f(y,{label:"A3(297*420mm)",value:"A3"}),f(y,{label:"A5(148*210mm)",value:"A5"}),f(y,{label:"241mm整张(241*280mm)",value:"241mm_full"}),f(y,{label:"241mm二等分(241*140mm)",value:"241mm_half"}),f(y,{label:"241mm三等分(241*93mm)",value:"241mm_third"}),f(y,{label:"小票58mm(58*80mm)",value:"receipt_58"}),f(y,{label:"小票80mm(80*80mm)",value:"receipt_80"}),f(y,{label:"小票80mm长(80*150mm)",value:"receipt_80_long"})]),_:1},8,["modelValue"]),f(ue,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=b=>_.value=b),size:"small",style:{"margin-right":"8px"},"active-text":"设为默认","inactive-text":""},null,8,["modelValue"]),f(S,{size:"small",onClick:P},{default:A(()=>e[14]||(e[14]=[V("旋转")])),_:1})]),o("div",Ze,[f(S,{size:"small",onClick:se},{default:A(()=>e[15]||(e[15]=[V("返回")])),_:1}),f(S,{size:"small",onClick:re},{default:A(()=>e[16]||(e[16]=[V("清空")])),_:1}),f(S,{size:"small",onClick:e[4]||(e[4]=b=>oe())},{default:A(()=>e[17]||(e[17]=[V("保存")])),_:1})])]),e[18]||(e[18]=o("div",{style:{flex:"1",height:"100%",overflow:"auto",padding:"20px","text-align":"center",background:"#f5f5f5"}},[o("div",{id:"hiprint-printTemplate",class:"designer-canvas"})],-1))]),e[19]||(e[19]=o("div",{id:"PrintElementOptionSetting",style:{width:"300px","border-left":"1px solid #eee",padding:"8px",overflow:"auto"}},null,-1))])}}}),nt=_e(et,[["__scopeId","data-v-2320fc35"]]);export{nt as default};
