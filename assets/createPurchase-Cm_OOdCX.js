import{d as Je,l as ce,r as $,o as Ze,w as Ce,a as N,j as Q,b as d,h as u,e as i,g as r,I as Be,k as V,c as b,F as te,i as _e,t as w,q as Me,p as Tl,D as R,A as le,y as rl,_ as Xe,m as dl,u as Fl,G as Il,s as L,Y as De,J as ee,V as Dl,T as Bl,H as El,Z as Ll,n as Ee,E as de}from"./index-BUVdxLJQ.js";import{_ as zl}from"./ProductPriceHistoryDialog.vue_vue_type_script_setup_true_lang-ICVGsjnp.js";import{P as Rl,S as Ml}from"./SupplierHistoryDialog-BHcPeZEv.js";const Al={class:"drawer-wrapper"},Hl={class:"drawer-header"},Kl={class:"drawer-body"},jl={class:"category-pane"},Wl={key:0,class:"loading-text"},Gl=["onClick"],Ol={class:"content-pane"},Yl={key:0,class:"loading-text"},Jl={key:1,class:"card-grid"},Zl=["onClick"],Xl={class:"checkbox-container"},et={class:"product-img"},lt=["src","alt"],tt={class:"name-row"},at={class:"name"},ot={class:"sub"},nt={class:"sub"},st={class:"sub"},ut={class:"sub"},it={class:"sub"},rt={class:"pagination-row"},dt={class:"drawer-footer"},ct={class:"tip"},mt={class:"actions"},il=12,pt=Je({__name:"ProductSelectorDrawer",props:{modelValue:{type:Boolean},selectedProducts:{}},emits:["update:modelValue","confirm","select","unselect"],setup(Le,{expose:$e,emit:Ve}){const Z=Le,M=Ve,_=ce({get:()=>Z.modelValue,set:m=>M("update:modelValue",m)}),A=$(""),se=$(""),g=$(""),K=$(""),ue=$(!1),X=$(!1);function ye(m){return m.goodsWarehouse&&m.goodsWarehouse.length>0?Number(m.goodsWarehouse[0].stock||0):Number(m.stock||0)}const j=$([]),Ue=m=>{if(!m||m.length===0)return[];if(m.some(U=>U.children&&U.children.length>0))return m.map(U=>({...U,children:U.children||[]}));const P={},G=[];return m.forEach(U=>{P[U.id]={...U,children:[]}}),m.forEach(U=>{const n=U.p_id;n&&n!==0&&P[n]?(P[n].children||(P[n].children=[]),P[n].children.push(P[U.id])):G.push(P[U.id])}),G},qe=async()=>{try{ue.value=!0;const m=await le.list("goods_cate",{page:1,limit:9999});if(m.code===1e4){const k=m.data||[];j.value=Ue(k),j.value.length>0&&W(j.value[0])}}catch(m){console.error("获取商品分类失败:",m)}finally{ue.value=!1}},Ne=$([]),y=$(0),c=$(new Set),D=ce(()=>Ne.value.filter(m=>c.value.has(m.id))),C=async()=>{try{X.value=!0;const m={page:T.value,limit:il};A.value.trim()&&(m.keyword=A.value.trim()),g.value&&(m.cate_id=g.value);const k=await le.list("goods",m);k.code===1e4&&(Ne.value=k.data||[],y.value=k.total||0)}catch(m){console.error("获取商品失败:",m)}finally{X.value=!1}},T=$(1),z=ce(()=>Ne.value);function Y(){T.value=1,C()}function W(m){se.value=m.name,g.value=String(m.id);const k=j.value.find(P=>{var G;return(G=P.children)==null?void 0:G.some(U=>U.id===m.id)});k?K.value=`c-${k.id}-${m.id}`:K.value=`c-${m.id}`,T.value=1,C()}async function J(m){if(c.value.has(m.id))try{await rl.confirm(`确定要取消选中商品"${m.name}"吗？`,"确认取消选中",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),c.value.delete(m.id),M("unselect",m)}catch{}else M("select",m)}function ae(m){var G,U,n;const k=[];let P=Number(m.stock||0);if(m.b_ratio>0&&P>=m.b_ratio&&((G=m.b_unit)!=null&&G.name)){const oe=Math.floor(P/m.b_ratio);oe>0&&(k.push(`${oe}${m.b_unit.name}`),P=P%m.b_ratio)}if(m.c_ratio>0&&P>=m.c_ratio&&((U=m.c_unit)!=null&&U.name)){const oe=Math.floor(P/m.c_ratio);oe>0&&(k.push(`${oe}${m.c_unit.name}`),P=P%m.c_ratio)}return P>0&&k.push(`${P}${m.unit.name}`),k.length>0?k.join(" "):`0${((n=m.unit)==null?void 0:n.name)||""}`}function me(){_.value=!1}function Pe(){D.value.length>0&&M("confirm",D.value),_.value=!1}function ge(m){c.value.has(m.id)&&(c.value.delete(m.id),M("unselect",m))}return $e({unselectProduct:ge}),Ze(()=>{qe(),C()}),Ce(()=>Z.selectedProducts,m=>{m&&m.length>0?c.value=new Set(m.map(k=>k.id)):c.value.clear()},{immediate:!0}),Ce(()=>Z.modelValue,m=>{m&&Z.selectedProducts&&Z.selectedProducts.length>0&&(c.value=new Set(Z.selectedProducts.map(k=>k.id)))}),(m,k)=>{const P=N("el-button"),G=N("el-input"),U=N("el-menu-item"),n=N("el-sub-menu"),oe=N("el-menu"),S=N("el-checkbox"),he=N("el-tag"),be=N("el-pagination"),xe=N("el-drawer");return d(),Q(xe,{modelValue:_.value,"onUpdate:modelValue":k[3]||(k[3]=f=>_.value=f),"with-header":!1,size:"80%","append-to-body":""},{default:u(()=>[i("div",Al,[i("div",Hl,[k[5]||(k[5]=i("span",null,"选择商品",-1)),r(G,{modelValue:A.value,"onUpdate:modelValue":k[0]||(k[0]=f=>A.value=f),placeholder:"搜索编号/名称/条码",class:"search-input",clearable:"",onKeyup:Be(Y,["enter","native"])},{append:u(()=>[r(P,{type:"primary",onClick:Y},{default:u(()=>k[4]||(k[4]=[V("搜索")])),_:1})]),_:1},8,["modelValue"])]),i("div",Kl,[i("div",jl,[k[6]||(k[6]=i("div",{class:"category-title"},"商品分类",-1)),ue.value?(d(),b("div",Wl,"加载中...")):(d(),Q(oe,{key:1,class:"category-menu","default-active":K.value},{default:u(()=>[(d(!0),b(te,null,_e(j.value,(f,ke)=>(d(),b(te,{key:f.id||ke},[f.children&&f.children.length>0?(d(),Q(n,{key:0,index:`c-${f.id}`},{title:u(()=>[i("span",{class:"category-title-clickable",onClick:Me(ie=>W(f),["stop"])},w(f.name),9,Gl)]),default:u(()=>[(d(!0),b(te,null,_e(f.children,(ie,Qe)=>(d(),Q(U,{key:ie.id||Qe,index:`c-${f.id}-${ie.id}`,onClick:Te=>W(ie)},{default:u(()=>[V(w(ie.name),1)]),_:2},1032,["index","onClick"]))),128))]),_:2},1032,["index"])):(d(),Q(U,{key:1,index:`c-${f.id}`,onClick:ie=>W(f)},{default:u(()=>[V(w(f.name),1)]),_:2},1032,["index","onClick"]))],64))),128))]),_:1},8,["default-active"]))]),i("div",Ol,[X.value?(d(),b("div",Yl,"加载商品中...")):(d(),b("div",Jl,[(d(!0),b(te,null,_e(z.value,f=>(d(),b("div",{key:f.id,class:Tl(["product-card",{selected:c.value.has(f.id)}]),onClick:ke=>J(f)},[i("div",Xl,[r(S,{"model-value":c.value.has(f.id),"onUpdate:modelValue":ke=>J(f),onClick:k[1]||(k[1]=Me(()=>{},["stop"]))},null,8,["model-value","onUpdate:modelValue"])]),i("div",et,[i("img",{src:f.img,alt:f.name},null,8,lt)]),i("div",tt,[i("span",at,w(f.name),1),f.is_quan?(d(),Q(he,{key:0,type:"primary",size:"small"},{default:u(()=>k[7]||(k[7]=[V("定")])),_:1})):R("",!0)]),i("div",ot,"存："+w(ae(f)),1),f.is_quan?(d(),b(te,{key:0},[i("div",nt,"总："+w(ye(f))+w(f.unit.name),1),i("div",st," 规格："+w(f==null?void 0:f.spec.name),1),i("div",ut," 价格： "+w(f==null?void 0:f.unit.name)+"/"+w(f==null?void 0:f.price)+", "+w(f==null?void 0:f.b_unit.name)+"/"+w(f==null?void 0:f.b_price),1),i("div",it," 条形码："+w(f==null?void 0:f.unit_barcode),1)],64)):R("",!0)],10,Zl))),128))])),i("div",rt,[r(be,{background:"",layout:"prev, pager, next",total:y.value,"page-size":il,"current-page":T.value,"onUpdate:currentPage":k[2]||(k[2]=f=>T.value=f),onCurrentChange:C},null,8,["total","current-page"])])])]),i("div",dt,[i("div",ct,"已选 "+w(c.value.size)+" 项",1),i("div",mt,[r(P,{onClick:me},{default:u(()=>k[8]||(k[8]=[V("取消")])),_:1}),r(P,{type:"primary",onClick:Pe},{default:u(()=>k[9]||(k[9]=[V("确认")])),_:1})])])])]),_:1},8,["modelValue"])}}}),vt=Xe(pt,[["__scopeId","data-v-d44da0b4"]]),ft={key:0,class:"header-sub"},_t={key:1,class:"form-grid"},yt={key:0,class:"group-title"},gt={key:1,class:"row"},bt={class:"label"},xt={key:2,class:"row"},kt={class:"label"},$t={class:"row"},ht={class:"label"},wt={class:"row"},Vt={class:"label"},Nt={key:2,class:"form-grid"},Pt={class:"row"},St={class:"label"},Ct={class:"row"},Ut={class:"label"},qt={key:0,class:"row"},Qt={class:"label"},Tt=Je({__name:"ProductQuantityDialog",props:{modelValue:{type:Boolean},product:{}},emits:["update:modelValue","confirm","history","cancel"],setup(Le,{emit:$e}){Ze(()=>{console.log("ProductQuantityDialog mounted",Ve.product)});const Ve=Le,Z=$e,M=ce({get:()=>Ve.modelValue,set:y=>Z("update:modelValue",y)});Ce(M,y=>{y&&K()});const _=ce(()=>Ve.product),A=ce(()=>{var y;return Number((y=_.value)==null?void 0:y.is_quan)===1}),se=ce(()=>{var Y,W,J,ae;const y=_.value;if(!y)return"";const c=[],D=((Y=y.unit)==null?void 0:Y.name)||"小单位",C=(J=(W=y==null?void 0:y.goodsWarehouse)==null?void 0:W[0])==null?void 0:J.stock;let T=Number(C??y.stock??0);const z=Number(y.b_ratio)||0;if(z>0&&T>=z&&((ae=y.b_unit)!=null&&ae.name)){const me=Math.floor(T/z);me>0&&(c.push(`${me}${y.b_unit.name}`),T=T%z)}return T>0&&c.push(`${T}${D}`),c.length>0?c.join(" "):`0${D}`}),g=dl({small:{qty:"",price:""},large:{qty:"",price:""},subUnit:""});function K(){var y,c;g.small.qty="",g.small.price=((y=_.value)==null?void 0:y.cai_price)||"",g.large.qty="",g.large.price=((c=_.value)==null?void 0:c.cai_b_price)||"",g.subUnit=""}function ue(){_.value&&Z("cancel",_.value),K(),M.value=!1}function X(){const y=j(),c=Ue(),D=Ne();_.value&&Z("confirm",{product:_.value,amount:c,quantityText:y,...D}),K(),M.value=!1}async function ye(){var y;if((y=_.value)!=null&&y.id)try{const c=await le.historyPrice(Number(_.value.id));console.log("历史进价数据:",c),Z("history",{product:_.value,data:c})}catch(c){console.error("获取历史进价失败:",c)}}function j(){var y,c,D,C,T,z;if(A.value){const Y=[];return g.large.qty&&((c=(y=_.value)==null?void 0:y.b_unit)!=null&&c.name)&&Y.push(`${g.large.qty}${_.value.b_unit.name}`),g.small.qty&&Y.push(`${g.small.qty}${((C=(D=_.value)==null?void 0:D.unit)==null?void 0:C.name)||"小单位"}`),Y.join("")||""}return g.small.qty?`${g.small.qty}${((z=(T=_.value)==null?void 0:T.unit)==null?void 0:z.name)||"瓶"}`:""}function Ue(){const y=c=>c?Number(c):0;if(A.value){const c=y(g.small.qty)*y(g.small.price),D=y(g.large.qty)*y(g.large.price);return+(c+D).toFixed(2)}return+(y(g.small.qty)*y(g.small.price)).toFixed(2)}function qe(){var T;const y=z=>z?Number(z):0,c=Number((T=_.value)==null?void 0:T.b_ratio)||0,D=y(g.small.qty),C=y(g.large.qty)*(c||0);return D+C}function Ne(){var T;const y=z=>z?Number(z):0,c=A.value?qe():y(g.small.qty),D=Ue();let C;return A.value?(console.log(_.value,"cai_price"),C=y((T=_.value)==null?void 0:T.cai_price)||(c>0?+(D/c).toFixed(4):void 0),console.log(C,"unitPrice-1")):(C=y(g.small.price)||void 0,console.log(C,"unitPrice-2")),{smallQty:y(g.small.qty)||void 0,largeQty:y(g.large.qty)||void 0,smallPrice:y(g.small.price)||void 0,largePrice:y(g.large.price)||void 0,totalQtySmallUnits:c||void 0,unitPrice:C,f_stock:y(g.subUnit)||void 0}}return(y,c)=>{var z,Y;const D=N("el-button"),C=N("el-input"),T=N("el-dialog");return d(),Q(T,{modelValue:M.value,"onUpdate:modelValue":c[7]||(c[7]=W=>M.value=W),title:((z=_.value)==null?void 0:z.name)||((Y=_.value)==null?void 0:Y.productName)||"数量",width:"600px","append-to-body":"","destroy-on-close":""},{footer:u(()=>[r(D,{onClick:ue},{default:u(()=>c[13]||(c[13]=[V("取消")])),_:1}),r(D,{type:"primary",onClick:X},{default:u(()=>c[14]||(c[14]=[V("确认")])),_:1})]),default:u(()=>{var W,J,ae,me,Pe,ge,m,k,P,G,U,n,oe,S,he,be,xe,f,ke,ie,Qe,Te,Se,ne;return[_.value?(d(),b("div",ft,[V(" 库存："+w(se.value)+" ",1),r(D,{type:"primary",link:"",class:"ml10",onClick:ye},{default:u(()=>c[8]||(c[8]=[V("历史进价")])),_:1})])):R("",!0),A.value?(d(),b("div",_t,[(W=_.value)!=null&&W.b_unit?(d(),b("div",yt,"大单位")):R("",!0),(J=_.value)!=null&&J.b_unit?(d(),b("div",gt,[i("div",bt,"数量（"+w(((me=(ae=_.value)==null?void 0:ae.b_unit)==null?void 0:me.name)||"大单位")+"）",1),r(C,{modelValue:g.large.qty,"onUpdate:modelValue":c[0]||(c[0]=I=>g.large.qty=I),placeholder:`数量(${((ge=(Pe=_.value)==null?void 0:Pe.b_unit)==null?void 0:ge.name)||"大单位"})`,class:"qty-input"},{append:u(()=>{var I,pe;return[V(w(((pe=(I=_.value)==null?void 0:I.b_unit)==null?void 0:pe.name)||"大单位"),1)]}),_:1},8,["modelValue","placeholder"])])):R("",!0),(m=_.value)!=null&&m.b_unit?(d(),b("div",xt,[i("div",kt,"单价（元/"+w(((P=(k=_.value)==null?void 0:k.b_unit)==null?void 0:P.name)||"大单位")+"）",1),r(C,{modelValue:g.large.price,"onUpdate:modelValue":c[1]||(c[1]=I=>g.large.price=I),placeholder:`单价(元/${((U=(G=_.value)==null?void 0:G.b_unit)==null?void 0:U.name)||"大单位"})`,class:"price-input"},{append:u(()=>c[9]||(c[9]=[V("元")])),_:1},8,["modelValue","placeholder"])])):R("",!0),c[11]||(c[11]=i("div",{class:"group-title"},"小单位",-1)),i("div",$t,[i("div",ht,"数量（"+w(((oe=(n=_.value)==null?void 0:n.unit)==null?void 0:oe.name)||"小单位")+"）",1),r(C,{modelValue:g.small.qty,"onUpdate:modelValue":c[2]||(c[2]=I=>g.small.qty=I),placeholder:`数量(${((he=(S=_.value)==null?void 0:S.unit)==null?void 0:he.name)||"小单位"})`,class:"qty-input"},{append:u(()=>{var I,pe;return[V(w(((pe=(I=_.value)==null?void 0:I.unit)==null?void 0:pe.name)||"小单位"),1)]}),_:1},8,["modelValue","placeholder"])]),i("div",wt,[i("div",Vt,"单价（元/"+w(((xe=(be=_.value)==null?void 0:be.unit)==null?void 0:xe.name)||"小单位")+"）",1),r(C,{modelValue:g.small.price,"onUpdate:modelValue":c[3]||(c[3]=I=>g.small.price=I),placeholder:`单价(元/${((ke=(f=_.value)==null?void 0:f.unit)==null?void 0:ke.name)||"小单位"})`,class:"price-input"},{append:u(()=>c[10]||(c[10]=[V("元")])),_:1},8,["modelValue","placeholder"])])])):(d(),b("div",Nt,[i("div",Pt,[i("div",St,"数量（"+w(((Qe=(ie=_.value)==null?void 0:ie.unit)==null?void 0:Qe.name)||"瓶")+"）",1),r(C,{modelValue:g.small.qty,"onUpdate:modelValue":c[4]||(c[4]=I=>g.small.qty=I),placeholder:"请输入",class:"qty-input"},{append:u(()=>{var I,pe;return[V(w(((pe=(I=_.value)==null?void 0:I.unit)==null?void 0:pe.name)||"瓶"),1)]}),_:1},8,["modelValue"])]),i("div",Ct,[i("div",Ut,"单价（元/"+w(((Se=(Te=_.value)==null?void 0:Te.unit)==null?void 0:Se.name)||"瓶")+"）",1),r(C,{modelValue:g.small.price,"onUpdate:modelValue":c[5]||(c[5]=I=>g.small.price=I),placeholder:"请输入",class:"price-input"},{append:u(()=>c[12]||(c[12]=[V("元")])),_:1},8,["modelValue"])]),(ne=_.value)!=null&&ne.f_unit?(d(),b("div",qt,[i("div",Qt,"副单位（"+w(_.value.f_unit)+"）",1),r(C,{modelValue:g.subUnit,"onUpdate:modelValue":c[6]||(c[6]=I=>g.subUnit=I),placeholder:"请输入",class:"subunit-input"},{append:u(()=>[V(w(_.value.f_unit),1)]),_:1},8,["modelValue"])])):R("",!0)]))]}),_:1},8,["modelValue","title"])}}}),Ft=Xe(Tt,[["__scopeId","data-v-712b14a4"]]),It={class:"page"},Dt={class:"padding10"},Bt={class:"page-header"},Et={class:"header-controls"},Lt={class:"header-item"},zt={class:"header-item"},Rt={style:{"font-size":"13px"}},Mt={class:"header-item",style:{"margin-left":"10px"}},At={class:"header-item"},Ht={class:"section",style:{"margin-bottom":"24px"}},Kt={class:"section-content"},jt={style:{display:"flex"}},Wt={class:"form-item"},Gt={class:"form-item",style:{margin:"0 14px"}},Ot={class:"supplier-select"},Yt={class:"form-item"},Jt={class:"section mb10 padding10",style:{"margin-top":"10px"}},Zt={class:"section-content"},Xt={style:{"margin-bottom":"10px"}},ea=["onMouseenter"],la={key:0,class:"index-text"},ta={key:1,class:"button-group"},aa={key:0,class:"clickable-text"},oa={key:0},na={key:0,class:"quantity-input-cell"},sa=["onClick"],ua={key:0},ia={key:0,class:"quantity-input-cell"},ra=["onClick"],da={key:0},ca={key:0,class:"quantity-input-cell"},ma=["onClick"],pa={key:0},va={class:"quantity-cell"},fa={key:0,class:"quantity-input-cell"},_a=["onClick"],ya={key:0},ga={key:0,class:"quantity-input-cell"},ba=["onClick"],xa={key:0},ka={key:0,class:"amount-text"},$a={class:"section mb10 padding10"},ha={class:"section-content"},wa={class:"form-item"},Va={class:"form-item"},Na={class:"flex-row"},Pa={class:"form-item"},Sa={class:"form-item"},Ca={class:"form-item"},Ua={style:{width:"100%"}},qa=Je({__name:"createPurchase",setup(Le){const $e=Fl(),Ve=Il(),Z=t=>{const{columns:e,data:o}=t;let s=0;return o.forEach(v=>{s+=Number(v.amount||0)}),e.map(v=>{var p;return v.type==="index"?"合计":(p=v.label)!=null&&p.includes("金额(元)")?s.toFixed(2):""})},M=$(-1),_=$(""),A=$(-1),se=$(""),g=$(-1),K=$(""),ue=$(-1),X=$(""),ye=$(-1),j=$(""),Ue=(t,e)=>{var o;((o=t.product)==null?void 0:o.id)==null||!t.largePrice||(ye.value=e,j.value=String(t.largePrice??0),Ee(()=>{const s=document.getElementById(`large-price-input-${e}`);s==null||s.focus()}))},qe=t=>{var F;if(!j.value||j.value===""){ye.value=-1;return}const e=S.value[t],o=parseFloat(j.value);if(isNaN(o)||o<0){de.error("请输入有效的单价"),ye.value=-1;return}e.largePrice=o;const s=Number(e.smallPrice??((F=e.product)==null?void 0:F.price)??0),h=Number(e.largePrice),v=Number(e.smallQty||0),p=Number(e.largeQty||0);let q=+(v*s+p*h).toFixed(2);Number(e.saleTypeId)===2&&(q=-Math.abs(q)),e.amount=q,ye.value=-1,j.value=""},Ne=(t,e)=>{var o;((o=t.product)==null?void 0:o.id)==null||!t.largePrice||(ue.value=e,X.value=String(t.largeQty??0),Ee(()=>{const s=document.getElementById(`large-qty-input-${e}`);s==null||s.focus()}))},y=t=>{var F,H,O;if(!X.value||X.value===""){ue.value=-1;return}const e=S.value[t],o=parseFloat(X.value);if(isNaN(o)||o<=0){de.error("请输入有效的数量"),ue.value=-1;return}e.largeQty=o,e.smallQty&&((F=e.product)!=null&&F.b_ratio)?e.totalQtySmallUnits=o*e.product.b_ratio+e.smallQty:(H=e.product)!=null&&H.b_ratio&&(e.totalQtySmallUnits=o*e.product.b_ratio);const s=Number(e.smallPrice??((O=e.product)==null?void 0:O.price)??0),h=Number(e.largePrice),v=Number(e.smallQty||0),p=Number(e.largeQty);let q=+(v*s+p*h).toFixed(2);Number(e.saleTypeId)===2&&(q=-Math.abs(q)),e.amount=q,ue.value=-1,X.value=""},c=(t,e)=>{var o,s;((o=t.product)==null?void 0:o.id)==null||!((s=t.product)!=null&&s.f_unit)||(g.value=e,K.value=String(t.f_stock??0),Ee(()=>{const h=document.getElementById(`f-stock-input-${e}`);h==null||h.focus()}))},D=t=>{if(!K.value||K.value===""){g.value=-1;return}const e=S.value[t],o=parseFloat(K.value);if(isNaN(o)||o<0){de.error("请输入有效的副单位数量"),g.value=-1;return}e.f_stock=o,g.value=-1,K.value=""},C=(t,e)=>{var o;((o=t.product)==null?void 0:o.id)!=null&&(A.value=e,se.value=String(t.unitPrice??t.price??t.product.price??0),Ee(()=>{const s=document.getElementById(`small-price-input-${e}`);s==null||s.focus()}))},T=t=>{var F;if(!se.value||se.value===""){A.value=-1;return}const e=S.value[t],o=parseFloat(se.value);if(isNaN(o)||o<0){de.error("请输入有效的单价"),A.value=-1;return}e.unitPrice=o,e.smallPrice=o;const s=Number(e.smallPrice),h=Number(e.largePrice??((F=e.product)==null?void 0:F.b_price)??0),v=Number(e.smallQty||0),p=Number(e.largeQty||0);let q=+(v*s+p*h).toFixed(2);Number(e.saleTypeId)===2&&(q=-Math.abs(q)),e.amount=q,A.value=-1,se.value=""},z=t=>{var H,O,B,ve,fe;if(!_.value||_.value===""){M.value=-1;return}const e=S.value[t],o=((O=(H=e.product)==null?void 0:H.unit)==null?void 0:O.name)||"瓶",s=parseFloat(_.value);if(isNaN(s)||s<=0){de.error("请输入有效的数量"),M.value=-1;return}e.quantityText=`${s}${o}`,e.smallQty=s;const h=Number(e.smallPrice??((B=e.product)==null?void 0:B.price)??0),v=Number(e.largePrice??((ve=e.product)==null?void 0:ve.b_price)??0),p=Number(e.smallQty),q=Number(e.largeQty||0);let F=+(p*h+q*v).toFixed(2);Number(e.saleTypeId)===2&&(F=-Math.abs(F)),e.amount=F,e.largeQty&&((fe=e.product)!=null&&fe.b_ratio)?e.totalQtySmallUnits=e.largeQty*e.product.b_ratio+s:e.totalQtySmallUnits=s,M.value=-1,_.value=""},Y=(t,e)=>{var o;console.log(t),((o=t.product)==null?void 0:o.id)!=null&&(M.value=e,console.log(t.smallQty),_.value=t.smallQty,console.log(_.value),Ee(()=>{const s=document.getElementById(`quantity-input-${e}`);s==null||s.focus()}))},W=$(null),J=$(!1),ae=$(null),me=$([]),Pe=$([]),ge=$([]),m=async()=>{try{const t=await le.staffList({page:1,limit:99999});t.code===1e4&&(me.value=t.data||[])}catch(t){console.error("获取员工列表失败:",t)}},k=async()=>{try{const t=await le.warehouseList({page:1,limit:99999});t.code===1e4&&(Pe.value=t.data||[])}catch(t){console.error("获取仓库列表失败:",t)}},P=async()=>{try{const t=await le.supplierList({page:1,limit:99999});t.code===1e4&&(ge.value=t.data||[])}catch(t){console.error("获取供应商列表失败:",t)}},G=async t=>{try{const e=await le.purchaseDetail(t);if(e.code===1e4){const o=e.data;if(n.handler=o.staff_id||"",n.warehouse=o.warehouse_id||"",n.supplier=o.supplier_id||"",n.remark=o.describe||"",n.documentNumber=o.order_sn||"",n.businessDate=o.time||"",n.purchaseTotal=o.order_price,n.payableTotal=o.order_price,n.images=o.file?o.file.split(",").filter(Boolean):[],console.log(1),o.purchaseGoods&&o.purchaseGoods.length>0&&(S.value=o.purchaseGoods.map(s=>{var h;return{product:{id:s.goods_id,name:s.goods_name,number:s.goods_number||"",stock:s.stock||0,unit:s.unit||{name:"件"},c_unit:s.c_unit,b_unit:s.b_unit,f_unit:s.f_unit||null,f_stock:s.f_stock||0,is_quan:s.is_quan||!1},quantityText:`${s.num}${((h=s.unit)==null?void 0:h.name)||"件"}`,amount:s.price||0,totalQtySmallUnits:s.num||0,smallQty:s.num||0,f_stock:s.f_stock||0,itemRemark:s.mark||""}})),console.log(2),o.costs&&o.costs.length>0){ne.value=o.costs.map(h=>{var v;return{item:((v=h.other_unit_id)==null?void 0:v.toString())||"",amount:(h.price||0).toString(),bearer:h.bear===1?"自己承担":"对方承担"}});const s=ne.value.filter(h=>h.bearer==="自己承担").reduce((h,v)=>h+(parseFloat(v.amount)||0),0);n.expenseTotal=s.toFixed(2)}console.log(3),ze(),console.log(4)}}catch(e){console.error("获取采购详情失败:",e),de.error("获取采购详情失败")}},U=$(!1),n=dl({handler:"",warehouse:"",supplier:"",remark:"",documentNumber:"",businessDate:"",purchaseTotal:"0.00",expenseTotal:"0.00",roundingAmount:"",payableTotal:"0.00",images:[]}),oe=t=>{if(t.product.id!==null)return!1;const e=S.value.findIndex(o=>o.product.id===null);return e!==-1&&S.value[e]===t},S=$([]),he=$(-1),be=$(!1),xe=$([{id:"1",operate:"",name:"商品名字",showName:"商品名字",align:"default",column:!0,flex:"default"},{id:"2",operate:"",name:"库存",showName:"库存",align:"default",column:!0,flex:"default"},{id:"3",operate:"",name:"单位",showName:"单位",align:"default",column:!0,flex:"default"},{id:"4",operate:"",name:"数量",showName:"数量",align:"default",column:!0,flex:"default"},{id:"5",operate:"",name:"单价(小单位)",showName:"单价(小单位)",align:"default",column:!0,flex:"default"},{id:"6",operate:"",name:"副单位",showName:"副单位",align:"default",column:!0,flex:"default"},{id:"7",operate:"",name:"单位（大）",showName:"单位（大）",align:"default",column:!0,flex:"default"},{id:"8",operate:"",name:"数量（大单位）",showName:"数量（大单位）",align:"default",column:!0,flex:"default"},{id:"9",operate:"",name:"单价(大单位)",showName:"单价(大单位)",align:"default",column:!0,flex:"default"},{id:"10",operate:"",name:"金额(元)",showName:"金额(元)",align:"default",column:!0,flex:"default"},{id:"11",operate:"",name:"历史进价",showName:"历史进价",align:"default",column:!0,flex:"default"},{id:"12",operate:"",name:"单品备注",showName:"单品备注",align:"default",column:!0,flex:"default"},{id:"13",operate:"",name:"操作",showName:"操作",align:"default",column:!0,flex:"default"}]),f=()=>{be.value=!0},ke=t=>{xe.value.splice(0,xe.value.length,...t),be.value=!1},ie=ce(()=>xe.value.filter(t=>t.column===!0)),Qe=ce(()=>S.value.map(t=>t.product).filter(Boolean)),Te=$([]),Se=$(!1),ne=$([{item:"",amount:"",bearer:"自己承担"}]),I=()=>{Se.value=!0},pe=()=>{ne.value.push({item:"",amount:"",bearer:"自己承担"})},cl=t=>{ne.value.splice(t,1)},ml=()=>{const t=ne.value.filter(e=>e.bearer==="自己承担").reduce((e,o)=>e+(parseFloat(o.amount)||0),0);n.expenseTotal=t.toFixed(2),Se.value=!1},pl=async()=>{try{const t=await le.otherUnitList({page:1,limit:999});if((t==null?void 0:t.code)===1e4){const e=t.data||[];Te.value=e.map(o=>({label:o.name,value:o.id}))}}catch(t){console.error("获取费用项失败:",t)}},Ae=$(!1),He=$(),el=()=>{Ae.value=!0},vl=t=>{new Set(S.value.map(o=>{var s;return(s=o.product)==null?void 0:s.id})).has(t.id)||(je.value=t,Fe.value=!0)},ll=t=>{const e=S.value.findIndex(o=>{var s;return((s=o.product)==null?void 0:s.id)===t.id});e!==-1&&S.value.splice(e,1),He.value&&He.value.unselectProduct(t)},fl=t=>{const e=new Set(S.value.map(s=>{var h;return(h=s.product)==null?void 0:h.id})),o=t.filter(s=>!e.has(s.id));o.length>0&&(Ie.value=o,Ke())},Ke=()=>{Ie.value.length>0&&(je.value=Ie.value.shift(),Fe.value=!0)},_l=t=>{const e={...t,itemRemark:""},o=S.value.findIndex(s=>{var h;return((h=s.product)==null?void 0:h.id)===null});o!==-1?S.value[o]=e:S.value.push(e),Fe.value=!1,Ie.value.length>0&&Ke()},yl=t=>{ll(t),Fe.value=!1,Ie.value.length>0&&Ke()},gl=t=>{t&&t.product&&al(t.product)},bl=ce(()=>S.value.reduce((t,e)=>t+e.amount,0)),xl=async()=>{try{const t=await le.getOrderSn();(t==null?void 0:t.code)===1e4&&(n.documentNumber=t.data||"")}catch(t){console.error("获取单据编号失败:",t),de.error("获取单据编号失败")}},kl=t=>{console.log("上传图片成功",t),n.images.push(t.data.path)},tl=t=>{S.value.splice(t,1)},$l=t=>{const e={product:{id:null}};S.value.splice(t,0,e)},al=async t=>{var e;try{const o=await le.historyPrice(Number(t.id));ol.value=((e=o.data)==null?void 0:e.data)||o.data||[],We.value=!0}catch(o){console.error("获取历史进价失败:",o),de.error("获取历史进价失败")}},hl=()=>{$e.back()},wl=()=>{J.value?Nl():Vl()},Vl=async()=>{var t;try{const e=p=>{if(!p)return"";const q=typeof p=="string"?new Date(p):p;if(Number.isNaN(q.getTime()))return"";const F=q.getFullYear(),H=String(q.getMonth()+1).padStart(2,"0"),O=String(q.getDate()).padStart(2,"0");return`${F}-${H}-${O}`},o=S.value.map(p=>{var O,B,ve,fe,re,we,Re;const q=Number(((O=p.product)==null?void 0:O.id)||((B=p.product)==null?void 0:B.goods_id)||((ve=p.product)==null?void 0:ve.goodsId)||((fe=p.product)==null?void 0:fe.gid)||((re=p.product)==null?void 0:re.ID)||((we=p.product)==null?void 0:we.Id)||((Re=p.product)==null?void 0:Re.id)),F=Number(p.totalQtySmallUnits||p.smallQty||0),H=Number(p.amount||0);return{goods_id:q,num:F,price:H,mark:p.itemRemark||"",f_stock:Number(p.f_stock||0)}}).filter(p=>p.goods_id&&p.num>0),s=ne.value.map(p=>({price:Number(p.amount||0),bear:p.bearer==="自己承担"?1:2,other_unit_id:Number(p.item||0)})).filter(p=>p.price>0&&p.other_unit_id),h={supplier_id:n.supplier,staff_id:n.handler,warehouse_id:n.warehouse,order_sn:n.documentNumber,time:e(n.businessDate),describe:n.remark,file:(n.images||[]).join(","),money:Number(n.roundingAmount||0),order_price:Number(n.payableTotal||0),goods:o,costs:s},v=await le.purchaseCreate(h);if((v==null?void 0:v.code)===1e4){const p=(t=v==null?void 0:v.data)==null?void 0:t.purchase_id;W.value=p||null,p&&await le.purchaseExamine({purchase_id:p});try{await rl.confirm("创建成功，是否前往付款？","提示",{confirmButtonText:"前往付款",cancelButtonText:"暂不",type:"success"}),Ge.value=!0}catch{$e.back()}}}catch(e){console.error("新建采购单失败:",e),de.error("新建采购单失败")}},Nl=async()=>{try{const t=v=>{if(!v)return"";const p=typeof v=="string"?new Date(v):v;if(Number.isNaN(p.getTime()))return"";const q=p.getFullYear(),F=String(p.getMonth()+1).padStart(2,"0"),H=String(p.getDate()).padStart(2,"0");return`${q}-${F}-${H}`},e=S.value.map(v=>{var H,O,B,ve,fe,re,we;const p=Number(((H=v.product)==null?void 0:H.id)||((O=v.product)==null?void 0:O.goods_id)||((B=v.product)==null?void 0:B.goodsId)||((ve=v.product)==null?void 0:ve.gid)||((fe=v.product)==null?void 0:fe.ID)||((re=v.product)==null?void 0:re.Id)||((we=v.product)==null?void 0:we.id)),q=Number(v.totalQtySmallUnits||v.smallQty||0),F=Number(v.amount||0);return{goods_id:p,num:q,price:F,mark:v.itemRemark||"",f_stock:Number(v.f_stock||0)}}).filter(v=>v.goods_id&&v.num>0),o=ne.value.map(v=>({price:Number(v.amount||0),bear:v.bearer==="自己承担"?1:2,other_unit_id:Number(v.item||0)})).filter(v=>v.price>0&&v.other_unit_id),s={supplier_id:n.supplier,staff_id:n.handler,warehouse_id:n.warehouse,order_sn:n.documentNumber,time:t(n.businessDate),describe:n.remark,file:(n.images||[]).join(","),money:Number(n.roundingAmount||0),order_price:Number(n.payableTotal||0),goods:e,costs:o},h=await le.purchaseEdit(ae.value,s);(h==null?void 0:h.code)===1e4&&(de.success("编辑成功"),$e.back())}catch(t){console.error("编辑采购单失败:",t),de.error("编辑采购单失败")}},Pl=()=>{$e.back()},ze=()=>{const t=parseFloat(n.purchaseTotal)||0,e=parseFloat(n.expenseTotal)||0,o=parseFloat(n.roundingAmount)||0;n.payableTotal=(t+e-o).toFixed(2)};Ce(bl,t=>{n.purchaseTotal=Number(t).toFixed(2),ze()},{immediate:!0}),Ce(()=>n.roundingAmount,()=>{ze()}),Ce(()=>n.expenseTotal,()=>{ze()}),Ze(async()=>{const t=Ve.query.id;t?(J.value=!0,ae.value=t):xl(),await Promise.all([m(),k(),P(),pl()]),J.value&&ae.value?await G(ae.value):Sl()});const Sl=()=>{for(let t=0;t<4;t++)S.value.push({product:{id:null},amount:0,smallQty:0,largeQty:0,quantityText:"",totalQtySmallUnits:0})};Ce(()=>n.warehouse,(t,e)=>{t!==e&&(S.value=[],Ie.value=[])});const Fe=$(!1),je=$(null),Ie=$([]),We=$(!1),ol=$([]),Ge=$(!1),Oe=$(!1),nl=ce(()=>{const t=ge.value.find(e=>e.id===n.supplier);return t?t.name:n.supplier||"—"}),Cl=()=>{n.supplier&&(Oe.value=!0)},Ul=t=>{console.log("查看采购详情:",t)};return(t,e)=>{var ul;const o=N("el-date-picker"),s=N("el-button"),h=N("el-option"),v=N("el-select"),p=N("el-input"),q=N("MoreFilled"),F=N("el-icon"),H=N("CirclePlusFilled"),O=N("RemoveFilled"),B=N("el-table-column"),ve=N("el-tag"),fe=N("el-table"),re=N("el-col"),we=N("el-row"),Re=N("el-upload"),ql=N("el-image"),sl=N("el-dialog"),Ye=N("el-form-item"),Ql=N("el-form");return d(),b("div",It,[i("div",null,[i("div",Dt,[i("div",Bt,[i("div",Et,[i("div",Lt,[i("div",zt,[e[24]||(e[24]=V(" 单据：")),i("text",Rt,w(n.documentNumber),1)]),i("div",Mt,[e[25]||(e[25]=V(" 日期： ")),r(o,{style:{border:"none"},modelValue:n.businessDate,"onUpdate:modelValue":e[0]||(e[0]=l=>n.businessDate=l),type:"date",placeholder:"请选择"},null,8,["modelValue"])])]),i("div",At,[r(s,{size:L(De),type:"primary",onClick:e[1]||(e[1]=l=>U.value=!0)},{default:u(()=>e[26]||(e[26]=[V("附件")])),_:1},8,["size"]),r(s,{onClick:hl},{default:u(()=>e[27]||(e[27]=[V("取消")])),_:1}),r(s,{type:"primary",onClick:wl},{default:u(()=>[V(w(J.value?"保存":"确认"),1)]),_:1})])])]),i("div",Ht,[i("div",Kt,[i("div",jt,[i("div",Wt,[e[28]||(e[28]=i("div",{class:"lable"},"入库仓库",-1)),r(v,{modelValue:n.warehouse,"onUpdate:modelValue":e[2]||(e[2]=l=>n.warehouse=l),placeholder:"请选择",filterable:""},{default:u(()=>[(d(!0),b(te,null,_e(Pe.value,l=>(d(),Q(h,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),i("div",Gt,[e[30]||(e[30]=i("div",{class:"lable"},"供应商",-1)),i("div",Ot,[r(v,{modelValue:n.supplier,"onUpdate:modelValue":e[3]||(e[3]=l=>n.supplier=l),placeholder:"请选择",filterable:""},{default:u(()=>[(d(!0),b(te,null,_e(ge.value,l=>(d(),Q(h,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),r(s,{type:"primary",link:"",class:"history-btn",onClick:Cl,disabled:!n.supplier},{default:u(()=>e[29]||(e[29]=[V("历史")])),_:1},8,["disabled"])])]),i("div",Yt,[e[31]||(e[31]=i("div",{class:"lable"},"备注",-1)),r(p,{style:{flex:"1"},modelValue:n.remark,"onUpdate:modelValue":e[4]||(e[4]=l=>n.remark=l),placeholder:"请输入"},null,8,["modelValue"])])])])])]),i("div",Jt,[i("div",Zt,[i("div",Xt,[r(s,{type:"primary",onClick:el},{default:u(()=>e[32]||(e[32]=[V("添加商品")])),_:1})]),r(fe,{data:S.value,border:"",stripe:"",style:{"table-layout":"auto"},"show-summary":"","summary-method":Z,"header-cell-style":L(Dl)},{default:u(()=>[r(B,{fixed:"left",type:"index",label:"序号",align:"center",width:"80"},{header:u(()=>[i("div",{style:{cursor:"pointer",color:"red"},onClick:f},[r(F,null,{default:u(()=>[r(q,{size:30})]),_:1})])]),default:u(l=>[i("div",{class:"index-cell",onMouseenter:a=>he.value=l.$index,onMouseleave:e[5]||(e[5]=a=>he.value=-1)},[he.value!==l.$index?(d(),b("span",la,w(l.$index+1),1)):(d(),b("div",ta,[r(F,{size:22,style:{cursor:"pointer",color:"green"},onClick:Me(a=>$l(l.$index),["stop"])},{default:u(()=>[r(H)]),_:2},1032,["onClick"]),r(F,{size:22,style:{cursor:"pointer",color:"red"},onClick:Me(a=>tl(l.$index),["stop"])},{default:u(()=>[r(O)]),_:2},1032,["onClick"])]))],40,ea)]),_:1}),(d(!0),b(te,null,_e(ie.value,l=>(d(),b(te,{key:l.id},[l.name==="商品名字"?(d(),Q(B,{key:0,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),prop:"product.name",label:l.showName,"min-width":"200"},{default:u(a=>[a.row.product.name?(d(),b("span",aa,w(a.row.product.name),1)):oe(a.row)?(d(),b("span",{key:1,class:"clickable-text",onClick:el}," 添加商品 ")):R("",!0),a.row.product.is_quan?(d(),Q(ve,{key:2,size:L(De),type:"primary",class:"ml5"},{default:u(()=>e[33]||(e[33]=[V("定")])),_:1},8,["size"])):R("",!0)]),_:2},1032,["align","fixed","label"])):l.name==="库存"?(d(),Q(B,{key:1,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),label:l.showName,"min-width":"200"},{default:u(a=>{var x;return[a.row.stockText||a.row.product.stock?(d(),b("span",oa,w(a.row.stockText||`${a.row.product.stock}${(x=a.row.product.unit)==null?void 0:x.name}`),1)):R("",!0)]}),_:2},1032,["align","fixed","label"])):l.name==="单位"?(d(),Q(B,{key:2,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),prop:"product.unit",label:l.showName,"min-width":"120"},{default:u(a=>{var x,E;return[i("div",null,[i("span",null,w((E=(x=a.row.product)==null?void 0:x.unit)==null?void 0:E.name),1)])]}),_:2},1032,["align","fixed","label"])):l.name==="数量"?(d(),Q(B,{key:3,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),label:l.showName,"min-width":"120"},{default:u(a=>{var x;return[M.value===a.$index?(d(),b("div",na,[r(p,{size:L(De),modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=E=>_.value=E),onBlur:E=>z(a.$index),onKeyup:Be(E=>z(a.$index),["enter"]),type:"number",id:`quantity-input-${a.$index}`,placeholder:"请输入数量"},null,8,["size","modelValue","onBlur","onKeyup","id"])])):(d(),b("div",{key:1,class:"quantity-cell",onClick:E=>Y(a.row,a.$index)},[((x=a.row.product)==null?void 0:x.id)!==null&&a.row.smallQty!==0?(d(),b("span",ua,w(a.row.smallQty),1)):R("",!0)],8,sa))]}),_:2},1032,["align","fixed","label"])):l.name==="单价(小单位)"?(d(),Q(B,{key:4,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),label:l.showName,width:"120"},{default:u(a=>{var x;return[A.value===a.$index?(d(),b("div",ia,[r(p,{size:L(De),modelValue:se.value,"onUpdate:modelValue":e[7]||(e[7]=E=>se.value=E),onBlur:E=>T(a.$index),onKeyup:Be(E=>T(a.$index),["enter"]),type:"number",id:`small-price-input-${a.$index}`,placeholder:"请输入单价"},null,8,["size","modelValue","onBlur","onKeyup","id"])])):(d(),b("div",{key:1,class:"quantity-cell",onClick:E=>C(a.row,a.$index)},[((x=a.row.product)==null?void 0:x.id)!==null&&(a.row.unitPrice!=="0.00"||a.row.price!=="0.00"||a.row.product.price!==0)?(d(),b("span",da,w((Number(a.row.unitPrice??a.row.price??a.row.product.price??0)||0).toFixed(2)+"元"),1)):R("",!0)],8,ra))]}),_:2},1032,["align","fixed","label"])):l.name==="副单位"?(d(),Q(B,{key:5,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),label:l.showName,"min-width":"120"},{default:u(a=>{var x;return[g.value===a.$index?(d(),b("div",ca,[r(p,{modelValue:K.value,"onUpdate:modelValue":e[8]||(e[8]=E=>K.value=E),onBlur:E=>D(a.$index),onKeyup:Be(E=>D(a.$index),["enter"]),type:"number",id:`f-stock-input-${a.$index}`,placeholder:"请输入副单位数量"},null,8,["modelValue","onBlur","onKeyup","id"])])):(d(),b("div",{key:1,class:"quantity-cell",onClick:E=>c(a.row,a.$index)},[a.row.f_stock&&((x=a.row.product)!=null&&x.f_unit)?(d(),b("span",pa,w(a.row.f_stock)+w(a.row.product.f_unit),1)):R("",!0)],8,ma))]}),_:2},1032,["align","fixed","label"])):l.name==="单位（大）"?(d(),Q(B,{key:6,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),prop:"product.b_unit",label:l.showName,"min-width":"120"},{default:u(a=>{var x,E;return[i("div",va,[i("span",null,w((E=(x=a.row.product)==null?void 0:x.b_unit)==null?void 0:E.name),1)])]}),_:2},1032,["align","fixed","label"])):l.name==="数量（大单位）"?(d(),Q(B,{key:7,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),prop:"largeQty",label:l.showName,"min-width":"140"},{default:u(a=>[ue.value===a.$index?(d(),b("div",fa,[r(p,{size:L(De),modelValue:X.value,"onUpdate:modelValue":e[9]||(e[9]=x=>X.value=x),onBlur:x=>y(a.$index),onKeyup:Be(x=>y(a.$index),["enter"]),type:"number",id:`large-qty-input-${a.$index}`,placeholder:"请输入数量"},null,8,["size","modelValue","onBlur","onKeyup","id"])])):(d(),b("div",{key:1,class:"quantity-cell",onClick:x=>Ne(a.row,a.$index)},[a.row.largeQty?(d(),b("span",ya,w(a.row.largeQty),1)):R("",!0)],8,_a))]),_:2},1032,["align","fixed","label"])):l.name==="单价(大单位)"?(d(),Q(B,{key:8,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),label:l.showName,width:"120"},{default:u(a=>[ye.value===a.$index?(d(),b("div",ga,[r(p,{size:L(De),modelValue:j.value,"onUpdate:modelValue":e[10]||(e[10]=x=>j.value=x),type:"number",onBlur:x=>qe(a.$index),onKeyup:Be(x=>qe(a.$index),["enter"]),id:`large-price-input-${a.$index}`,placeholder:"请输入单价"},null,8,["size","modelValue","onBlur","onKeyup","id"])])):(d(),b("div",{key:1,class:"quantity-cell",onClick:x=>Ue(a.row,a.$index)},[a.row.largePrice?(d(),b("span",xa,w(Number(a.row.largePrice)+"元"),1)):R("",!0)],8,ba))]),_:2},1032,["align","fixed","label"])):l.name==="金额(元)"?(d(),Q(B,{key:9,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),prop:"amount",label:l.showName,"min-width":"120"},{default:u(a=>{var x;return[((x=a.row.product)==null?void 0:x.id)!==null&&Number(a.row.amount)!==0?(d(),b("span",ka,w(Number(a.row.amount).toFixed(2)),1)):R("",!0)]}),_:2},1032,["align","fixed","label"])):l.name==="历史进价"?(d(),Q(B,{key:10,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),label:l.showName,width:"120"},{default:u(a=>[r(s,{type:"primary",link:"",onClick:x=>al(a.row.product)},{default:u(()=>e[34]||(e[34]=[V("点击查看")])),_:2},1032,["onClick"])]),_:2},1032,["align","fixed","label"])):l.name==="单品备注"?(d(),Q(B,{key:11,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),prop:"itemRemark",label:l.showName,"min-width":"200"},{default:u(a=>{var x;return[((x=a.row.product)==null?void 0:x.id)!==null?(d(),Q(p,{key:0,modelValue:a.row.itemRemark,"onUpdate:modelValue":E=>a.row.itemRemark=E,placeholder:"可输入备注信息"},null,8,["modelValue","onUpdate:modelValue"])):R("",!0)]}),_:2},1032,["align","fixed","label"])):l.name==="操作"?(d(),Q(B,{key:12,align:l.align==="default"?"":l.align,fixed:L(ee)(l.flex),label:l.showName,width:"80"},{default:u(a=>[r(s,{type:"primary",link:"",onClick:x=>tl(a.$index)},{default:u(()=>e[35]||(e[35]=[V("删除")])),_:2},1032,["onClick"])]),_:2},1032,["align","fixed","label"])):R("",!0)],64))),128))]),_:1},8,["data","header-cell-style"]),r(Bl,{modelValue:be.value,"onUpdate:modelValue":e[11]||(e[11]=l=>be.value=l),"header-title":xe.value,onSave:ke},null,8,["modelValue","header-title"])])]),i("div",$a,[i("div",ha,[r(we,{gutter:20},{default:u(()=>[r(re,{span:6},{default:u(()=>[i("div",wa,[e[36]||(e[36]=i("label",null,"采购合计",-1)),r(p,{modelValue:n.purchaseTotal,"onUpdate:modelValue":e[12]||(e[12]=l=>n.purchaseTotal=l),readonly:""},null,8,["modelValue"])])]),_:1}),r(re,{span:6},{default:u(()=>[i("div",Va,[e[39]||(e[39]=i("label",null,"费用合计",-1)),i("div",Na,[r(p,{modelValue:n.expenseTotal,"onUpdate:modelValue":e[13]||(e[13]=l=>n.expenseTotal=l),placeholder:"自动汇总",readonly:""},{append:u(()=>e[37]||(e[37]=[V("元")])),_:1},8,["modelValue"]),r(s,{class:"ml10",onClick:I},{default:u(()=>e[38]||(e[38]=[V("添加")])),_:1})])])]),_:1}),r(re,{span:6},{default:u(()=>[i("div",Pa,[e[41]||(e[41]=i("label",null,"抹零金额",-1)),r(p,{modelValue:n.roundingAmount,"onUpdate:modelValue":e[14]||(e[14]=l=>n.roundingAmount=l),placeholder:"请输入"},{append:u(()=>e[40]||(e[40]=[V("元")])),_:1},8,["modelValue"])])]),_:1}),r(re,{span:6},{default:u(()=>[i("div",Sa,[e[42]||(e[42]=i("label",null,"应付合计",-1)),r(p,{modelValue:n.payableTotal,"onUpdate:modelValue":e[15]||(e[15]=l=>n.payableTotal=l),readonly:"",class:"payable-input"},null,8,["modelValue"])])]),_:1})]),_:1}),r(we,{gutter:20,class:"mt15"},{default:u(()=>[r(re,{span:6},{default:u(()=>[i("div",Ca,[e[43]||(e[43]=i("label",null,"经手人",-1)),r(v,{modelValue:n.handler,"onUpdate:modelValue":e[16]||(e[16]=l=>n.handler=l),placeholder:"请选择",style:{width:"100%"},filterable:""},{default:u(()=>[(d(!0),b(te,null,_e(me.value,l=>(d(),Q(h,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),_:1})]),_:1})])]),r(sl,{modelValue:U.value,"onUpdate:modelValue":e[17]||(e[17]=l=>U.value=l),title:"上传附件",width:"400px",center:""},{default:u(()=>[i("div",Ua,[r(Re,{class:"upload-demo",drag:"",headers:{Authorization:`Bearer ${L(El)().token}`},name:"image","show-file-list":!1,"on-success":kl,action:"https://software.syn.tswm.club/api/upload/image",multiple:""},{default:u(()=>[r(F,{class:"el-icon--upload"},{default:u(()=>[r(L(Ll))]),_:1}),e[44]||(e[44]=i("div",{class:"el-upload__text"}," 上传图片 ",-1))]),_:1},8,["headers"]),(d(!0),b(te,null,_e(n.images,l=>(d(),b("div",{key:l,class:"image-item"},[r(ql,{src:l},null,8,["src"])]))),128))])]),_:1},8,["modelValue"])]),r(vt,{ref_key:"productSelectorRef",ref:He,modelValue:Ae.value,"onUpdate:modelValue":e[18]||(e[18]=l=>Ae.value=l),"selected-products":Qe.value,onConfirm:fl,onSelect:vl,onUnselect:ll},null,8,["modelValue","selected-products"]),r(Ft,{modelValue:Fe.value,"onUpdate:modelValue":e[19]||(e[19]=l=>Fe.value=l),product:je.value,onConfirm:_l,onHistory:gl,onCancel:yl},null,8,["modelValue","product"]),r(zl,{modelValue:We.value,"onUpdate:modelValue":e[20]||(e[20]=l=>We.value=l),data:ol.value},null,8,["modelValue","data"]),r(Rl,{modelValue:Ge.value,"onUpdate:modelValue":e[21]||(e[21]=l=>Ge.value=l),"supplier-name":nl.value,payable:n.payableTotal,"supplier-id":n.supplier,"purchase-id":W.value||"",onSave:Pl},null,8,["modelValue","supplier-name","payable","supplier-id","purchase-id"]),r(sl,{modelValue:Se.value,"onUpdate:modelValue":e[22]||(e[22]=l=>Se.value=l),title:"费用明细",width:"1000px","append-to-body":""},{footer:u(()=>[r(s,{onClick:pe},{default:u(()=>e[47]||(e[47]=[V("添加")])),_:1}),r(s,{type:"primary",onClick:ml},{default:u(()=>e[48]||(e[48]=[V("保存")])),_:1})]),default:u(()=>[r(Ql,{"label-width":"80px"},{default:u(()=>[(d(!0),b(te,null,_e(ne.value,(l,a)=>(d(),b("div",{key:a,class:"expense-row"},[r(Ye,{label:"费用项"},{default:u(()=>[r(v,{modelValue:l.item,"onUpdate:modelValue":x=>l.item=x,placeholder:"请选择",style:{width:"160px"}},{default:u(()=>[(d(!0),b(te,null,_e(Te.value,x=>(d(),Q(h,{key:x.value,label:x.label,value:x.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),r(Ye,{label:"费用金额"},{default:u(()=>[r(p,{modelValue:l.amount,"onUpdate:modelValue":x=>l.amount=x,placeholder:"请输入",style:{width:"180px"}},{append:u(()=>e[45]||(e[45]=[V("元")])),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),r(Ye,{label:"费用承担"},{default:u(()=>[r(v,{modelValue:l.bearer,"onUpdate:modelValue":x=>l.bearer=x,placeholder:"请选择",style:{width:"160px"}},{default:u(()=>[r(h,{label:"自己承担",value:"自己承担"}),r(h,{label:"对方承担",value:"对方承担"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),ne.value.length>1?(d(),Q(s,{key:0,link:"",type:"primary",onClick:x=>cl(a)},{default:u(()=>e[46]||(e[46]=[V("删除")])),_:2},1032,["onClick"])):R("",!0)]))),128))]),_:1})]),_:1},8,["modelValue"]),r(Ml,{modelValue:Oe.value,"onUpdate:modelValue":e[23]||(e[23]=l=>Oe.value=l),"supplier-id":n.supplier,"supplier-info":{name:nl.value,phone:((ul=ge.value.find(l=>l.id===n.supplier))==null?void 0:ul.phone)||""},onViewDetail:Ul},null,8,["modelValue","supplier-id","supplier-info"])])}}}),Ia=Xe(qa,[["__scopeId","data-v-98b585b4"]]);export{Ia as default};
