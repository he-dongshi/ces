import{d as de,l as q,r as i,o as ue,w as K,a as p,j as k,b as c,h as _,e as n,g as y,I as ie,k as b,c as v,F as x,i as j,t as r,q as L,p as _e,D as G,A as H,y as pe,_ as ve}from"./index-BUVdxLJQ.js";const he={class:"drawer-wrapper"},fe={class:"drawer-header"},ge={class:"drawer-body"},ke={class:"category-pane"},ye={key:0,class:"loading-text"},be=["onClick"],me={class:"content-pane"},we={key:0,class:"loading-text"},Ce={key:1,class:"card-grid"},xe=["onClick"],$e={class:"checkbox-container"},Ve={class:"product-img"},Pe=["src","alt"],Se={class:"name-row"},Ie={class:"name"},Te={class:"sub"},Be={class:"sub"},Ne={class:"sub"},De={class:"sub"},ze={class:"sub"},We={class:"pagination-row"},Me={class:"drawer-footer"},Ue={class:"tip"},Ee={class:"actions"},J=12,qe=de({__name:"ProductSelectorDrawer",props:{modelValue:{type:Boolean},selectedProducts:{},warehouseId:{}},emits:["update:modelValue","confirm","select","unselect"],setup(O,{expose:Q,emit:R}){const h=O,m=R,$=q({get:()=>h.modelValue,set:e=>m("update:modelValue",e)}),V=i(""),X=i(""),N=i(""),D=i(""),z=i(!1),W=i(!1),w=i([]),Y=e=>{if(!e||e.length===0)return[];if(e.some(a=>a.children&&a.children.length>0))return e.map(a=>({...a,children:a.children||[]}));const l={},t=[];return e.forEach(a=>{l[a.id]={...a,children:[]}}),e.forEach(a=>{const u=a.p_id;u&&u!==0&&l[u]?(l[u].children||(l[u].children=[]),l[u].children.push(l[a.id])):t.push(l[a.id])}),console.log("转换后的树形结构:",t),t},Z=async()=>{try{z.value=!0;const e=await H.list("goods_cate",{page:1,limit:9999});if(e.code===1e4){const s=e.data||[],l=Y(s);w.value=l,w.value.length>0&&S(w.value[0])}}catch(e){console.error("获取商品分类失败:",e)}finally{z.value=!1}},M=i([]),A=i(0),d=i(new Set),U=q(()=>M.value.filter(e=>d.value.has(e.id))),P=async()=>{try{W.value=!0;const e={page:C.value,limit:J};V.value.trim()&&(e.keyword=V.value.trim()),N.value&&(e.cate_id=N.value),h.warehouseId&&(e.warehouse_id=h.warehouseId);const s=await H.list("goods",e);s.code===1e4&&(M.value=s.data||[],A.value=s.total||0)}catch(e){console.error("获取商品失败:",e)}finally{W.value=!1}},C=i(1),ee=q(()=>M.value);function F(){C.value=1,P()}function S(e){X.value=e.name,N.value=String(e.id);const s=w.value.find(l=>{var t;return(t=l.children)==null?void 0:t.some(a=>a.id===e.id)});s?D.value=`c-${s.id}-${e.id}`:D.value=`c-${e.id}`,C.value=1,P()}async function E(e){if(d.value.has(e.id))try{await pe.confirm(`确定要取消选中商品"${e.name}"吗？`,"确认取消选中",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),d.value.delete(e.id),m("unselect",e)}catch{}else m("select",e)}function oe(e){var a,u,I,T;const s=[];let t=e.goodsWarehouse&&e.goodsWarehouse.length>0?Number(e.goodsWarehouse[0].stock||0):Number(e.stock||0);if(e.b_ratio>0&&t>=e.b_ratio&&((a=e.b_unit)!=null&&a.name)){const f=Math.floor(t/e.b_ratio);f>0&&(s.push(`${f}${e.b_unit.name}`),t=t%e.b_ratio)}if(e.c_ratio>0&&t>=e.c_ratio&&((u=e.c_unit)!=null&&u.name)){const f=Math.floor(t/e.c_ratio);f>0&&(s.push(`${f}${e.c_unit.name}`),t=t%e.c_ratio)}return t>0&&s.push(`${t}${(I=e.unit)==null?void 0:I.name}`),s.length>0?s.join(" "):`0${(T=e.unit)==null?void 0:T.name}`}function se(e){return e.goodsWarehouse&&e.goodsWarehouse.length>0?Number(e.goodsWarehouse[0].stock||0):Number(e.stock||0)}function ne(){$.value=!1}function ae(){U.value.length>0&&m("confirm",U.value),$.value=!1,console.log(U.value)}function te(e){d.value.has(e.id)&&(d.value.delete(e.id),m("unselect",e))}return Q({unselectProduct:te}),ue(()=>{Z(),P()}),K(()=>h.selectedProducts,e=>{e&&e.length>0?d.value=new Set(e.map(s=>s.id)):d.value.clear()},{immediate:!0}),K(()=>h.modelValue,e=>{e&&h.selectedProducts&&h.selectedProducts.length>0&&(d.value=new Set(h.selectedProducts.map(s=>s.id)))}),(e,s)=>{const l=p("el-button"),t=p("el-input"),a=p("el-menu-item"),u=p("el-sub-menu"),I=p("el-menu"),T=p("el-checkbox"),f=p("el-tag"),le=p("el-pagination"),ce=p("el-drawer");return c(),k(ce,{modelValue:$.value,"onUpdate:modelValue":s[3]||(s[3]=o=>$.value=o),"with-header":!1,size:"80%","append-to-body":""},{default:_(()=>[n("div",he,[n("div",fe,[s[5]||(s[5]=n("span",null,"选择商品",-1)),y(t,{modelValue:V.value,"onUpdate:modelValue":s[0]||(s[0]=o=>V.value=o),placeholder:"搜索编号/名称/条码",class:"search-input",clearable:"",onKeyup:ie(F,["enter","native"])},{append:_(()=>[y(l,{type:"primary",onClick:F},{default:_(()=>s[4]||(s[4]=[b("搜索")])),_:1})]),_:1},8,["modelValue"])]),n("div",ge,[n("div",ke,[s[6]||(s[6]=n("div",{class:"category-title"},"商品分类",-1)),z.value?(c(),v("div",ye,"加载中...")):(c(),k(I,{key:1,class:"category-menu","default-active":D.value},{default:_(()=>[(c(!0),v(x,null,j(w.value,(o,B)=>(c(),v(x,{key:o.id||B},[o.children&&o.children.length>0?(c(),k(u,{key:0,index:`c-${o.id}`},{title:_(()=>[n("span",{class:"category-title-clickable",onClick:L(g=>S(o),["stop"])},r(o.name),9,be)]),default:_(()=>[(c(!0),v(x,null,j(o.children,(g,re)=>(c(),k(a,{key:g.id||re,index:`c-${o.id}-${g.id}`,onClick:je=>S(g)},{default:_(()=>[b(r(g.name),1)]),_:2},1032,["index","onClick"]))),128))]),_:2},1032,["index"])):(c(),k(a,{key:1,index:`c-${o.id}`,onClick:g=>S(o)},{default:_(()=>[b(r(o.name),1)]),_:2},1032,["index","onClick"]))],64))),128))]),_:1},8,["default-active"]))]),n("div",me,[W.value?(c(),v("div",we,"加载商品中...")):(c(),v("div",Ce,[(c(!0),v(x,null,j(ee.value,o=>(c(),v("div",{key:o.id,class:_e(["product-card",{selected:d.value.has(o.id)}]),onClick:B=>E(o)},[n("div",$e,[y(T,{"model-value":d.value.has(o.id),"onUpdate:modelValue":B=>E(o),onClick:s[1]||(s[1]=L(()=>{},["stop"]))},null,8,["model-value","onUpdate:modelValue"])]),n("div",Ve,[n("img",{src:o.img,alt:o.name},null,8,Pe)]),n("div",Se,[n("span",Ie,r(o.name),1),o.is_quan?(c(),k(f,{key:0,type:"primary",size:"small"},{default:_(()=>s[7]||(s[7]=[b("定")])),_:1})):G("",!0)]),n("div",Te,"存："+r(oe(o)),1),o.is_quan?(c(),v(x,{key:0},[n("div",Be,"总："+r(se(o))+r(o.unit.name),1),n("div",Ne," 规格："+r(o==null?void 0:o.spec.name),1),n("div",De," 价格： "+r(o==null?void 0:o.unit.name)+"/"+r(o==null?void 0:o.price)+", "+r(o==null?void 0:o.b_unit.name)+"/"+r(o==null?void 0:o.b_price),1),n("div",ze," 条形码："+r(o==null?void 0:o.unit_barcode),1)],64)):G("",!0)],10,xe))),128))])),n("div",We,[y(le,{background:"",layout:"prev, pager, next",total:A.value,"page-size":J,"current-page":C.value,"onUpdate:currentPage":s[2]||(s[2]=o=>C.value=o),onCurrentChange:P},null,8,["total","current-page"])])])]),n("div",Me,[n("div",Ue,"已选 "+r(d.value.size)+" 项",1),n("div",Ee,[y(l,{onClick:ne},{default:_(()=>s[8]||(s[8]=[b("取消")])),_:1}),y(l,{type:"primary",onClick:ae},{default:_(()=>s[9]||(s[9]=[b("确认")])),_:1})])])])]),_:1},8,["modelValue"])}}}),Fe=ve(qe,[["__scopeId","data-v-49224876"]]);export{Fe as T};
