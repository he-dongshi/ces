import{d as Ce,G as qe,u as Ue,r as v,o as $e,a as P,c as d,b as u,g as p,h as f,e as r,D as h,k as y,t as a,F as x,i as Pe,j as X,p as Te,q as ve,A as g,E as b,y as pe,_ as Ie}from"./index-BUVdxLJQ.js";import{P as Fe}from"./PrintComponent-DWF2ajXU.js";import"./printProvider-D1gq-grw.js";const ze={class:"page p20"},Ee={class:"page-header"},Qe={class:"header-actions"},Ve={class:"section mb20"},je={class:"section-content"},Le={class:"ml10"},Ge={class:"mt8"},He={class:"ml10"},Oe={key:0,class:"mt8"},Re={key:0,class:"section mb20"},Je={class:"section-content"},Ke={class:"child-list"},We={class:"row"},Xe={class:"row"},Ye={class:"row"},Ze={class:"row"},De={class:"status"},en={class:"actions"},nn={class:"section"},tn={class:"section-content"},sn={key:0},rn={key:1},on={key:0},ln={key:1},an={key:0},cn={key:1},un={class:"summary"},mn={class:"mr10"},_n={class:"mr10"},dn=Ce({__name:"InventoryDetail",setup(fn){const ye=qe(),ge=Ue(),k=v(""),ne=v(""),w=v({}),T=v([]),Y=v([]),I=v("0.00"),F=v("0.00"),M=v(0),Z=v(0),be=v(!1),z=v({}),te=v({});async function A(){var n,s,t,i,m;if(k.value=String(ye.query.id||""),!!k.value){await Me();try{const l=await g.list("inventory_plan",{pid:k.value}),o=((n=l==null?void 0:l.data)==null?void 0:n.main)||(l==null?void 0:l.data)||{};D(o),M.value=Number((o==null?void 0:o.is_over)||0),Z.value=Number((o==null?void 0:o.is_submit)||0),(o==null?void 0:o.loss_price)!==void 0&&(I.value=String(o.loss_price)),(o==null?void 0:o.price)!==void 0&&(F.value=String(o.price)),te.value={id:k.value,...o}}catch{}if(M.value===1){try{const l=await g.list("inventory_plan",{page:1,limit:9999,pid:k.value}),o=((t=(s=l==null?void 0:l.data)==null?void 0:s.list)==null?void 0:t.data)||((i=l==null?void 0:l.data)==null?void 0:i.data)||[];T.value=he(o),(m=l==null?void 0:l.data)!=null&&m.main&&(D(l.data.main),l.data.main.loss_price!==void 0&&(I.value=String(l.data.main.loss_price)),l.data.main.price!==void 0&&(F.value=String(l.data.main.price)))}catch{}Y.value=[]}else await se(k.value)}}function D(n){var e;let s=(n==null?void 0:n.staff_name)||(n==null?void 0:n.user_name)||((e=n==null?void 0:n.user)==null?void 0:e.name)||String((n==null?void 0:n.user_id)||"")||"—";const t=String((n==null?void 0:n.user_id)||"");t&&z.value[t]&&(s=z.value[t]);const i=(n==null?void 0:n.cate_names)||(n==null?void 0:n.cate_name)||(Array.isArray(n==null?void 0:n.categories)?n.categories.join("、"):"")||"—",m=(n==null?void 0:n.created_at)||(n==null?void 0:n.start_time)||(n==null?void 0:n.start),l=(n==null?void 0:n.updated_at)||(n==null?void 0:n.over_time)||(n==null?void 0:n.end_time)||(n==null?void 0:n.finish_time)||(n==null?void 0:n.end),o=(n==null?void 0:n.no_cate)||"";w.value={staff:s,cates:i,start:m,end:l,no_cate:o}}function he(n){return(Array.isArray(n)?n:[]).map(t=>({id:String(t.id||t.plan_id||""),staff:z.value[String(t.user_id||"")]||t.staff_name||t.user_name||String(t.user_id||"")||"—",cate:t.cate_name||t.cate||t.cate_names||"—",start:t.created_at||t.start_time||"",end:t.updated_at||t.over_time||t.end_time||t.finish_time||"",status:Number(t.is_over)===1?"正常":Number(t.is_over)==2?"已提交":"已作废",is_submit:Number(t.is_submit??0),is_over:Number(t.is_over??0)}))}function ke(n){return(Array.isArray(n)?n:[]).map(t=>{var $,re,oe,le,ae,ce,ue,me,_e,de,fe;const i=t.goods||{},m=t.goods_name||i.name||(($=t.product)==null?void 0:$.name)||t.name||"—",l=t.unit_name||((re=i.unit)==null?void 0:re.name)||((oe=t.unit)==null?void 0:oe.name)||((ae=(le=t.product)==null?void 0:le.unit)==null?void 0:ae.name)||"件",o=Number(t.before_stock??t.before_quantity??t.stock??i.stock??0),e=Number(t.after_stock??t.real_quantity??t.real??0),N=o-e,C=Number(i.is_quan??t.is_quan??0)===1,q=l,E=((ce=i.c_unit)==null?void 0:ce.name)||((ue=i.cUnit)==null?void 0:ue.name)||((me=t.c_unit)==null?void 0:me.name)||"",Q=((_e=i.b_unit)==null?void 0:_e.name)||((de=i.bUnit)==null?void 0:de.name)||((fe=t.b_unit)==null?void 0:fe.name)||"",V=Number(t.before_stock??0),U=Number(t.middle_quantity??0),S=Number(t.big_quantity??0),c=Number(t.after_small_quantity??0),j=Number(t.after_middle_quantity??0),_=Number(t.after_big_quantity??0),B=V||U||S?V:Number(t.before_stock??0),L=c||j||_?c:Number(t.after_stock??0),G=!!E,H=!!Q,O=`${o}${l}`,ee=`${e}${l}`,R=String(N),J=String(B-L),K=String(U-j),W=String(S-_);return{name:m,isQuan:C,stockText:O,realText:ee,diffText:R,smallUnit:q,middleUnit:E,bigUnit:Q,hasMiddle:G,hasBig:H,beforeSmall:B,beforeMiddle:U,beforeBig:S,afterSmall:L,afterMiddle:j,afterBig:_,diffSmall:J,diffMiddle:K,diffBig:W}})}async function se(n){var s;try{ne.value=n;const t=await g.list("inventory_plan_goods",{id:n,page:1,limit:9999}),i=(t==null?void 0:t.data)||{};i!=null&&i.plan&&(D(i.plan),i.plan.loss_price!==void 0&&(I.value=String(i.plan.loss_price)),i.plan.price!==void 0&&(F.value=String(i.plan.price)));const m=(i==null?void 0:i.list)||((s=i==null?void 0:i.list)==null?void 0:s.data)||(i==null?void 0:i.goods)||(i==null?void 0:i.data)||[];Y.value=ke(m)}catch{}}async function Se(n){try{await g.add("inventory_plan/over_child_inventory_plan",{id:String((n==null?void 0:n.id)||"")}),b.success("提交成功"),await A()}catch{b.error("提交失败")}}async function we(n){try{await pe.confirm("确定作废该子盘点单？","提示",{type:"warning"})}catch{return}try{await g.del("inventory_plan",n.id),b.success("作废成功"),await A()}catch{b.error("作废失败")}}async function Ne(){try{const n=T.value.filter(t=>Number(t.is_submit)===1);for(const t of n)try{await g.add("inventory_plan/over_child_inventory_plan",{id:String(t.id)})}catch{}const s=await g.add("inventory_plan/merge_order",{id:String(k.value)});s&&(s.code===1e4||s.success)?(b.success("合并成功"),be.value=!0,await A()):b.error((s==null?void 0:s.msg)||"合并失败")}catch{b.error("合并失败")}}async function xe(){try{const n=await g.add("inventory_plan/submit_inventory_plan",{id:String(k.value)});n&&(n.code===1e4||n.success)?(b.success("完成盘点成功"),await A()):b.error((n==null?void 0:n.msg)||"完成盘点失败")}catch{b.error("完成盘点失败")}}async function Be(){try{await pe.confirm("确定作废主盘点单？","提示",{type:"warning"})}catch{return}try{await g.del("inventory_plan",k.value),b.success("作废成功"),ie()}catch{b.error("作废失败")}}function ie(){ge.replace({name:"inventoryList"})}$e(A);async function Me(){try{const n=await g.staffList({page:1,limit:99999}),s=(n==null?void 0:n.data)||[],t={};(Array.isArray(s)?s:[]).forEach(i=>{i&&i.id!==void 0&&(t[String(i.id)]=i.name||i.staff_name||String(i.id))}),z.value=t}catch{}}async function Ae(n){var s,t,i,m,l;try{const o=await g.list("inventory_plan",{pid:n}),e=((s=o==null?void 0:o.data)==null?void 0:s.main)||(o==null?void 0:o.data)||{};let N=[],C="0.00",q="0.00";try{const S=await g.list("inventory_plan_goods",{id:n,limit:9999,page:1}),c=(S==null?void 0:S.data)||{};N=((c==null?void 0:c.list)||((t=c==null?void 0:c.list)==null?void 0:t.data)||(c==null?void 0:c.goods)||(c==null?void 0:c.data)||[]).map(_=>{var R,J,K,W,$;const B=_.goods||{},L=_.goods_name||B.name||((R=_.product)==null?void 0:R.name)||_.name||"—",G=_.unit_name||((J=B.unit)==null?void 0:J.name)||((K=_.unit)==null?void 0:K.name)||(($=(W=_.product)==null?void 0:W.unit)==null?void 0:$.name)||"件",H=Number(_.before_stock??_.before_quantity??_.stock??B.stock??0),O=Number(_.after_stock??_.real_quantity??_.real??0),ee=H-O;return{name:L,stockText:`${H}${G}`,realText:`${O}${G}`,diffText:String(ee)}}),c!=null&&c.plan?(C=String(Number(c.plan.price||0).toFixed(2)),q=String(Number(c.plan.loss_price||0).toFixed(2))):(C=String(Number(e.price||e.amount||0).toFixed(2)),q=String(Number(e.loss_price||e.diff||0).toFixed(2)))}catch(S){console.error("获取盘点明细失败:",S)}const E=(e==null?void 0:e.staff_name)||(e==null?void 0:e.user_name)||((i=e==null?void 0:e.user)==null?void 0:i.name)||((m=e==null?void 0:e.creator)==null?void 0:m.nickname)||((l=e==null?void 0:e.creator)==null?void 0:l.username)||String((e==null?void 0:e.user_id)||"")||"—",Q=(e==null?void 0:e.cate_names)||(e==null?void 0:e.cate_name)||(Array.isArray(e==null?void 0:e.categories)?e.categories.join("、"):"")||"",V=(e==null?void 0:e.created_at)||(e==null?void 0:e.start_time)||(e==null?void 0:e.start)||"",U=(e==null?void 0:e.updated_at)||(e==null?void 0:e.over_time)||(e==null?void 0:e.end_time)||(e==null?void 0:e.finish_time)||(e==null?void 0:e.end)||"";return{...e,header:{staff:E,cates:Q,start:V,end:U},items:N,profitPrice:C,lossPrice:q}}catch(o){throw console.error("获取盘点详情失败:",o),o}}return(n,s)=>{const t=P("el-button"),i=P("el-card"),m=P("el-table-column"),l=P("el-tag"),o=P("el-table");return u(),d("div",ze,[p(i,{shadow:"never"},{default:f(()=>[r("div",Ee,[s[0]||(s[0]=r("h2",null,"盘点详情",-1)),r("div",Qe,[p(Fe,{share:"","selected-data":[te.value],"page-type":"inventory","get-detail-data":Ae},null,8,["selected-data"])])]),r("div",Ve,[r("div",je,[r("div",null,[y(" 盘点人："+a(w.value.staff||"—")+" ",1),r("span",Le,"盘点分类："+a(w.value.cates||"—"),1)]),r("div",Ge,[y(" 盘点时间："+a(w.value.start||"—")+" ",1),r("span",He,"完成时间："+a(w.value.end||"—"),1)]),w.value.no_cate?(u(),d("div",Oe," 未盘点分类："+a(w.value.no_cate),1)):h("",!0)])]),M.value===1?(u(),d("div",Re,[s[7]||(s[7]=r("div",{class:"section-title"},[r("span",null,"子盘点单")],-1)),r("div",Je,[r("div",Ke,[(u(!0),d(x,null,Pe(T.value,e=>(u(),X(i,{key:e.id,class:Te(["child-card",{active:String(e.id)===String(ne.value)}]),onClick:N=>se(String(e.id)),shadow:"hover"},{default:f(()=>[r("div",We,[s[1]||(s[1]=r("span",null,"盘点人：",-1)),r("span",null,a(e.staff||"—"),1)]),r("div",Xe,[s[2]||(s[2]=r("span",null,"盘点分类：",-1)),r("span",null,a(e.cate||"—"),1)]),r("div",Ye,[s[3]||(s[3]=r("span",null,"盘点时间：",-1)),r("span",null,a(e.start||"—"),1)]),r("div",Ze,[s[4]||(s[4]=r("span",null,"完成时间：",-1)),r("span",null,a(e.end||"—"),1)]),r("div",De,a(e.status||"—"),1),r("div",en,[p(t,{size:"small",type:"primary",disabled:e.is_over!==1,onClick:ve(N=>Se(e),["stop"])},{default:f(()=>s[5]||(s[5]=[y("提交")])),_:2},1032,["disabled","onClick"]),p(t,{size:"small",disabled:e.is_over===2||e.is_over===3,onClick:ve(N=>we(e),["stop"])},{default:f(()=>s[6]||(s[6]=[y("作废")])),_:2},1032,["disabled","onClick"])])]),_:2},1032,["class","onClick"]))),128))])])])):h("",!0),r("div",nn,[s[13]||(s[13]=r("div",{class:"section-title"},[r("span",null,"清单")],-1)),r("div",tn,[p(o,{data:Y.value,border:"",stripe:""},{default:f(()=>[p(m,{type:"index",width:"60",label:"序号"}),p(m,{prop:"name",label:"商品名称","min-width":"220"},{default:f(e=>[r("span",null,a(e.row.name),1),e.row.isQuan?(u(),X(l,{key:0,type:"primary",size:"small",class:"ml5"},{default:f(()=>s[8]||(s[8]=[y("定")])),_:1})):h("",!0)]),_:1}),p(m,{label:"盘前数量",width:"220"},{default:f(e=>[e.row.isQuan?(u(),d(x,{key:0},[r("div",null,a(e.row.beforeSmall)+a(e.row.smallUnit),1),e.row.hasMiddle?(u(),d("div",sn,a(e.row.beforeMiddle)+a(e.row.middleUnit),1)):h("",!0),e.row.hasBig?(u(),d("div",rn,a(e.row.beforeBig)+a(e.row.bigUnit),1)):h("",!0)],64)):(u(),d(x,{key:1},[y(a(e.row.stockText),1)],64))]),_:1}),p(m,{label:"实盘数量",width:"160"},{default:f(e=>[e.row.isQuan?(u(),d(x,{key:0},[r("div",null,a(e.row.afterSmall)+a(e.row.smallUnit),1),e.row.hasMiddle?(u(),d("div",on,a(e.row.afterMiddle)+a(e.row.middleUnit),1)):h("",!0),e.row.hasBig?(u(),d("div",ln,a(e.row.afterBig)+a(e.row.bigUnit),1)):h("",!0)],64)):(u(),d(x,{key:1},[y(a(e.row.realText),1)],64))]),_:1}),p(m,{label:"差异",width:"120"},{default:f(e=>[e.row.isQuan?(u(),d(x,{key:0},[r("div",null,a(e.row.diffSmall),1),e.row.hasMiddle?(u(),d("div",an,a(e.row.diffMiddle),1)):h("",!0),e.row.hasBig?(u(),d("div",cn,a(e.row.diffBig),1)):h("",!0)],64)):(u(),d(x,{key:1},[y(a(e.row.diffText),1)],64))]),_:1})]),_:1},8,["data"]),r("div",un,[r("span",mn,"盘点盈利："+a(F.value),1),r("span",_n,"盘点亏损："+a(I.value),1),r("div",null,[M.value===1?(u(),X(t,{key:0,type:"primary",class:"mr10",onClick:Ne,disabled:T.value.length===0},{default:f(()=>s[9]||(s[9]=[y("合并盘点")])),_:1},8,["disabled"])):Z.value===1?(u(),X(t,{key:1,type:"success",class:"mr10",onClick:xe},{default:f(()=>s[10]||(s[10]=[y("完成盘点")])),_:1})):h("",!0),p(t,{class:"mr10",onClick:Be,disabled:Z.value!=1||M.value!=1},{default:f(()=>s[11]||(s[11]=[y("作废盘点")])),_:1},8,["disabled"]),p(t,{onClick:ie},{default:f(()=>s[12]||(s[12]=[y("返回列表")])),_:1})])])])])]),_:1})])}}}),gn=Ie(dn,[["__scopeId","data-v-9f1e8119"]]);export{gn as default};
