import{d as x,l as $,r as C,m as P,w as j,a as _,z as q,j as Q,b as K,h as c,e as o,t as w,p as E,B as Y,g as a,I as G,k as V,A as H,_ as A,c as J}from"./index-BUVdxLJQ.js";const W={class:"drawer-content"},X={class:"product-info-section"},Z={class:"info-header"},ee={class:"info-item"},te={class:"value"},oe={class:"info-item"},ae={class:"value"},le={class:"stock-formula"},ne={class:"formula-value"},se={class:"formula-value"},re={class:"formula-value"},de={class:"flow-list-section"},ie={class:"search-form"},ue=x({__name:"InventoryFlowDetailDrawer",props:{modelValue:{type:Boolean},goodsId:{},warehouseId:{},productInfo:{}},emits:["update:modelValue"],setup(U,{emit:N}){const i=U,M=N,I=$({get:()=>i.modelValue,set:t=>M("update:modelValue",t)}),D=C(!1),S=C([]),F=C(0),m=P({page:1,limit:15}),l=P({stock_type:"",document_no:""}),f=$(()=>{if(!i.productInfo)return 0;const t=Number(i.productInfo.opening_stock)||0,e=Number(i.productInfo.total_in)||0,p=Number(i.productInfo.total_out)||0;return t+e-p}),u=t=>{const e=(t.change_type_name||"").toString(),p=Number(t.change_stock)||0;return e.includes("期初")?0:(e.includes("入库")||e.includes("退货")||e.includes("盘盈"))&&p>0?p:0},b=t=>{const e=(t.change_type_name||"").toString(),p=Number(t.change_stock)||0;return e.includes("期初")?0:e.includes("出库")||e.includes("销售")||e.includes("盘亏")?Math.abs(p):0},s=async()=>{var t,e,p,B,k,z;if(!(!i.goodsId||!i.warehouseId)){D.value=!0;try{const v={goods_id:i.goodsId,warehouse_id:i.warehouseId,page:m.page,limit:m.limit};l.stock_type&&(v.stock_type=l.stock_type),l.document_no&&(v.document_no=l.document_no);const n=await H.inventoryFlowDetail(v);S.value=((e=(t=n==null?void 0:n.data)==null?void 0:t.list)==null?void 0:e.data)||((p=n==null?void 0:n.data)==null?void 0:p.data)||(n==null?void 0:n.data)||[],F.value=((k=(B=n==null?void 0:n.data)==null?void 0:B.list)==null?void 0:k.total)||(n==null?void 0:n.total)||((z=n==null?void 0:n.data)==null?void 0:z.total)||0}catch(v){console.error("获取库存流水明细失败:",v)}finally{D.value=!1}}},r=()=>{m.page=1,s()},y=()=>{l.stock_type="",l.document_no="",m.page=1,s()},g=()=>{I.value=!1,S.value=[],F.value=0,m.page=1,y()};return j(I,t=>{t&&i.goodsId&&i.warehouseId&&s()}),(t,e)=>{const p=_("el-option"),B=_("el-select"),k=_("el-form-item"),z=_("el-input"),v=_("el-button"),n=_("el-form"),h=_("el-table-column"),L=_("el-table"),O=_("el-pagination"),R=_("el-drawer"),T=q("loading");return K(),Q(R,{modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=d=>I.value=d),title:"库存流水明细",size:"80%","before-close":g},{default:c(()=>[o("div",W,[o("div",X,[o("div",Z,[o("div",ee,[e[4]||(e[4]=o("span",{class:"label"},"商品名：",-1)),o("span",te,w(t.productInfo.goods_name||"--"),1)]),o("div",oe,[e[5]||(e[5]=o("span",{class:"label"},"仓库：",-1)),o("span",ae,w(t.productInfo.warehouse_name||"--"),1)])]),o("div",le,[e[6]||(e[6]=o("span",{class:"formula-label"},"可用库存量",-1)),o("span",{class:E(["formula-value",{negative:f.value<0}])},w(f.value),3),e[7]||(e[7]=o("span",{class:"formula-operator"},"=",-1)),e[8]||(e[8]=o("span",{class:"formula-label"},"期初库存",-1)),o("span",ne,w(t.productInfo.opening_stock||0),1),e[9]||(e[9]=o("span",{class:"formula-operator"},"+",-1)),e[10]||(e[10]=o("span",{class:"formula-label"},"入库量",-1)),o("span",se,w(t.productInfo.total_in||0),1),e[11]||(e[11]=o("span",{class:"formula-operator"},"-",-1)),e[12]||(e[12]=o("span",{class:"formula-label"},"出库量",-1)),o("span",re,w(t.productInfo.total_out||0),1)])]),o("div",de,[e[15]||(e[15]=o("div",{class:"section-header"},[o("span",null,"库存流水明细")],-1)),o("div",ie,[a(n,{inline:!0,model:l},{default:c(()=>[a(k,{label:"库存类型"},{default:c(()=>[a(B,{modelValue:l.stock_type,"onUpdate:modelValue":e[0]||(e[0]=d=>l.stock_type=d),placeholder:"请选择",clearable:"",style:{width:"150px"}},{default:c(()=>[a(p,{label:"全部",value:""}),a(p,{label:"入库",value:"in"}),a(p,{label:"出库",value:"out"})]),_:1},8,["modelValue"])]),_:1}),a(k,{label:"单据编号"},{default:c(()=>[a(z,{modelValue:l.document_no,"onUpdate:modelValue":e[1]||(e[1]=d=>l.document_no=d),placeholder:"请输入单据编号",clearable:"",style:{width:"200px"},onKeyup:G(r,["enter"])},null,8,["modelValue"])]),_:1}),a(k,null,{default:c(()=>[a(v,{type:"primary",onClick:r},{default:c(()=>e[13]||(e[13]=[V("查询")])),_:1}),a(v,{onClick:y},{default:c(()=>e[14]||(e[14]=[V("重置")])),_:1})]),_:1})]),_:1},8,["model"])]),Y((K(),Q(L,{data:S.value,border:"",stripe:"",style:{width:"100%"}},{default:c(()=>[a(h,{prop:"business_date",label:"业务日期",width:"150"}),a(h,{label:"出入库单号",width:"150"},{default:c(({row:d})=>[V(w(d.document_code||d.document_no||"--"),1)]),_:1}),a(h,{prop:"warehouse_name",label:"仓库",width:"120"}),a(h,{prop:"document_type",label:"单据类型",width:"120"}),a(h,{label:"单据编号",width:"150"},{default:c(({row:d})=>[V(w(d.document_code||d.document_no||"--"),1)]),_:1}),a(h,{prop:"contact_unit",label:"往来单位",width:"150"}),a(h,{prop:"opening_stock",label:"期初数量",width:"100"}),a(h,{prop:"opening_quantity",label:"当前库存",width:"100"}),a(h,{label:"入库量",width:"100"},{default:c(({row:d})=>[V(w(u(d)),1)]),_:1}),a(h,{label:"出库量",width:"100"},{default:c(({row:d})=>[V(w(b(d)),1)]),_:1})]),_:1},8,["data"])),[[T,D.value]]),a(O,{class:"mt10",background:"",layout:"prev, pager, next, jumper, total","current-page":m.page,"onUpdate:currentPage":e[2]||(e[2]=d=>m.page=d),"page-size":m.limit,total:F.value,onCurrentChange:s},null,8,["current-page","page-size","total"])])])]),_:1},8,["modelValue"])}}}),pe=A(ue,[["__scopeId","data-v-74923df5"]]),ce={class:""},_e=x({__name:"Index",setup(U){const N=C(!1),i=C(null),M=()=>{const l=new Date,f=new Date(l);f.setMonth(l.getMonth()-1);const u=b=>{const s=b.getFullYear(),r=String(b.getMonth()+1).padStart(2,"0"),y=String(b.getDate()).padStart(2,"0");return`${s}-${r}-${y}`};return{start_time:u(f),end_time:u(l)}},I={url:"inventoryFlow/query"},D=()=>({columns:l,data:f})=>{const u=[],b=l.findIndex(s=>s.property==="opening_stock");return l.forEach((s,r)=>{if(!s.property||s.label==="操作"){r===0?u[r]="合计":u[r]="";return}if(r<b)r===0?u[r]="合计":u[r]="";else{const y=f.map(g=>{const t=g[s.property];if(typeof t=="string"){const e=parseFloat(t);return isNaN(e)?0:e}return Number(t)||0});if(y.every(g=>isNaN(g)))u[r]="";else{const g=y.reduce((t,e)=>t+e,0);s.property==="inventory_amount"||s.property==="cost_price"?u[r]=g.toFixed(2):u[r]=g%1===0?g.toString():g.toFixed(2)}}}),u},S=[{label:"商品编号",props:"goods_number",width:120},{label:"商品名称",props:"goods_name",width:150},{label:"规格",props:"spec_name",width:100},{label:"仓库",props:"warehouse_name",width:120},{label:"期初库存",props:"opening_stock",width:100},{label:"采购单",props:"purchase_in",width:100},{label:"销售退货",props:"sales_return_in",width:100},{label:"其他入库",props:"other_in",width:100},{label:"调拨入库",props:"transfer_in",width:100},{label:"盘盈",props:"profit_in",width:100},{label:"入库合计",props:"total_in",width:100},{label:"销售单",props:"sales_out",width:100},{label:"采购退货",props:"purchase_return_out",width:100},{label:"其他出库",props:"other_out",width:100},{label:"调拨出库",props:"transfer_out",width:100},{label:"盘亏",props:"loss_out",width:100},{label:"出库合计",props:"total_out",width:100},{label:"可用库存",props:"available_stock",width:100},{label:"成本价",props:"cost_price",width:100},{label:"库存总额",props:"inventory_amount",width:100}],F=[{label:"开始日期",field:"start_time",type:"date",defaultValue:M().start_time},{label:"结束日期",field:"end_time",type:"date",defaultValue:M().end_time},{label:"仓库",field:"warehouse_id",type:"select",url:"warehouse",text:"name",value:"id"},{label:"商品分类",field:"cate_id",type:"tree-select",url:"goods_cate",text:"name",value:"id",treeKey:"id",treeParentKey:"p_id",treeChildrenKey:"children"},{label:"商品编号/名称/条码/规格",field:"goods_keyword",type:"input"}],m=[{label:"库存流水",type:"primary",handler:l=>{i.value=l,N.value=!0}}];return(l,f)=>{var b,s;const u=_("Page");return K(),J("div",ce,[a(u,{list:I,columns:S,print:!0,searchFields:F,customOperationButtons:m,edit:{},del:{},showSummary:!0,summaryMethod:D()},null,8,["summaryMethod"]),a(pe,{modelValue:N.value,"onUpdate:modelValue":f[0]||(f[0]=r=>N.value=r),"goods-id":(b=i.value)==null?void 0:b.goods_id,"warehouse-id":(s=i.value)==null?void 0:s.warehouse_id,"product-info":i.value},null,8,["modelValue","goods-id","warehouse-id","product-info"])])}}}),fe=A(_e,[["__scopeId","data-v-5e8e45cd"]]);export{fe as default};
